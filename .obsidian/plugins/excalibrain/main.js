"use strict";var e,t,i=require("obsidian");!function(e){e[e.DEFINED=1]="DEFINED",e[e.INFERRED=2]="INFERRED"}(e||(e={})),function(e){e[e.PARENT=0]="PARENT",e[e.CHILD=1]="CHILD",e[e.FRIEND=2]="FRIEND"}(t||(t={}));const n={target:null,isParent:!1,isChild:!1,isFriend:!1},s=t=>({pi:t.isParent&&t.parentType===e.INFERRED,pd:t.isParent&&t.parentType===e.DEFINED,ci:t.isChild&&t.childType===e.INFERRED,cd:t.isChild&&t.childType===e.DEFINED,fd:t.isFriend}),a=(e,t)=>e&&t?e+", "+t:e||t,r=(t,i)=>t===e.DEFINED?e.DEFINED:t===e.INFERRED?i===e.DEFINED?e.DEFINED:e.INFERRED:i;class o{constructor(t,i,n){this.isChild=t=>{const{pi:i,pd:n,ci:a,cd:r,fd:o}=s(t);return!r||n||o?i||n||!a||r||o?null:e.INFERRED:e.DEFINED},this.path=t,this.file=i,this.mtime=i?i.stat.mtime:null,this.neighbours=new Map,this.plugin=n,this.settings=n.settings}getNeighbours(){const{showVirtualNodes:e,showAttachments:t,showInferredNodes:i}=this.settings;return Array.from(this.neighbours).filter((i=>(e||!i[1].target.isVirtual)&&(t||!i[1].target.isAttachment)))}get isVirtual(){return null===this.file}get isAttachment(){return!!this.file&&"md"!==this.file.extension}get isMarkdown(){var e;return"md"===(null===(e=this.file)||void 0===e?void 0:e.extension)||!this.file}addParent(e,t,i){if(e.path===this.plugin.settings.excalibrainFilepath)return;const s=this.neighbours.get(e.path);if(s)return s.isParent=!0,s.parentType=r(s.parentType,t),void(s.parentTypeDefinition=a(i,s.parentTypeDefinition));this.neighbours.set(e.path,Object.assign(Object.assign({},n),{target:e,isParent:!0,parentType:t,parentTypeDefinition:i}))}addChild(e,t,i){if(e.path===this.plugin.settings.excalibrainFilepath)return;const s=this.neighbours.get(e.path);if(s)return s.isChild=!0,s.childType=r(s.childType,t),void(s.childTypeDefinition=a(i,s.childTypeDefinition));this.neighbours.set(e.path,Object.assign(Object.assign({},n),{target:e,isChild:!0,childType:t,childTypeDefinition:i}))}addFriend(e,t,i){if(e.path===this.plugin.settings.excalibrainFilepath)return;const s=this.neighbours.get(e.path);if(s)return s.isFriend=!0,s.friendType=r(s.friendType,t),void(s.friendTypeDefinition=a(i,s.friendTypeDefinition));this.neighbours.set(e.path,Object.assign(Object.assign({},n),{target:e,isFriend:!0,friendType:t,friendTypeDefinition:i}))}unlinkNeighbour(e){this.neighbours.delete(e)}hasChildren(){return this.getNeighbours().some((t=>{const i=this.isChild(t[1]);return i&&this.settings.showInferredNodes||i===e.DEFINED}))}getChildren(){return this.getNeighbours().filter((t=>{const i=this.isChild(t[1]);return i&&this.settings.showInferredNodes||i===e.DEFINED})).map((e=>({page:e[1].target,relationType:e[1].childType,typeDefinition:e[1].childTypeDefinition})))}isParent(t){const{pi:i,pd:n,ci:a,cd:r,fd:o}=s(t);return r||!n||o?!i||n||a||r||o?null:e.INFERRED:e.DEFINED}hasParents(){return this.getNeighbours().some((t=>{const i=this.isParent(t[1]);return i&&this.settings.showInferredNodes||i===e.DEFINED}))}getParents(){return this.getNeighbours().filter((t=>{const i=this.isParent(t[1]);return i&&this.settings.showInferredNodes||i===e.DEFINED})).map((e=>({page:e[1].target,relationType:e[1].parentType,typeDefinition:e[1].parentTypeDefinition})))}isFriend(t){const{pi:i,pd:n,ci:a,cd:r,fd:o}=s(t);return o?e.DEFINED:!i||n||!a||r||o?null:e.INFERRED}hasFriends(){return this.getNeighbours().some((t=>{const i=this.isFriend(t[1]);return i&&this.settings.showInferredNodes||i===e.DEFINED}))}getFriends(){return this.getNeighbours().filter((t=>{const i=this.isFriend(t[1]);return i&&this.settings.showInferredNodes||i===e.DEFINED})).map((t=>{var i;return{page:t[1].target,relationType:(null!==(i=t[1].friendType)&&void 0!==i?i:t[1].parentType===e.DEFINED&&t[1].childType===e.DEFINED)?e.DEFINED:e.INFERRED,typeDefinition:t[1].friendTypeDefinition}}))}getRelationToPage(e){const t=this.neighbours.get(e.path);return t?this.isChild(t)?{type:"child",relationType:t.childType,typeDefinition:t.childTypeDefinition}:this.isParent(t)?{type:"parent",relationType:t.parentType,typeDefinition:t.parentTypeDefinition}:{type:"friend",relationType:t.friendType,typeDefinition:t.friendTypeDefinition}:null}getSiblings(){const t=new Map;return this.getParents().forEach((i=>i.page.getChildren().forEach((i=>{t.has(i.page.path)?i.relationType===e.DEFINED&&(t.get(i.page.path).relationType=e.DEFINED):t.set(i.page.path,i)})))),Array.from(t.values())}}var l={};Object.defineProperty(l,"__esModule",{value:!0});const d=e=>{try{return window.ExcalidrawAutomate.getAPI(e)}catch(e){return console.log({message:"Excalidraw not available",fn:d}),null}};var h=l.getEA=d;const p=e=>{console.error(Object.assign({plugin:"ExcaliBrain"},e))},c=console.log.bind(window.console);console.log.bind(window.console);var g={JSON_MALFORMED:"Malformed JSON",JSON_MISSING_KEYS:'JSON must have these 3 keys: "parents", "children", "friends"',JSON_VALUES_NOT_STRING_ARRAYS:'Key values must be a non-empty array of strings. e.g. "parents": ["Parent", "Parents", "up"]',EXCALIBRAIN_FILE_NAME:"Filepath of Excalibrain drawing",EXCALIBRAIN_FILE_DESC:"âš  This file will be overwritten by the plugin. If you stop the script and make changes to the graph, you should rename the file so your edits are preserved, because the next time you initiate ExcaliBrain your edits will be overwritten by the automatically generated ExcaliBrain graph.",HIERARCHY_HEAD:"Hierarchy",HIERARCHY_DESC:"Enter the Dataview field names separated by comma (,) that you will use to define link directions in your graph.",PARENTS_NAME:"Parents",CHILDREN_NAME:"Children",FRIENDS_NAME:"Friends",DISPLAY_HEAD:"Display",RENDERALIAS_NAME:"Display alias if available",RENDERALIAS_DESC:"Displays the page alias instead of the filename if it is specified in the page's front matter.",SHOWINFERRED_NAME:"Display inferred relationships",SHOWINFERRED_DESC:"<b>Toggle ON</b>: Display both explicitly defined and inferred links. Forward links are children, backlinks are parents, if two page mutually referes to one another then relationship is inferred to be a friendship. Explicitly defined relationships always take priority.<br><b>Toggle OFF</b>: Display only explicitely defined relationships.",SHOWVIRTUAL_NAME:"Display virtual child nodes",SHOWVIRTUAL_DESC:"<b>Toggle ON</b>: Display unresolved links.<br><b>Toggle OFF</b>: Do not display unresolved links.",SHOWATTACHMENTS_NAME:"Include attachments",SHOWATTACHMENTS_DESC:"<b>Toggle ON</b>: Display every type of file on the graph. <br><b>Toggle OFF</b>: Display only markdown files.",STYLE_HEAD:"Styling",STYLE_DESC:"Styles are applied in sequence.<br><ol><li><b>Base</b> node style</li><li><b>Inferred</b> node style (only applied if the node is inferred)</li><li><b>Virtual</b> node style (only applied if the node is virtual)</li> <li><b>Central</b> node style (only applied if the node is in the center)</li><li><b>Sibling</b> node style (only applied if the node is a sibling)</li> <li><b>Attachment</b> node style (only applied if the node is an attachment)</li><li><b>Optional</b> tag based style</li></ol>All the attributes of the base node style must be specified. All other styles may have partial definitions. e.g. You may add a prefix and override the base node-background color in the tag-based style, override the font color in the inferred-node style and set the border stroke style to dotted in the virtual-node style.",CANVAS_BGCOLOR:"Canvas color",TAGLIST_NAME:"Formatted tags",TAGLIST_DESC:"You can specify special formatting rules for Nodes based on tags. If multiple tags are present on the page the first matching a specification will be used. <br>Tagnames should start with <mark>#</mark> and may be incomplete. i.e. <code>#book</code> will match #books, #book/fiction, etc.<br>Enter a comma separated list of tags here, then select from the dropdown list to change the formatting.",MAX_ITEMCOUNT_DESC:"Maximum node count",MAX_ITEMCOUNT_NAME:"Maximum number of nodes to display in a given area of the layout.i.e. the maximum number of parents, the maximum number of children, the maximum number of friends, and the maximum number of siblings to display. If there are more items, they will be ommitted from the drawing.",NODESTYLE_INCLUDE_TOGGLE:"Toggle ON: override base node style for this attribute; OFF: apply base node style for this attribute",NODESTYLE_PREFIX_NAME:"Prefix",NODESTYLE_PREFIX_DESC:"Prefix character or emoji to display in front of the node's label",NODESTYLE_BGCOLOR:"Background color",NODESTYLE_BG_FILLSTYLE:"Bacground fill-style",NODESTYLE_TEXTCOLOR:"Text color",NODESTYLE_BORDERCOLOR:"Border color",NODESTYLE_FONTSIZE:"Font size",NODESTYLE_FONTFAMILY:"Font family",NODESTYLE_MAXLABELLENGTH_NAME:"Max label length",NODESTYLE_MAXLABELLENGTH_DESC:"Maximum number of characters to display from node title. Longer nodes will end with '...'",NODESTYLE_ROUGHNESS:"Stroke roughness",NODESTYLE_SHARPNESS:"Stroke sharpness",NODESTYLE_STROKEWIDTH:"Stroke width",NODESTYLE_STROKESTYLE:"Stroke style",NODESTYLE_RECTANGLEPADDING:"Padding of the node rectangle",NODESTYLE_GATE_RADIUS_NAME:"Gate radius",NODESTYLE_GATE_RADIUS_DESC:"The radius of the 3 small circles (alias: gates) serving as connection points for nodes",NODESTYLE_GATE_OFFSET_NAME:"Gate offset",NODESTYLE_GATE_OFFSET_DESC:"The offset to the left and right of the parent and child gates.",NODESTYLE_GATE_COLOR:"Gate border color",NODESTYLE_GATE_BGCOLOR_NAME:"Gate background color",NODESTYLE_GATE_BGCOLOR_DESC:"The fill color of the gate if it has children",NODESTYLE_GATE_FILLSTYLE:"Gate background fill-style",NODESTYLE_BASE:"Base node style",NODESTYLE_CENTRAL:"Style of central node",NODESTYLE_INFERRED:"Style of inferred nodes",NODESTYLE_VIRTUAL:"Style of virtual nodes",NODESTYLE_SIBLING:"Style of sibling nodes",NODESTYLE_ATTACHMENT:"Style of attachment nodes",DATAVIEW_NOT_FOUND:"Dataview plugin not found. Please install or enable Dataview, then try restarting ExcaliBrain",EXCALIDRAW_NOT_FOUND:"Excalidraw plugin not found. Please install or enable Excalidraw, then try restarting ExcaliBrain",EXCALIDRAW_MINAPP_VERSION:"ExcaliBrain requires Excalidraw 1.6.27 or higher. Please upgrade Excalidraw",COMMAND_START:"Open ExcaliBrain"};const u={en:g}[i.moment.locale()];function f(e){return u||p({fn:f,where:"src/lang/helpers.ts",message:"Error: locale not found",data:i.moment.locale()}),u&&u[e]||g[e]}class m extends i.Modal{constructor(e,t,i){super(e),this.title=t,this.message=i}onOpen(){this.createForm()}onClose(){}createForm(){this.titleEl.setText(this.title),this.contentEl.createDiv({cls:"excalibrain-prompt-center",text:this.message}),this.contentEl.createDiv({cls:"excalibrain-prompt-center"},(e=>{e.style.textAlign="right",e.createEl("button",{text:"Ok"}).onclick=()=>{this.resolve(!0),this.close()},e.createEl("button",{text:"Cancel"}).onclick=()=>{this.resolve(!1),this.close()}}))}show(e){this.resolve=e,this.open()}}class y{constructor(e){this.style={},this.center={x:0,y:0},this.page=e.page,this.settings=e.page.plugin.settings,this.ea=e.page.plugin.EA,this.style=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isInferred?this.settings.inferredNodeStyle:{}),e.page.isVirtual?this.settings.virtualNodeStyle:{}),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),e.page.isAttachment?this.settings.attachmentNodeStyle:{}),this.getTagStyle()),this.friendGateOnLeft=e.friendGateOnLeft,this.title=this.getTitle()}getTitle(){var e,t,i,n;const s=this.page.file&&this.settings.renderAlias&&null!==(n=null===(i=null===(t=null===(e=this.page.dvPage)||void 0===e?void 0:e.file)||void 0===t?void 0:t.aliases)||void 0===i?void 0:i.values)&&void 0!==n?n:[];return s.length>0?s[0]:this.page.file?"md"===this.page.file.extension?this.page.file.basename:this.page.file.name:(e=>{const t=e.endsWith(".md"),i=e.substring(e.lastIndexOf("/")+1);return t?i.slice(0,-3):i})(this.page.path)}displayText(){var e;const t=(null!==(e=this.style.prefix)&&void 0!==e?e:"")+this.title;return t.length>this.style.maxLabelLength?t.substring(0,this.style.maxLabelLength-1)+"...":t}setCenter(e){this.center=e}getTagStyle(){var e,t,i,n;const s=(null!==(n=null===(i=null===(t=null===(e=this.page.dvPage)||void 0===e?void 0:e.file)||void 0===t?void 0:t.tags)||void 0===i?void 0:i.values)&&void 0!==n?n:[]).filter((e=>this.settings.tagStyleList.some((t=>e.startsWith(t)))))[0];return s?this.settings.tagNodeStyles[this.settings.tagStyleList.filter((e=>s.startsWith(e)))[0]]:{}}render(){var e,t;const i=this.ea,n=this.displayText();i.style.fontSize=this.style.fontSize,i.style.fontFamily=this.style.fontFamily;const s=i.measureText(n);i.style.fillStyle=this.style.fillStyle,i.style.roughness=this.style.roughness,i.style.strokeSharpness=this.style.strokeShaprness,i.style.strokeWidth=this.style.strokeWidth,i.style.strokeColor=this.style.textColor,i.style.backgroundColor="transparent",this.id=i.addText(this.center.x-s.width/2,this.center.y-s.height/2,n,{wrapAt:this.style.maxLabelLength+5,textAlign:"center",box:!0,boxPadding:this.style.padding});const a=i.getElement(this.id);a.link=`[[${null!==(t=null===(e=this.page.file)||void 0===e?void 0:e.path)&&void 0!==t?t:this.page.path}]]`,a.backgroundColor=this.style.backgroundColor,a.strokeColor=this.style.borderColor,a.strokeStyle=this.style.strokeStyle,i.style.fillStyle=this.style.gateFillStyle,i.style.strokeColor=this.style.gateStrokeColor,i.style.backgroundColor=this.page.hasFriends()?this.style.gateBackgroundColor:"transparent",this.friendGateId=i.addEllipse(this.friendGateOnLeft?this.center.x-2*this.style.gateRadius-this.style.padding-s.width/2:this.center.x+this.style.padding+s.width/2,this.center.y-this.style.gateRadius,2*this.style.gateRadius,2*this.style.gateRadius),i.style.backgroundColor=this.page.hasParents()?this.style.gateBackgroundColor:"transparent",this.parentGateId=i.addEllipse(this.center.x-this.style.gateRadius-this.style.gateOffset,this.center.y-2*this.style.gateRadius-this.style.padding-s.height/2,2*this.style.gateRadius,2*this.style.gateRadius),i.style.backgroundColor=this.page.hasChildren()?this.style.gateBackgroundColor:"transparent",this.childGateId=i.addEllipse(this.center.x-this.style.gateRadius+this.style.gateOffset,this.center.y+this.style.padding+s.height/2,2*this.style.gateRadius,2*this.style.gateRadius),i.addToGroup([this.friendGateId,this.parentGateId,this.childGateId,this.id,a.boundElements[0].id])}}const E={excalibrainFilepath:"excalibrain.md",hierarchy:{parents:["Parent","Parents","up","u"],children:["Children","Child","down","d"],friends:["Friends","Friend","Jump","Jumps","j"]},renderAlias:!0,backgroundColor:"#0c3e6aff",showInferredNodes:!0,showAttachments:!0,showVirtualNodes:!0,maxItemCount:30,baseNodeStyle:{prefix:"",backgroundColor:"#00000066",fillStyle:"solid",textColor:"#ffffffff",borderColor:"#00000000",fontSize:20,fontFamily:3,maxLabelLength:30,roughness:0,strokeShaprness:"round",strokeWidth:1,strokeStyle:"solid",padding:10,gateRadius:5,gateOffset:15,gateStrokeColor:"#ffffffff",gateBackgroundColor:"#ffffffff",gateFillStyle:"solid"},centralNodeStyle:{fontSize:30,backgroundColor:"#C49A13FF",textColor:"#000000ff"},inferredNodeStyle:{backgroundColor:"#000005b3",textColor:"#95c7f3ff"},virtualNodeStyle:{backgroundColor:"#ff000066",fillStyle:"hachure",textColor:"#ffffffff"},siblingNodeStyle:{fontSize:15},attachmentNodeStyle:{prefix:"ðŸ“Ž "},tagNodeStyles:{},tagStyleList:[],baseLinkStyle:{strokeColor:"#696969FF",strokeWidth:1,strokeStyle:"solid",roughness:0,startArrowHead:null,endArrowHead:null},inferredLinkStyle:{},hierarchyLinkStyle:{},hierarchyStyleList:[]},v="excalibrain-settings-disabled",b=e=>(255*e|256).toString(16).slice(1),w=e=>createFragment((t=>t.createDiv().innerHTML=e)),S=e=>{const t=document.getElementById(e);if(!t)return;const i=t.parentNode;i&&i.removeChild(t)};class D extends i.PluginSettingTab{constructor(e,t){super(e,t),this.dirty=!1,this.plugin=t}async updateDemoImg(){this.ea.reset(),this.ea.canvas.viewBackgroundColor=this.plugin.settings.backgroundColor,this.demoNode.style=Object.assign(Object.assign({},this.demoNodeStyle.getInheritedStyle()),this.demoNodeStyle.style),this.demoNode.render();const e=await this.ea.createSVG(null,!0,{withBackground:!0,withTheme:!1},null,"",40);e.removeAttribute("width"),e.removeAttribute("height"),this.demoImg.setAttribute("src",(e=>`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(e.replaceAll("&nbsp;"," "))))}`)(e.outerHTML))}async hide(){var e;this.dirty&&(this.plugin.settings.tagStyleList=Object.keys(this.plugin.settings.tagNodeStyles),this.plugin.saveSettings(),null===(e=this.plugin.scene)||void 0===e||e.reRender())}colorpicker(e,t,n,s,a,r,o,l,d=""){let h,p,c,g,u,m;const y=new i.Setting(e).setName(t);n&&y.setDesc(w(n));const E=e=>{e?y.settingEl.addClass(v):y.settingEl.removeClass(v),p.disabled=e,p.style.opacity=e?"0.3":"1",h.setDisabled(e),h.sliderEl.style.opacity=e?"0.3":"1",g.style.opacity=e?"0.3":"1",u.style.opacity=e?"0.3":"1",m.style.opacity=e?"0.3":"1"};o&&y.addToggle((e=>{c=e,c.toggleEl.style.marginRight="5px",e.setValue(void 0!==s()).setTooltip(f("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return E(!0),void r();a(p.value+b(h.getValue())),E(!1)}))})),g=createEl("span",{text:"color:"}),g.style.paddingRight="5px",y.controlEl.appendChild(g),p=createEl("input",{type:"color"},(e=>{var t;e.value=(null!==(t=s())&&void 0!==t?t:l).substring(0,7),e.onchange=()=>{a(e.value+b(h.getValue()))}})),y.controlEl.appendChild(p),u=createEl("span",{text:"opacity:"}),u.style.paddingLeft="10px",u.style.paddingRight="5px",y.controlEl.appendChild(u),y.addSlider((e=>{var t,i;h=e,e.setLimits(0,1,.1).setValue((i=null!==(t=s())&&void 0!==t?t:l,parseInt(i.substring(7,9),16)/255)).onChange((e=>{a(p.value+b(e)),m.innerText=` ${e.toString()}`,p.style.opacity=e.toString()}))})),m=createDiv("",(e=>{e.style.minWidth="2em",e.style.textAlign="right",e.innerText=` ${h.getValue().toString()}`})),y.controlEl.appendChild(m),p.style.opacity=h.getValue().toString(),E(o&&!c.getValue())}numberslider(e,t,n,s,a,r,o,l,d,h=""){let p,c,g;const u=new i.Setting(e).setName(t),m=e=>{e?u.settingEl.addClass(v):u.settingEl.removeClass(v),g.setDisabled(e),g.sliderEl.style.opacity=e?"0.3":"1",p.style.opacity=e?"0.3":"1"};l&&u.addToggle((e=>{c=e,c.toggleEl.style.marginRight="5px",e.setValue(void 0!==a()).setTooltip(f("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return m(!0),void o();r(g.getValue()),m(!1)}))})),u.addSlider((e=>{var t;g=e,e.setLimits(s.min,s.max,s.step).setValue(null!==(t=a())&&void 0!==t?t:d).onChange((async e=>{p.innerText=` ${e.toString()}`,r(e),this.dirty=!0}))})),n&&u.setDesc(w(n)),u.settingEl.createDiv("",(e=>{p=e,e.style.minWidth="2.3em",e.style.textAlign="right",e.innerText=` ${g.getValue().toString()}`})),m(l&&!c.getValue())}dropdownpicker(e,t,n,s,a,r,o,l,d,h=""){let p,c;const g=new i.Setting(e).setName(t),u=e=>{e?g.settingEl.addClass(v):g.settingEl.removeClass(v),p.setDisabled(e),p.selectEl.style.opacity=e?"0.3":"1"};l&&g.addToggle((e=>{c=e,c.toggleEl.style.marginRight="5px",e.setValue(void 0!==a()).setTooltip(f("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return u(!0),void o();r(p.getValue()),u(!1)}))})),g.addDropdown((e=>{var t;p=e,e.addOptions(s).setValue(null!==(t=a())&&void 0!==t?t:d).onChange((e=>{r(e),this.dirty=!0}))})),n&&g.setDesc(w(n)),u(l&&!c.getValue())}nodeSettings(e,t,n,s=!0,a){let r,o;const l=new i.Setting(e).setName(f("NODESTYLE_PREFIX_NAME")).setDesc(w(f("NODESTYLE_PREFIX_DESC"))),d=e=>{e?l.settingEl.addClass(v):l.settingEl.removeClass(v),r.setDisabled(e),r.inputEl.style.opacity=e?"0.3":"1"};s&&l.addToggle((e=>{o=e,o.toggleEl.style.marginRight="5px",e.setValue(void 0!==n.prefix).setTooltip(f("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return d(!0),n.prefix=void 0,void this.updateDemoImg();d(!1)}))})),l.addText((e=>{var t;r=e,e.setValue(null!==(t=n.prefix)&&void 0!==t?t:a.prefix).onChange((e=>{n.prefix=e,this.updateDemoImg(),this.dirty=!0}))})),d(s&&!o.getValue()),this.colorpicker(e,f("NODESTYLE_BGCOLOR"),null,(()=>n.backgroundColor),(e=>{n.backgroundColor=e,this.updateDemoImg()}),(()=>{delete n.backgroundColor,this.updateDemoImg()}),s,a.backgroundColor,t),this.dropdownpicker(e,f("NODESTYLE_BG_FILLSTYLE"),null,{hachure:"Hachure","cross-hatch":"Cross-hatch",solid:"Solid"},(()=>{var e;return null===(e=n.fillStyle)||void 0===e?void 0:e.toString()}),(e=>{n.fillStyle=e,this.updateDemoImg()}),(()=>{delete n.fillStyle,this.updateDemoImg()}),s,a.fillStyle.toString(),t),this.colorpicker(e,f("NODESTYLE_TEXTCOLOR"),null,(()=>n.textColor),(e=>{n.textColor=e,this.updateDemoImg()}),(()=>{delete n.textColor,this.updateDemoImg()}),s,a.textColor,t),this.colorpicker(e,f("NODESTYLE_BORDERCOLOR"),null,(()=>n.borderColor),(e=>{n.borderColor=e,this.updateDemoImg()}),(()=>{delete n.borderColor,this.updateDemoImg()}),s,a.borderColor,t),this.numberslider(e,f("NODESTYLE_FONTSIZE"),null,{min:10,max:50,step:5},(()=>n.fontSize),(e=>{n.fontSize=e,this.updateDemoImg()}),(()=>{delete n.fontSize,this.updateDemoImg()}),s,a.fontSize,t),this.dropdownpicker(e,f("NODESTYLE_FONTFAMILY"),null,{1:"Hand-drawn",2:"Normal",3:"Code",4:"Fourth (custom) Font"},(()=>{var e;return null===(e=n.fontFamily)||void 0===e?void 0:e.toString()}),(e=>{n.fontFamily=parseInt(e),this.updateDemoImg()}),(()=>{delete n.fontFamily,this.updateDemoImg()}),s,a.fontFamily.toString(),t),this.numberslider(e,f("NODESTYLE_MAXLABELLENGTH_NAME"),f("NODESTYLE_MAXLABELLENGTH_DESC"),{min:15,max:100,step:5},(()=>n.maxLabelLength),(e=>{n.maxLabelLength=e,this.updateDemoImg()}),(()=>{delete n.maxLabelLength,this.updateDemoImg()}),s,a.maxLabelLength,t),this.dropdownpicker(e,f("NODESTYLE_ROUGHNESS"),null,{0:"Architect",1:"Artist",2:"Cartoonist"},(()=>{var e;return null===(e=n.roughness)||void 0===e?void 0:e.toString()}),(e=>{n.roughness=parseInt(e),this.updateDemoImg()}),(()=>{delete n.roughness,this.updateDemoImg()}),s,a.toString(),t),this.dropdownpicker(e,f("NODESTYLE_SHARPNESS"),null,{sharp:"Sharp",round:"Round"},(()=>n.strokeShaprness),(e=>{n.strokeShaprness=e,this.updateDemoImg()}),(()=>{delete n.strokeShaprness,this.updateDemoImg()}),s,a.strokeShaprness,t),this.numberslider(e,f("NODESTYLE_STROKEWIDTH"),null,{min:.5,max:6,step:.5},(()=>n.strokeWidth),(e=>{n.strokeWidth=e,this.updateDemoImg()}),(()=>{delete n.strokeWidth,this.updateDemoImg()}),s,a.strokeWidth,t),this.dropdownpicker(e,f("NODESTYLE_STROKESTYLE"),null,{solid:"Solid",dashed:"Dashed",dotted:"Dotted"},(()=>n.strokeStyle),(e=>{n.strokeStyle=e,this.updateDemoImg()}),(()=>{delete n.strokeStyle,this.updateDemoImg()}),s,a.strokeStyle,t),this.numberslider(e,f("NODESTYLE_RECTANGLEPADDING"),null,{min:5,max:50,step:5},(()=>n.padding),(e=>{n.padding=e,this.updateDemoImg()}),(()=>{delete n.padding,this.updateDemoImg()}),s,a.padding,t),this.numberslider(e,f("NODESTYLE_GATE_RADIUS_NAME"),f("NODESTYLE_GATE_RADIUS_DESC"),{min:3,max:10,step:1},(()=>n.gateRadius),(e=>{n.gateRadius=e,this.updateDemoImg()}),(()=>{delete n.gateRadius,this.updateDemoImg()}),s,a.gateRadius,t),this.numberslider(e,f("NODESTYLE_GATE_OFFSET_NAME"),f("NODESTYLE_GATE_OFFSET_DESC"),{min:0,max:25,step:1},(()=>n.gateOffset),(e=>{n.gateOffset=e,this.updateDemoImg()}),(()=>{delete n.gateOffset,this.updateDemoImg()}),s,a.gateOffset,t),this.colorpicker(e,f("NODESTYLE_GATE_COLOR"),null,(()=>n.gateStrokeColor),(e=>{n.gateStrokeColor=e,this.updateDemoImg()}),(()=>{delete n.gateStrokeColor,this.updateDemoImg()}),s,a.gateStrokeColor,t),this.colorpicker(e,f("NODESTYLE_GATE_BGCOLOR_NAME"),f("NODESTYLE_GATE_BGCOLOR_DESC"),(()=>n.gateBackgroundColor),(e=>{n.gateBackgroundColor=e,this.updateDemoImg()}),(()=>{delete n.gateBackgroundColor,this.updateDemoImg()}),s,a.gateBackgroundColor,t),this.dropdownpicker(e,f("NODESTYLE_GATE_FILLSTYLE"),null,{hachure:"Hachure","cross-hatch":"Cross-hatch",solid:"Solid"},(()=>{var e;return null===(e=n.gateFillStyle)||void 0===e?void 0:e.toString()}),(e=>{n.gateFillStyle=e,this.updateDemoImg()}),(()=>{delete n.gateFillStyle,this.updateDemoImg()}),s,a.gateFillStyle.toString(),t)}async display(){await this.plugin.loadSettings(),this.ea=h();const t=new o("This is a demo node that is 46 characters long",null,this.plugin),n=new o("Dummy child",null,this.plugin);t.addChild(n,e.DEFINED),this.demoNode=new y({page:t,isInferred:!1,isCentral:!1,isSibling:!1,friendGateOnLeft:!1}),this.demoNode.ea=this.ea;const{containerEl:s}=this;this.containerEl.empty();const a=s.createDiv("coffee");let r,l;a.addClass("ex-coffee-div"),a.createEl("a",{href:"https://ko-fi.com/zsolt"}).createEl("img",{attr:{src:"https://cdn.ko-fi.com/cdn/kofi3.png?v=3"}}).height=45,new i.Setting(s).setName(f("EXCALIBRAIN_FILE_NAME")).setDesc(w(f("EXCALIBRAIN_FILE_DESC"))).addText((e=>e.setValue(this.plugin.settings.excalibrainFilepath).onChange((async e=>{this.dirty=!0,e.endsWith(".md")||(e+=".md"),this.app.vault.getAbstractFileByPath(e)?new m(this.app,"âš  File Exists",`${e} already exists in your Vault. Is it ok to overwrite this file?`).show((t=>{t&&(this.plugin.settings.excalibrainFilepath=e,this.dirty=!0)})):(this.plugin.settings.excalibrainFilepath=e,this.dirty=!0)})).inputEl.onblur=()=>{e.setValue(this.plugin.settings.excalibrainFilepath)})),this.containerEl.createEl("h1",{cls:"excalibrain-settings-h1",text:f("HIERARCHY_HEAD")}),this.containerEl.createEl("p",{}).innerHTML=f("HIERARCHY_DESC"),new i.Setting(s).setName(f("PARENTS_NAME")).addText((e=>{e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.parents.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.parents=e.split(",").map((e=>e.trim())),this.dirty=!0}))})),new i.Setting(s).setName(f("CHILDREN_NAME")).addText((e=>{e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.children.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.children=e.split(",").map((e=>e.trim())),this.dirty=!0}))})),new i.Setting(s).setName(f("FRIENDS_NAME")).addText((e=>{e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.friends.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.friends=e.split(",").map((e=>e.trim())),this.dirty=!0}))})),this.containerEl.createEl("h1",{cls:"excalibrain-settings-h1",text:f("DISPLAY_HEAD")}),new i.Setting(s).setName(f("RENDERALIAS_NAME")).setDesc(w(f("RENDERALIAS_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.renderAlias).onChange((e=>{this.plugin.settings.renderAlias=e,this.dirty=!0})))),new i.Setting(s).setName(f("SHOWINFERRED_NAME")).setDesc(w(f("SHOWINFERRED_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showInferredNodes).onChange((e=>{this.plugin.settings.showInferredNodes=e,this.dirty=!0})))),new i.Setting(s).setName(f("SHOWATTACHMENTS_NAME")).setDesc(w(f("SHOWATTACHMENTS_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showAttachments).onChange((e=>{this.plugin.settings.showAttachments=e,this.dirty=!0})))),new i.Setting(s).setName(f("SHOWVIRTUAL_NAME")).setDesc(w(f("SHOWVIRTUAL_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showVirtualNodes).onChange((e=>{this.plugin.settings.showVirtualNodes=e,this.dirty=!0})))),this.numberslider(s,f("MAX_ITEMCOUNT_NAME"),f("MAX_ITEMCOUNT_DESC"),{min:5,max:150,step:5},(()=>this.plugin.settings.maxItemCount),(e=>this.plugin.settings.maxItemCount=e),(()=>{}),!1,30),s.createEl("h1",{cls:"excalibrain-settings-h1",text:f("STYLE_HEAD")}),this.containerEl.createEl("p",{}).innerHTML=f("STYLE_DESC"),this.colorpicker(s,f("CANVAS_BGCOLOR"),null,(()=>this.plugin.settings.backgroundColor),(e=>{this.plugin.settings.backgroundColor=e,this.updateDemoImg()}),(()=>{}),!1,this.plugin.settings.backgroundColor);const d=e=>{l.empty();const t=this.plugin.nodeStyles[e];this.nodeSettings(l,t.display,t.style,t.allowOverride,t.getInheritedStyle()),this.demoNodeStyle=t,this.updateDemoImg()};new i.Setting(s).setName(f("TAGLIST_NAME")).setDesc(f("TAGLIST_DESC")).addTextArea((e=>{e.inputEl.style.height="200px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.tagStyleList.join(", ")).onChange((e=>{const t=this.plugin.settings.tagNodeStyles,i=this.plugin.nodeStyles,n=(e=e.replaceAll("\n"," ")).split(",").map((e=>e.trim()));this.plugin.settings.tagStyleList=n,Object.keys(t).forEach((e=>{n.contains(e)||(delete t[e],delete i[e])})),n.forEach((e=>{Object.keys(t).contains(e)||(t[e]={},i[e]={style:t[e],allowOverride:!0,userStyle:!0,display:e,getInheritedStyle:()=>this.plugin.settings.baseNodeStyle})}));const s=r.getValue();for(let e=r.selectEl.options.length-1;e>=0;e--)r.selectEl.remove(e);Object.entries(i).forEach((e=>{r.addOption(e[0],e[1].display)})),i[s]?r.setValue(s):(r.setValue("base"),d("base")),this.dirty=!0}))})).descEl.style.maxWidth="400px";const p=s.createDiv({cls:"setting-item"}),c=p.createDiv({cls:"setting-item-info"});r=new i.DropdownComponent(c),p.createDiv({text:"Show inherited",cls:"setting-item-name"}).style.marginRight="10px",new i.ToggleComponent(p).setValue(!0).setTooltip("Show/Hide Inherited Properties").onChange((e=>{e?S("excalibrain-hide-disabled"):((e,t)=>{const i=document.createElement("style");i.id="excalibrain-hide-disabled",i.innerHTML=".excalibrain-settings-disabled {display: none;}",document.body.appendChild(i)})()})),Object.entries(this.plugin.nodeStyles).forEach((e=>{r.addOption(e[0],e[1].display)})),this.demoImg=s.createEl("img",{cls:"excalibrain-settings-demoimg"}),l=s.createDiv({cls:"excalibrain-setting-nodestyle-section"}),S("excalibrain-hide-disabled"),r.setValue("base").onChange(d);const g=this.plugin.nodeStyles.base;this.nodeSettings(l,g.display,g.style,g.allowOverride,g.getInheritedStyle()),this.demoNodeStyle=g,this.updateDemoImg()}}var x={};Object.defineProperty(x,"__esModule",{value:!0});var T=x.getAPI=e=>{var t;return e?null===(t=e.plugins.plugins.dataview)||void 0===t?void 0:t.api:window.DataviewAPI};x.isPluginEnabled=e=>e.plugins.enabledPlugins.has("dataview");const N=(e,t,i)=>{const n=e.metadataCache.getFirstLinkpathDest(t,i);return n?n.path:t},O=(e,t,i)=>{const n=[],s=new Set;return i.forEach((i=>{i=i.toLowerCase().replaceAll(" ","-"),t[i]&&!s.has(i)&&(s.add(i),((e,t,i)=>{const n=new Set;if(t.values)return t.values.forEach((t=>{if("file"===t.type){const s=N(e,t.path,i.path);s&&n.add(s)}})),Array.from(n);if(t.path){const n=N(e,t.path,i.path);return n?[n]:[]}const s=t.matchAll(/[^[]*\[\[([^#\]\|]*)[^\]]*]]/g);let a;for(;!(a=s.next()).done;)if(a.value[1]){const t=N(e,a.value[1],i.path);t&&n.add(t)}return Array.from(n)})(e.app,t[i],t.file).forEach((e=>n.push({link:e,field:i}))))})),n};class I{constructor(e){this.pages=new Map,this.forEach=this.pages.forEach.bind(this.pages),this.app=e.app,this.plugin=e}add(e,t){this.pages.set(e,t)}get(e){return this.pages.get(e)}get size(){return this.pages.size}delete(e){const t=this.pages.get(e);t&&(t.neighbours.forEach(((t,i)=>{const n=this.pages.get(i);n&&(n.unlinkNeighbour(e),n.file||0!==n.neighbours.size||this.pages.delete(i))})),this.pages.delete(e))}addWithConnections(t){var i,n;const s=new o(t.path,t,this.plugin);this.add(t.path,s);const a=new Set(Object.keys(null!==(n=null===(i=app.metadataCache.getBacklinksForFile(t))||void 0===i?void 0:i.data)&&void 0!==n?n:{}).map((e=>{var i,n;return null!==(n=null===(i=app.metadataCache.getFirstLinkpathDest(e,t.path))||void 0===i?void 0:i.path)&&void 0!==n?n:e})));a.forEach((t=>{const i=this.pages.get(t);t?(i.addChild(s,e.INFERRED),s.addParent(i,e.INFERRED)):c(`Unexpected: ${s.file.path} is referenced from ${t} as backlink in metadataCache, but page for ${t} has not yet been registered in ExcaliBrain index.`)})),this.addUnresolvedLinks(s),this.addResolvedLinks(s),this.addDVFieldLinksToPage(s)}addResolvedLinks(t){const i=this.app.metadataCache.resolvedLinks;Object.keys(i).forEach((n=>{t&&t.path!==n||Object.keys(i[n]).forEach((t=>{const i=this.pages.get(t),s=this.pages.get(n);i.addParent(s,e.INFERRED),s.addChild(i,e.INFERRED)}))}))}addUnresolvedLinks(t){const i=this.app.metadataCache.unresolvedLinks;Object.keys(i).forEach((n=>{t&&t.path!==n||Object.keys(i[n]).forEach((t=>{const i=new o(t,null,this.plugin),s=this.pages.get(n);i.addParent(s,e.INFERRED),s.addChild(i,e.INFERRED),this.add(t,i)}))}))}addDVFieldLinksToPage(t){const i=this.plugin.DVAPI.page(t.file.path);if(!i)return;t.dvPage=i;const n=this.plugin.settings.hierarchy.parents;O(this.plugin,i,n).forEach((i=>{const n=this.pages.get(i.link);n?(t.addParent(n,e.DEFINED,i.field),n.addChild(t,e.DEFINED,i.field)):c(`Unexpected: ${t.file.path} references ${i.link} in DV, but it was not found in app.metadataCache. The page was skipped.`)}));const s=this.plugin.settings.hierarchy.children;O(this.plugin,i,s).forEach((i=>{const n=this.pages.get(i.link);n?(t.addChild(n,e.DEFINED,i.field),n.addParent(t,e.DEFINED,i.field)):c(`Unexpected: ${t.file.path} references ${i.link} in DV, but it was not found in app.metadataCache. The page was skipped.`)}));const a=this.plugin.settings.hierarchy.friends;O(this.plugin,i,a).forEach((i=>{const n=this.pages.get(i.link);n?(t.addFriend(n,e.DEFINED,i.field),n.addFriend(t,e.DEFINED,i.field)):c(`Unexpected: ${t.file.path} references ${i.link} in DV, but it was not found in app.metadataCache. The page was skipped.`)}))}}const C=`---\n\nexcalidraw-plugin: parsed\nexcalidraw-default-mode: view\nexcalidraw-export-dark: false\nexcalidraw-export-transparent: false\nexcalidraw-linkbutton-opacity: 0.3\nexcalidraw-onload-script: "app.plugins.plugins[${String.fromCharCode(96)}excalibrain${String.fromCharCode(96)}].start(ea.targetView.leaf);"\n\ntags: [excalidraw]\n\n---\n\n# Text Elements\nOpen a document in another pane and click it to get started.\n\nFor the best experience enable 'Open in adjacent pane'\nin Excalidraw settings under 'Links and Transclusion'. ^4mylk7KK\n\n%%\n# Drawing\n${String.fromCharCode(96,96,96)}json\n{\n\t"type": "excalidraw",\n\t"version": 2,\n\t"source": "https://excalidraw.com",\n\t"elements": [\n\t\t{\n\t\t\t"type": "text",\n\t\t\t"version": 1,\n\t\t\t"versionNonce": 423577018,\n\t\t\t"isDeleted": false,\n\t\t\t"id": "4mylk7KK",\n\t\t\t"fillStyle": "hachure",\n\t\t\t"strokeWidth": 1,\n\t\t\t"strokeStyle": "solid",\n\t\t\t"roughness": 1,\n\t\t\t"opacity": 100,\n\t\t\t"angle": 0,\n\t\t\t"x": 0,\n\t\t\t"y": 0,\n\t\t\t"strokeColor": "white",\n\t\t\t"backgroundColor": "transparent",\n\t\t\t"width": 703,\n\t\t\t"height": 96,\n\t\t\t"seed": 4429,\n\t\t\t"groupIds": [],\n\t\t\t"strokeSharpness": "sharp",\n\t\t\t"boundElements": [],\n\t\t\t"updated": 1650784785611,\n\t\t\t"link": null,\n\t\t\t"locked": false,\n\t\t\t"fontSize": 20,\n\t\t\t"fontFamily": 3,\n\t\t\t"text": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'.",\n\t\t\t"rawText": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'.",\n\t\t\t"baseline": 91,\n\t\t\t"textAlign": "center",\n\t\t\t"verticalAlign": "top",\n\t\t\t"containerId": null,\n\t\t\t"originalText": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'."\n\t\t}\n\t],\n\t"appState": {\n\t\t"theme": "dark",\n\t\t"viewBackgroundColor": "hsl(208, 80%, 23%)",\n\t\t"currentItemStrokeColor": "#000000",\n\t\t"currentItemBackgroundColor": "transparent",\n\t\t"currentItemFillStyle": "hachure",\n\t\t"currentItemStrokeWidth": 2,\n\t\t"currentItemStrokeStyle": "solid",\n\t\t"currentItemRoughness": 1,\n\t\t"currentItemOpacity": 100,\n\t\t"currentItemFontFamily": 1,\n\t\t"currentItemFontSize": 16,\n\t\t"currentItemTextAlign": "left",\n\t\t"currentItemStrokeSharpness": "sharp",\n\t\t"currentItemStartArrowhead": null,\n\t\t"currentItemEndArrowhead": "arrow",\n\t\t"currentItemLinearStrokeSharpness": "round",\n\t\t"gridSize": null,\n\t\t"colorPalette": {}\n\t},\n\t"files": {}\n}\n${String.fromCharCode(96,96,96)}\n%%\n`;class A{constructor(e){this.nodes=[],this.renderedNodes=[],this.spec=e}layout(e=this.spec.columns){const t=this.nodes.sort(((e,t)=>e.title.toLowerCase()<t.title.toLowerCase()?-1:1)),i=t.length;if(0===i)return;const n=Math.ceil(i/e);this.renderedNodes=Array(n).fill(null).map(((s,a)=>{return a+1<n||i%e==0?Array(e).fill(null).map(((i,n)=>t[a*e+n])):(r=i%e,(e=>{const t=[];let i=1,n=!0;return e.map((e=>Math.floor(e))).forEach((e=>{for(let s=0;s<e;s++)t.push(n?null:i++);n=!n})),t})(r%2?[(e-r)/2,r,(e-r)/2]:[(e-r)/2,r/2,1,r/2,(e-r)/2])).map((i=>i?t[a*e+i-1]:null));var r}))}render(){this.layout();const e=this.renderedNodes.length*this.spec.rowHeight,t=null===this.spec.top&&null===this.spec.bottom?this.spec.origoY-e/2:null!==this.spec.top?this.spec.origoY-e/2<this.spec.top?this.spec.top:this.spec.origoY-e/2:this.spec.origoY+e/2>this.spec.bottom?this.spec.bottom-e:this.spec.origoY-e/2,i=this.spec.origoX-(1===this.spec.columns?0:(this.spec.columns-1)/2*this.spec.columnWidth),n=t;this.renderedNodes.forEach(((e,t)=>e.forEach(((e,s)=>{e&&(e.setCenter({x:i+s*this.spec.columnWidth,y:n+t*this.spec.rowHeight}),e.render())}))))}}class L{constructor(e,t,i,n,s,a,r){this.nodeA=e,this.nodeB=t,this.nodeBRole=i,this.relation=n,this.hierarchyDefinition=s,this.ea=a,this.settings=r,this.style=r.baseLinkStyle}render(){const e=this.ea,i=this.style;let n,s;switch(e.style.strokeStyle=i.strokeStyle,e.style.strokeColor=i.strokeColor,e.style.strokeWidth=i.strokeWidth,this.nodeBRole){case t.CHILD:n=this.nodeA.childGateId,s=this.nodeB.parentGateId;break;case t.PARENT:n=this.nodeA.parentGateId,s=this.nodeB.childGateId;break;default:n=this.nodeA.friendGateId,s=this.nodeB.friendGateId}e.connectObjects(n,null,s,null,{startArrowHead:i.startArrowHead,endArrowHead:i.endArrowHead})}}class k{constructor(){this.links=new Map,this.reverseLinks=new Set}addLink(e,t,i,n,s,a,r){const o=e.page.path+"|:?:|"+t.page.path;if(this.links.has(o)||this.reverseLinks.has(o))return;const l=t.page.path+"|:?:|"+e.page.path,d=new L(e,t,i,n,s,a,r);this.links.set(o,d),this.reverseLinks.add(l)}render(){this.links.forEach((e=>e.render()))}}var F="top",_="bottom",R="right",P="left",V=[F,_,R,P],M=V.reduce((function(e,t){return e.concat([t+"-start",t+"-end"])}),[]),H=[].concat(V,["auto"]).reduce((function(e,t){return e.concat([t,t+"-start",t+"-end"])}),[]),Y=["beforeRead","read","afterRead","beforeMain","main","afterMain","beforeWrite","write","afterWrite"];function B(e){return e?(e.nodeName||"").toLowerCase():null}function G(e){if(null==e)return window;if("[object Window]"!==e.toString()){var t=e.ownerDocument;return t&&t.defaultView||window}return e}function j(e){return e instanceof G(e).Element||e instanceof Element}function W(e){return e instanceof G(e).HTMLElement||e instanceof HTMLElement}function U(e){return"undefined"!=typeof ShadowRoot&&(e instanceof G(e).ShadowRoot||e instanceof ShadowRoot)}var z={name:"applyStyles",enabled:!0,phase:"write",fn:function(e){var t=e.state;Object.keys(t.elements).forEach((function(e){var i=t.styles[e]||{},n=t.attributes[e]||{},s=t.elements[e];W(s)&&B(s)&&(Object.assign(s.style,i),Object.keys(n).forEach((function(e){var t=n[e];!1===t?s.removeAttribute(e):s.setAttribute(e,!0===t?"":t)})))}))},effect:function(e){var t=e.state,i={popper:{position:t.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(t.elements.popper.style,i.popper),t.styles=i,t.elements.arrow&&Object.assign(t.elements.arrow.style,i.arrow),function(){Object.keys(t.elements).forEach((function(e){var n=t.elements[e],s=t.attributes[e]||{},a=Object.keys(t.styles.hasOwnProperty(e)?t.styles[e]:i[e]).reduce((function(e,t){return e[t]="",e}),{});W(n)&&B(n)&&(Object.assign(n.style,a),Object.keys(s).forEach((function(e){n.removeAttribute(e)})))}))}},requires:["computeStyles"]};function X(e){return e.split("-")[0]}var $=Math.max,q=Math.min,K=Math.round;function J(e,t){void 0===t&&(t=!1);var i=e.getBoundingClientRect(),n=1,s=1;if(W(e)&&t){var a=e.offsetHeight,r=e.offsetWidth;r>0&&(n=K(i.width)/r||1),a>0&&(s=K(i.height)/a||1)}return{width:i.width/n,height:i.height/s,top:i.top/s,right:i.right/n,bottom:i.bottom/s,left:i.left/n,x:i.left/n,y:i.top/s}}function Z(e){var t=J(e),i=e.offsetWidth,n=e.offsetHeight;return Math.abs(t.width-i)<=1&&(i=t.width),Math.abs(t.height-n)<=1&&(n=t.height),{x:e.offsetLeft,y:e.offsetTop,width:i,height:n}}function Q(e,t){var i=t.getRootNode&&t.getRootNode();if(e.contains(t))return!0;if(i&&U(i)){var n=t;do{if(n&&e.isSameNode(n))return!0;n=n.parentNode||n.host}while(n)}return!1}function ee(e){return G(e).getComputedStyle(e)}function te(e){return["table","td","th"].indexOf(B(e))>=0}function ie(e){return((j(e)?e.ownerDocument:e.document)||window.document).documentElement}function ne(e){return"html"===B(e)?e:e.assignedSlot||e.parentNode||(U(e)?e.host:null)||ie(e)}function se(e){return W(e)&&"fixed"!==ee(e).position?e.offsetParent:null}function ae(e){for(var t=G(e),i=se(e);i&&te(i)&&"static"===ee(i).position;)i=se(i);return i&&("html"===B(i)||"body"===B(i)&&"static"===ee(i).position)?t:i||function(e){var t=-1!==navigator.userAgent.toLowerCase().indexOf("firefox");if(-1!==navigator.userAgent.indexOf("Trident")&&W(e)&&"fixed"===ee(e).position)return null;var i=ne(e);for(U(i)&&(i=i.host);W(i)&&["html","body"].indexOf(B(i))<0;){var n=ee(i);if("none"!==n.transform||"none"!==n.perspective||"paint"===n.contain||-1!==["transform","perspective"].indexOf(n.willChange)||t&&"filter"===n.willChange||t&&n.filter&&"none"!==n.filter)return i;i=i.parentNode}return null}(e)||t}function re(e){return["top","bottom"].indexOf(e)>=0?"x":"y"}function oe(e,t,i){return $(e,q(t,i))}function le(e){return Object.assign({},{top:0,right:0,bottom:0,left:0},e)}function de(e,t){return t.reduce((function(t,i){return t[i]=e,t}),{})}var he={name:"arrow",enabled:!0,phase:"main",fn:function(e){var t,i=e.state,n=e.name,s=e.options,a=i.elements.arrow,r=i.modifiersData.popperOffsets,o=X(i.placement),l=re(o),d=[P,R].indexOf(o)>=0?"height":"width";if(a&&r){var h=function(e,t){return le("number"!=typeof(e="function"==typeof e?e(Object.assign({},t.rects,{placement:t.placement})):e)?e:de(e,V))}(s.padding,i),p=Z(a),c="y"===l?F:P,g="y"===l?_:R,u=i.rects.reference[d]+i.rects.reference[l]-r[l]-i.rects.popper[d],f=r[l]-i.rects.reference[l],m=ae(a),y=m?"y"===l?m.clientHeight||0:m.clientWidth||0:0,E=u/2-f/2,v=h[c],b=y-p[d]-h[g],w=y/2-p[d]/2+E,S=oe(v,w,b),D=l;i.modifiersData[n]=((t={})[D]=S,t.centerOffset=S-w,t)}},effect:function(e){var t=e.state,i=e.options.element,n=void 0===i?"[data-popper-arrow]":i;null!=n&&("string"!=typeof n||(n=t.elements.popper.querySelector(n)))&&Q(t.elements.popper,n)&&(t.elements.arrow=n)},requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function pe(e){return e.split("-")[1]}var ce={top:"auto",right:"auto",bottom:"auto",left:"auto"};function ge(e){var t,i=e.popper,n=e.popperRect,s=e.placement,a=e.variation,r=e.offsets,o=e.position,l=e.gpuAcceleration,d=e.adaptive,h=e.roundOffsets,p=e.isFixed,c=r.x,g=void 0===c?0:c,u=r.y,f=void 0===u?0:u,m="function"==typeof h?h({x:g,y:f}):{x:g,y:f};g=m.x,f=m.y;var y=r.hasOwnProperty("x"),E=r.hasOwnProperty("y"),v=P,b=F,w=window;if(d){var S=ae(i),D="clientHeight",x="clientWidth";S===G(i)&&"static"!==ee(S=ie(i)).position&&"absolute"===o&&(D="scrollHeight",x="scrollWidth"),S=S,(s===F||(s===P||s===R)&&"end"===a)&&(b=_,f-=(p&&S===w&&w.visualViewport?w.visualViewport.height:S[D])-n.height,f*=l?1:-1),s!==P&&(s!==F&&s!==_||"end"!==a)||(v=R,g-=(p&&S===w&&w.visualViewport?w.visualViewport.width:S[x])-n.width,g*=l?1:-1)}var T,N=Object.assign({position:o},d&&ce),O=!0===h?function(e){var t=e.x,i=e.y,n=window.devicePixelRatio||1;return{x:K(t*n)/n||0,y:K(i*n)/n||0}}({x:g,y:f}):{x:g,y:f};return g=O.x,f=O.y,l?Object.assign({},N,((T={})[b]=E?"0":"",T[v]=y?"0":"",T.transform=(w.devicePixelRatio||1)<=1?"translate("+g+"px, "+f+"px)":"translate3d("+g+"px, "+f+"px, 0)",T)):Object.assign({},N,((t={})[b]=E?f+"px":"",t[v]=y?g+"px":"",t.transform="",t))}var ue={passive:!0},fe={left:"right",right:"left",bottom:"top",top:"bottom"};function me(e){return e.replace(/left|right|bottom|top/g,(function(e){return fe[e]}))}var ye={start:"end",end:"start"};function Ee(e){return e.replace(/start|end/g,(function(e){return ye[e]}))}function ve(e){var t=G(e);return{scrollLeft:t.pageXOffset,scrollTop:t.pageYOffset}}function be(e){return J(ie(e)).left+ve(e).scrollLeft}function we(e){var t=ee(e),i=t.overflow,n=t.overflowX,s=t.overflowY;return/auto|scroll|overlay|hidden/.test(i+s+n)}function Se(e){return["html","body","#document"].indexOf(B(e))>=0?e.ownerDocument.body:W(e)&&we(e)?e:Se(ne(e))}function De(e,t){var i;void 0===t&&(t=[]);var n=Se(e),s=n===(null==(i=e.ownerDocument)?void 0:i.body),a=G(n),r=s?[a].concat(a.visualViewport||[],we(n)?n:[]):n,o=t.concat(r);return s?o:o.concat(De(ne(r)))}function xe(e){return Object.assign({},e,{left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height})}function Te(e,t){return"viewport"===t?xe(function(e){var t=G(e),i=ie(e),n=t.visualViewport,s=i.clientWidth,a=i.clientHeight,r=0,o=0;return n&&(s=n.width,a=n.height,/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(r=n.offsetLeft,o=n.offsetTop)),{width:s,height:a,x:r+be(e),y:o}}(e)):j(t)?function(e){var t=J(e);return t.top=t.top+e.clientTop,t.left=t.left+e.clientLeft,t.bottom=t.top+e.clientHeight,t.right=t.left+e.clientWidth,t.width=e.clientWidth,t.height=e.clientHeight,t.x=t.left,t.y=t.top,t}(t):xe(function(e){var t,i=ie(e),n=ve(e),s=null==(t=e.ownerDocument)?void 0:t.body,a=$(i.scrollWidth,i.clientWidth,s?s.scrollWidth:0,s?s.clientWidth:0),r=$(i.scrollHeight,i.clientHeight,s?s.scrollHeight:0,s?s.clientHeight:0),o=-n.scrollLeft+be(e),l=-n.scrollTop;return"rtl"===ee(s||i).direction&&(o+=$(i.clientWidth,s?s.clientWidth:0)-a),{width:a,height:r,x:o,y:l}}(ie(e)))}function Ne(e){var t,i=e.reference,n=e.element,s=e.placement,a=s?X(s):null,r=s?pe(s):null,o=i.x+i.width/2-n.width/2,l=i.y+i.height/2-n.height/2;switch(a){case F:t={x:o,y:i.y-n.height};break;case _:t={x:o,y:i.y+i.height};break;case R:t={x:i.x+i.width,y:l};break;case P:t={x:i.x-n.width,y:l};break;default:t={x:i.x,y:i.y}}var d=a?re(a):null;if(null!=d){var h="y"===d?"height":"width";switch(r){case"start":t[d]=t[d]-(i[h]/2-n[h]/2);break;case"end":t[d]=t[d]+(i[h]/2-n[h]/2)}}return t}function Oe(e,t){void 0===t&&(t={});var i=t,n=i.placement,s=void 0===n?e.placement:n,a=i.boundary,r=void 0===a?"clippingParents":a,o=i.rootBoundary,l=void 0===o?"viewport":o,d=i.elementContext,h=void 0===d?"popper":d,p=i.altBoundary,c=void 0!==p&&p,g=i.padding,u=void 0===g?0:g,f=le("number"!=typeof u?u:de(u,V)),m="popper"===h?"reference":"popper",y=e.rects.popper,E=e.elements[c?m:h],v=function(e,t,i){var n="clippingParents"===t?function(e){var t=De(ne(e)),i=["absolute","fixed"].indexOf(ee(e).position)>=0&&W(e)?ae(e):e;return j(i)?t.filter((function(e){return j(e)&&Q(e,i)&&"body"!==B(e)})):[]}(e):[].concat(t),s=[].concat(n,[i]),a=s[0],r=s.reduce((function(t,i){var n=Te(e,i);return t.top=$(n.top,t.top),t.right=q(n.right,t.right),t.bottom=q(n.bottom,t.bottom),t.left=$(n.left,t.left),t}),Te(e,a));return r.width=r.right-r.left,r.height=r.bottom-r.top,r.x=r.left,r.y=r.top,r}(j(E)?E:E.contextElement||ie(e.elements.popper),r,l),b=J(e.elements.reference),w=Ne({reference:b,element:y,strategy:"absolute",placement:s}),S=xe(Object.assign({},y,w)),D="popper"===h?S:b,x={top:v.top-D.top+f.top,bottom:D.bottom-v.bottom+f.bottom,left:v.left-D.left+f.left,right:D.right-v.right+f.right},T=e.modifiersData.offset;if("popper"===h&&T){var N=T[s];Object.keys(x).forEach((function(e){var t=[R,_].indexOf(e)>=0?1:-1,i=[F,_].indexOf(e)>=0?"y":"x";x[e]+=N[i]*t}))}return x}function Ie(e,t){void 0===t&&(t={});var i=t,n=i.placement,s=i.boundary,a=i.rootBoundary,r=i.padding,o=i.flipVariations,l=i.allowedAutoPlacements,d=void 0===l?H:l,h=pe(n),p=h?o?M:M.filter((function(e){return pe(e)===h})):V,c=p.filter((function(e){return d.indexOf(e)>=0}));0===c.length&&(c=p);var g=c.reduce((function(t,i){return t[i]=Oe(e,{placement:i,boundary:s,rootBoundary:a,padding:r})[X(i)],t}),{});return Object.keys(g).sort((function(e,t){return g[e]-g[t]}))}var Ce={name:"flip",enabled:!0,phase:"main",fn:function(e){var t=e.state,i=e.options,n=e.name;if(!t.modifiersData[n]._skip){for(var s=i.mainAxis,a=void 0===s||s,r=i.altAxis,o=void 0===r||r,l=i.fallbackPlacements,d=i.padding,h=i.boundary,p=i.rootBoundary,c=i.altBoundary,g=i.flipVariations,u=void 0===g||g,f=i.allowedAutoPlacements,m=t.options.placement,y=X(m),E=l||(y!==m&&u?function(e){if("auto"===X(e))return[];var t=me(e);return[Ee(e),t,Ee(t)]}(m):[me(m)]),v=[m].concat(E).reduce((function(e,i){return e.concat("auto"===X(i)?Ie(t,{placement:i,boundary:h,rootBoundary:p,padding:d,flipVariations:u,allowedAutoPlacements:f}):i)}),[]),b=t.rects.reference,w=t.rects.popper,S=new Map,D=!0,x=v[0],T=0;T<v.length;T++){var N=v[T],O=X(N),I="start"===pe(N),C=[F,_].indexOf(O)>=0,A=C?"width":"height",L=Oe(t,{placement:N,boundary:h,rootBoundary:p,altBoundary:c,padding:d}),k=C?I?R:P:I?_:F;b[A]>w[A]&&(k=me(k));var V=me(k),M=[];if(a&&M.push(L[O]<=0),o&&M.push(L[k]<=0,L[V]<=0),M.every((function(e){return e}))){x=N,D=!1;break}S.set(N,M)}if(D)for(var H=function(e){var t=v.find((function(t){var i=S.get(t);if(i)return i.slice(0,e).every((function(e){return e}))}));if(t)return x=t,"break"},Y=u?3:1;Y>0&&"break"!==H(Y);Y--);t.placement!==x&&(t.modifiersData[n]._skip=!0,t.placement=x,t.reset=!0)}},requiresIfExists:["offset"],data:{_skip:!1}};function Ae(e,t,i){return void 0===i&&(i={x:0,y:0}),{top:e.top-t.height-i.y,right:e.right-t.width+i.x,bottom:e.bottom-t.height+i.y,left:e.left-t.width-i.x}}function Le(e){return[F,R,_,P].some((function(t){return e[t]>=0}))}function ke(e,t,i){void 0===i&&(i=!1);var n,s,a=W(t),r=W(t)&&function(e){var t=e.getBoundingClientRect(),i=K(t.width)/e.offsetWidth||1,n=K(t.height)/e.offsetHeight||1;return 1!==i||1!==n}(t),o=ie(t),l=J(e,r),d={scrollLeft:0,scrollTop:0},h={x:0,y:0};return(a||!a&&!i)&&(("body"!==B(t)||we(o))&&(d=(n=t)!==G(n)&&W(n)?{scrollLeft:(s=n).scrollLeft,scrollTop:s.scrollTop}:ve(n)),W(t)?((h=J(t,!0)).x+=t.clientLeft,h.y+=t.clientTop):o&&(h.x=be(o))),{x:l.left+d.scrollLeft-h.x,y:l.top+d.scrollTop-h.y,width:l.width,height:l.height}}function Fe(e){var t=new Map,i=new Set,n=[];function s(e){i.add(e.name),[].concat(e.requires||[],e.requiresIfExists||[]).forEach((function(e){if(!i.has(e)){var n=t.get(e);n&&s(n)}})),n.push(e)}return e.forEach((function(e){t.set(e.name,e)})),e.forEach((function(e){i.has(e.name)||s(e)})),n}var _e={placement:"bottom",modifiers:[],strategy:"absolute"};function Re(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return!t.some((function(e){return!(e&&"function"==typeof e.getBoundingClientRect)}))}var Ve,Me=function(e){void 0===e&&(e={});var t=e,i=t.defaultModifiers,n=void 0===i?[]:i,s=t.defaultOptions,a=void 0===s?_e:s;return function(e,t,i){void 0===i&&(i=a);var s,r,o={placement:"bottom",orderedModifiers:[],options:Object.assign({},_e,a),modifiersData:{},elements:{reference:e,popper:t},attributes:{},styles:{}},l=[],d=!1,h={state:o,setOptions:function(i){var s="function"==typeof i?i(o.options):i;p(),o.options=Object.assign({},a,o.options,s),o.scrollParents={reference:j(e)?De(e):e.contextElement?De(e.contextElement):[],popper:De(t)};var r,d,c=function(e){var t=Fe(e);return Y.reduce((function(e,i){return e.concat(t.filter((function(e){return e.phase===i})))}),[])}((r=[].concat(n,o.options.modifiers),d=r.reduce((function(e,t){var i=e[t.name];return e[t.name]=i?Object.assign({},i,t,{options:Object.assign({},i.options,t.options),data:Object.assign({},i.data,t.data)}):t,e}),{}),Object.keys(d).map((function(e){return d[e]}))));return o.orderedModifiers=c.filter((function(e){return e.enabled})),o.orderedModifiers.forEach((function(e){var t=e.name,i=e.options,n=void 0===i?{}:i,s=e.effect;if("function"==typeof s){var a=s({state:o,name:t,instance:h,options:n});l.push(a||function(){})}})),h.update()},forceUpdate:function(){if(!d){var e=o.elements,t=e.reference,i=e.popper;if(Re(t,i)){o.rects={reference:ke(t,ae(i),"fixed"===o.options.strategy),popper:Z(i)},o.reset=!1,o.placement=o.options.placement,o.orderedModifiers.forEach((function(e){return o.modifiersData[e.name]=Object.assign({},e.data)}));for(var n=0;n<o.orderedModifiers.length;n++)if(!0!==o.reset){var s=o.orderedModifiers[n],a=s.fn,r=s.options,l=void 0===r?{}:r,p=s.name;"function"==typeof a&&(o=a({state:o,options:l,name:p,instance:h})||o)}else o.reset=!1,n=-1}}},update:(s=function(){return new Promise((function(e){h.forceUpdate(),e(o)}))},function(){return r||(r=new Promise((function(e){Promise.resolve().then((function(){r=void 0,e(s())}))}))),r}),destroy:function(){p(),d=!0}};if(!Re(e,t))return h;function p(){l.forEach((function(e){return e()})),l=[]}return h.setOptions(i).then((function(e){!d&&i.onFirstUpdate&&i.onFirstUpdate(e)})),h}}({defaultModifiers:[{name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect:function(e){var t=e.state,i=e.instance,n=e.options,s=n.scroll,a=void 0===s||s,r=n.resize,o=void 0===r||r,l=G(t.elements.popper),d=[].concat(t.scrollParents.reference,t.scrollParents.popper);return a&&d.forEach((function(e){e.addEventListener("scroll",i.update,ue)})),o&&l.addEventListener("resize",i.update,ue),function(){a&&d.forEach((function(e){e.removeEventListener("scroll",i.update,ue)})),o&&l.removeEventListener("resize",i.update,ue)}},data:{}},{name:"popperOffsets",enabled:!0,phase:"read",fn:function(e){var t=e.state,i=e.name;t.modifiersData[i]=Ne({reference:t.rects.reference,element:t.rects.popper,strategy:"absolute",placement:t.placement})},data:{}},{name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:function(e){var t=e.state,i=e.options,n=i.gpuAcceleration,s=void 0===n||n,a=i.adaptive,r=void 0===a||a,o=i.roundOffsets,l=void 0===o||o,d={placement:X(t.placement),variation:pe(t.placement),popper:t.elements.popper,popperRect:t.rects.popper,gpuAcceleration:s,isFixed:"fixed"===t.options.strategy};null!=t.modifiersData.popperOffsets&&(t.styles.popper=Object.assign({},t.styles.popper,ge(Object.assign({},d,{offsets:t.modifiersData.popperOffsets,position:t.options.strategy,adaptive:r,roundOffsets:l})))),null!=t.modifiersData.arrow&&(t.styles.arrow=Object.assign({},t.styles.arrow,ge(Object.assign({},d,{offsets:t.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:l})))),t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-placement":t.placement})},data:{}},z,{name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:function(e){var t=e.state,i=e.options,n=e.name,s=i.offset,a=void 0===s?[0,0]:s,r=H.reduce((function(e,i){return e[i]=function(e,t,i){var n=X(e),s=[P,F].indexOf(n)>=0?-1:1,a="function"==typeof i?i(Object.assign({},t,{placement:e})):i,r=a[0],o=a[1];return r=r||0,o=(o||0)*s,[P,R].indexOf(n)>=0?{x:o,y:r}:{x:r,y:o}}(i,t.rects,a),e}),{}),o=r[t.placement],l=o.x,d=o.y;null!=t.modifiersData.popperOffsets&&(t.modifiersData.popperOffsets.x+=l,t.modifiersData.popperOffsets.y+=d),t.modifiersData[n]=r}},Ce,{name:"preventOverflow",enabled:!0,phase:"main",fn:function(e){var t=e.state,i=e.options,n=e.name,s=i.mainAxis,a=void 0===s||s,r=i.altAxis,o=void 0!==r&&r,l=i.boundary,d=i.rootBoundary,h=i.altBoundary,p=i.padding,c=i.tether,g=void 0===c||c,u=i.tetherOffset,f=void 0===u?0:u,m=Oe(t,{boundary:l,rootBoundary:d,padding:p,altBoundary:h}),y=X(t.placement),E=pe(t.placement),v=!E,b=re(y),w="x"===b?"y":"x",S=t.modifiersData.popperOffsets,D=t.rects.reference,x=t.rects.popper,T="function"==typeof f?f(Object.assign({},t.rects,{placement:t.placement})):f,N="number"==typeof T?{mainAxis:T,altAxis:T}:Object.assign({mainAxis:0,altAxis:0},T),O=t.modifiersData.offset?t.modifiersData.offset[t.placement]:null,I={x:0,y:0};if(S){if(a){var C,A="y"===b?F:P,L="y"===b?_:R,k="y"===b?"height":"width",V=S[b],M=V+m[A],H=V-m[L],Y=g?-x[k]/2:0,B="start"===E?D[k]:x[k],G="start"===E?-x[k]:-D[k],j=t.elements.arrow,W=g&&j?Z(j):{width:0,height:0},U=t.modifiersData["arrow#persistent"]?t.modifiersData["arrow#persistent"].padding:{top:0,right:0,bottom:0,left:0},z=U[A],K=U[L],J=oe(0,D[k],W[k]),Q=v?D[k]/2-Y-J-z-N.mainAxis:B-J-z-N.mainAxis,ee=v?-D[k]/2+Y+J+K+N.mainAxis:G+J+K+N.mainAxis,te=t.elements.arrow&&ae(t.elements.arrow),ie=te?"y"===b?te.clientTop||0:te.clientLeft||0:0,ne=null!=(C=null==O?void 0:O[b])?C:0,se=V+ee-ne,le=oe(g?q(M,V+Q-ne-ie):M,V,g?$(H,se):H);S[b]=le,I[b]=le-V}if(o){var de,he="x"===b?F:P,ce="x"===b?_:R,ge=S[w],ue="y"===w?"height":"width",fe=ge+m[he],me=ge-m[ce],ye=-1!==[F,P].indexOf(y),Ee=null!=(de=null==O?void 0:O[w])?de:0,ve=ye?fe:ge-D[ue]-x[ue]-Ee+N.altAxis,be=ye?ge+D[ue]+x[ue]-Ee-N.altAxis:me,we=g&&ye?function(e,t,i){var n=oe(e,t,i);return n>i?i:n}(ve,ge,be):oe(g?ve:fe,ge,g?be:me);S[w]=we,I[w]=we-ge}t.modifiersData[n]=I}},requiresIfExists:["offset"]},he,{name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:function(e){var t=e.state,i=e.name,n=t.rects.reference,s=t.rects.popper,a=t.modifiersData.preventOverflow,r=Oe(t,{elementContext:"reference"}),o=Oe(t,{altBoundary:!0}),l=Ae(r,n),d=Ae(o,s,a),h=Le(l),p=Le(d);t.modifiersData[i]={referenceClippingOffsets:l,popperEscapeOffsets:d,isReferenceHidden:h,hasPopperEscaped:p},t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-reference-hidden":h,"data-popper-escaped":p})}}]});class He{constructor(e,t,i,n=30){this.owner=e,this.containerEl=t,this.limit=n,this.owner=e,this.containerEl=t,t.on("click",".suggestion-item",this.onSuggestionClick.bind(this)),t.on("mousemove",".suggestion-item",this.onSuggestionMouseover.bind(this)),i.register([],"ArrowUp",(e=>{if(!e.isComposing)return this.setSelectedItem(this.selectedItem-1,!0),!1})),i.register([],"ArrowDown",(e=>{if(!e.isComposing)return this.setSelectedItem(this.selectedItem+1,!0),!1})),i.register([],"Enter",(e=>{if(!e.isComposing)return this.useSelectedItem(e),!1}))}onSuggestionClick(e,t){e.preventDefault();const i=this.suggestions.indexOf(t);this.setSelectedItem(i,!1),this.useSelectedItem(e)}onSuggestionMouseover(e,t){const i=this.suggestions.indexOf(t);this.setSelectedItem(i,!1)}setSuggestions(e){this.containerEl.empty();const t=[];e.slice(0,this.limit).forEach((e=>{const i=this.containerEl.createDiv("suggestion-item");this.owner.renderSuggestion(e,i),t.push(i)})),this.values=e,this.suggestions=t,this.setSelectedItem(0,!1)}useSelectedItem(e){const t=this.values[this.selectedItem];t&&this.owner.selectSuggestion(t,e)}setSelectedItem(e,t){const i=(e%(n=this.suggestions.length)+n)%n;var n;const s=this.suggestions[this.selectedItem],a=this.suggestions[i];null==s||s.removeClass("is-selected"),null==a||a.addClass("is-selected"),this.selectedItem=i,t&&a.scrollIntoView(!1)}}!function(e){e[e.TemplateFiles=0]="TemplateFiles",e[e.ScriptFiles=1]="ScriptFiles"}(Ve||(Ve={}));class Ye extends class{constructor(e,t){this.app=e,this.inputEl=t,this.scope=new i.Scope,this.suggestEl=createDiv("suggestion-container");const n=this.suggestEl.createDiv("suggestion");this.suggest=new He(this,n,this.scope),this.scope.register([],"Escape",this.close.bind(this)),this.inputEl.addEventListener("input",this.onInputChanged.bind(this)),this.inputEl.addEventListener("focus",this.onInputChanged.bind(this)),this.inputEl.addEventListener("blur",this.close.bind(this)),this.suggestEl.on("mousedown",".suggestion-container",(e=>{e.preventDefault()}))}onInputChanged(){const e=this.inputEl.value,t=this.getSuggestions(e);t&&t.length>0?(this.suggest.setSuggestions(t),this.open(this.app.dom.appContainerEl,this.inputEl)):this.close()}open(e,t){this.app.keymap.pushScope(this.scope),e.appendChild(this.suggestEl),this.popper=Me(t,this.suggestEl,{placement:"bottom-start",modifiers:[{name:"sameWidth",enabled:!0,fn:({state:e,instance:t})=>{const i=`${e.rects.reference.width}px`;e.styles.popper.width!==i&&(e.styles.popper.width=i,t.update())},phase:"beforeWrite",requires:["computeStyles"]}]})}close(){this.app.keymap.popScope(this.scope),this.suggest.setSuggestions([]),this.popper&&this.popper.destroy(),this.suggestEl.detach()}}{constructor(e,t,i){super(e,t),this.app=e,this.inputEl=t,this.plugin=i}getSuggestions(e){const t=e.toLowerCase();return app.vault.getFiles().filter((e=>(this.plugin.settings.showAttachments||"md"===e.extension)&&e.path.toLowerCase().contains(t)))}renderSuggestion(e,t){t.setText(e.path)}selectSuggestion(e){this.inputEl.value=e.path,this.inputEl.trigger("input"),this.close()}}class Be{constructor(e,t){this.contentEl=e,this.plugin=t,e.style.position="relative",this.wrapperDiv=this.contentEl.createDiv(),this.wrapperDiv.style.zIndex="1",this.wrapperDiv.style.position="absolute",this.wrapperDiv.style.top="10px",this.wrapperDiv.style.left="10px";const n=this.wrapperDiv.createEl("input",{type:"text"});n.style.width="400px",n.oninput=()=>{var e;const t=app.vault.getAbstractFileByPath(n.value);t&&t instanceof i.TFile&&(null===(e=this.plugin.scene)||void 0===e||e.renderGraphForFile(n.value),n.value=t.basename)},new Ye(this.plugin.app,n,this.plugin),this.contentEl.appendChild(this.wrapperDiv)}terminate(){var e;if(this.wrapperDiv){try{null===(e=this.contentEl)||void 0===e||e.removeChild(this.wrapperDiv)}catch(e){}this.wrapperDiv=null}}}class Ge{constructor(e,t,i){this.disregardLeafChange=!1,this.nodesMap=new Map,this.links=new k,this.layouts=[],this.blockUpdateTimer=!1,this.settings=e.settings,this.ea=e.EA,this.plugin=e,this.app=e.app,this.leaf=null!=i?i:app.workspace.getLeaf(t),this.terminated=!1}async initialize(){await this.initilizeScene(),this.searchBox=new Be(this.leaf.view.contentEl,this.plugin)}isActive(){var e;return!this.terminated&&app.workspace.getLeafById(null===(e=this.leaf)||void 0===e?void 0:e.id)}async reRender(){this.isActive()&&this.centralLeaf&&this.centralPagePath&&(await this.plugin.createIndex(),await this.render())}async renderGraphForFile(e){var t;if(!this.isActive())return;this.blockUpdateTimer=!0;const i=this.plugin.pages.get(e);if(!i||!i.file)return void(this.blockUpdateTimer=!1);if(!(null===(t=this.ea.targetView)||void 0===t?void 0:t.file)||this.ea.targetView.file.path!==this.settings.excalibrainFilepath)return void this.unloadScene();if(i.file.path===this.ea.targetView.file.path)return void(this.blockUpdateTimer=!1);const n=this.plugin.pages.get(this.centralPagePath);n&&n.path===e&&i.file.stat.mtime===n.mtime?this.blockUpdateTimer=!1:(this.centralLeaf.openFile(i.file),this.centralPagePath=e,await this.plugin.createIndex(),await this.render())}static async openExcalidrawLeaf(e,t,n){let s=0,a=app.vault.getAbstractFileByPath(t.excalibrainFilepath);if(!a||a instanceof i.TFile){if(!a)for(a=await app.vault.create(t.excalibrainFilepath,C);a instanceof i.TFile&&!e.isExcalidrawFile(a)&&s++<10;)await sleep(50);if(s=0,a&&a instanceof i.TFile&&!e.isExcalidrawFile(a)){for(a=await app.vault.create(t.excalibrainFilepath,C);a instanceof i.TFile&&!e.isExcalidrawFile(a)&&s++<10;)await sleep(50);if(!e.isExcalidrawFile(a))return void new i.Notice(`Couldn't open ${t.excalibrainFilepath}. Please try again later.`)}await(null!=n?n:app.workspace.getLeaf(!0)).openFile(a)}else new i.Notice(`Please check settings. ExcaliBrain path (${t.excalibrainFilepath}) points to a folder, not a file`)}async initilizeScene(){this.disregardLeafChange=!1;const e=this.ea,t=this.settings.baseNodeStyle;let n=0;for(e.setView(this.leaf.view),e.clear(),n=0;!e.targetView.excalidrawAPI&&n++<10;)await sleep(50);e.targetView.excalidrawAPI?(this.ea.registerThisAsViewEA(),this.ea.targetView.semaphores.saving=!0,e.style.fontFamily=t.fontFamily,e.style.fontSize=t.fontSize,this.textSize=e.measureText("m".repeat(t.maxLabelLength+3)),this.nodeWidth=this.textSize.width+3*t.padding,this.nodeHeight=2*(this.textSize.height+2*t.padding),e.getExcalidrawAPI().updateScene({appState:{viewModeEnabled:!0,theme:"light",viewBackgroundColor:this.settings.backgroundColor},elements:[]}),e.style.strokeColor=t.textColor,e.addText(0,0,"xxxxOpen a document in another pane and click it to get started.\n\nFor the best experience enable 'Open in adjacent pane'\nin Excalidraw settings under 'Links and Transclusion'.",{textAlign:"center"}),await e.addElementsToView(),e.getExcalidrawAPI().zoomToFit(null,5),e.targetView.linksAlwaysOpenInANewPane=!0,this.addEventHandler(),new i.Notice("ExcaliBrain On")):new i.Notice("Error initializing Excalidraw view")}addNodes(t){t.neighbours.forEach((i=>{if(i.page.path===this.ea.targetView.file.path)return;const n=new y({page:i.page,isInferred:i.relationType===e.INFERRED,isCentral:t.isCentral,isSibling:t.isSibling,friendGateOnLeft:t.friendGateOnLeft});this.nodesMap.set(i.page.path,n),t.layout.nodes.push(n)}))}async render(){this.ea.clear(),this.ea.getExcalidrawAPI().updateScene({elements:[]}),this.ea.style.verticalAlign="middle";const e=this.plugin.pages.get(this.centralPagePath),i=e.getParents().filter((t=>t.page.path!==e.path)).slice(0,this.plugin.settings.maxItemCount),n=e.getChildren().filter((t=>t.page.path!==e.path)).slice(0,this.plugin.settings.maxItemCount),s=e.getFriends().filter((t=>t.page.path!==e.path)).slice(0,this.plugin.settings.maxItemCount),a=e.getSiblings().filter((t=>!(i.some((e=>e.page.path===t.page.path))||n.some((e=>e.page.path===t.page.path))||s.some((e=>e.page.path===t.page.path)))&&t.page.path!==e.path)).slice(0,this.plugin.settings.maxItemCount);this.nodesMap=new Map,this.links=new k,this.layouts=[];const r=n.length>10,o=a.length>10,l=i.length<=1,d=new A({origoX:0,origoY:0,top:null,bottom:null,columns:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(d);const h=new A({origoX:0,origoY:2.5*this.nodeHeight,top:2*this.nodeHeight,bottom:null,columns:r?5:3,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(h);const p=new A({origoX:(r?-3:-2)*this.nodeWidth,origoY:0,top:null,bottom:null,columns:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(p);const c=new A({origoX:0,origoY:-2.5*this.nodeHeight,top:null,bottom:-2*this.nodeHeight,columns:3,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(c);const g=new A({origoX:this.nodeWidth*((l?0:1)+(o?2:1)),origoY:-2.5*this.nodeHeight,top:null,bottom:this.nodeHeight,columns:o?3:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(g);const u=new y({page:e,isInferred:!1,isCentral:!0,isSibling:!1,friendGateOnLeft:!0});this.nodesMap.set(e.path,u),d.nodes.push(u),this.addNodes({neighbours:i,layout:c,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.addNodes({neighbours:n,layout:h,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.addNodes({neighbours:s,layout:p,isCentral:!1,isSibling:!1,friendGateOnLeft:!1}),this.addNodes({neighbours:a,layout:g,isCentral:!1,isSibling:!0,friendGateOnLeft:!0});const f=(e,t,i)=>{t.forEach((t=>{const n=this.nodesMap.get(t.page.path);n&&this.links.addLink(e,n,i,t.relationType,t.typeDefinition,this.ea,this.settings)}))};Array.from(this.nodesMap.values()).forEach((e=>{f(e,e.page.getChildren(),t.CHILD),f(e,e.page.getParents(),t.PARENT),f(e,e.page.getFriends(),t.FRIEND)})),this.layouts.forEach((e=>e.render())),this.links.render();const m=this.ea.getElements();this.ea.getExcalidrawAPI().updateScene({elements:m.filter((e=>"arrow"===e.type)).concat(m.filter((e=>"arrow"!==e.type)))}),this.ea.getExcalidrawAPI().zoomToFit(null,5),this.blockUpdateTimer=!1}addEventHandler(){const e=this,t=async t=>{var n;if(this.disregardLeafChange)return;if(e.blockUpdateTimer=!0,await e.plugin.createIndex(),!(null===(n=e.ea.targetView)||void 0===n?void 0:n.file)||e.ea.targetView.file.path!==e.settings.excalibrainFilepath)return void e.unloadScene();if(!((null==t?void 0:t.view)&&t.view instanceof i.FileView&&t.view.file))return void(e.blockUpdateTimer=!1);const s=t.view.file;if(s.path===e.ea.targetView.file.path)return void(e.blockUpdateTimer=!1);const a=e.plugin.pages.get(e.centralPagePath);a&&a.path===s.path&&s.stat.mtime===a.mtime?e.blockUpdateTimer=!1:(e.centralPagePath=s.path,e.centralLeaf=t,e.render())};app.workspace.on("active-leaf-change",t),this.removeEH=()=>app.workspace.off("active-leaf-change",t);const n=setInterval((async()=>{if(!this.blockUpdateTimer)for(const e of this.nodesMap.values()){const{file:t,mtime:i}=e.page;if(t&&t.stat.mtime!==i)return await this.plugin.createIndex(),this.centralPagePath=t.path,void this.render()}}),5e3);this.removeTimer=()=>clearInterval(n);const s=[];app.workspace.iterateAllLeaves((e=>{e.view instanceof i.FileView&&e.view.file&&e.view.file.path!==this.ea.targetView.file.path&&s.push(e)})),s.length>0&&t(s[0])}unloadScene(){var e;if(this.removeEH&&(this.removeEH(),this.removeEH=void 0),this.removeTimer&&(this.removeTimer(),this.removeTimer=void 0),this.ea.targetView&&isBoolean(this.ea.targetView.linksAlwaysOpenInANewPane)&&(this.ea.targetView.linksAlwaysOpenInANewPane=!1),this.ea.targetView&&this.ea.targetView.excalidrawAPI)try{this.ea.targetView.semaphores.saving=!1,this.ea.targetView.excalidrawAPI.updateScene({appState:{viewModeEnabled:!1}})}catch(e){}if(this.ea.targetView)try{this.ea.deregisterThisAsViewEA()}catch(e){}null===(e=this.searchBox)||void 0===e||e.terminate(),this.searchBox=void 0,this.ea.targetView=void 0,this.leaf=void 0,this.centralLeaf=void 0,this.centralPagePath=void 0,this.terminated=!0,new i.Notice("Brain Graph Off")}}class je extends i.Plugin{constructor(e,t){super(e,t),this.scene=null,this.pluginLoaded=!1}async onload(){await this.loadSettings(),this.addSettingTab(new D(this.app,this)),this.app.workspace.onLayoutReady((()=>(this.DVAPI=T(),this.DVAPI?(this.EA=h(),this.EA?this.EA.verifyMinimumPluginVersion("1.6.27")?(this.registerCommands(),this.registerExcalidrawAutomateHooks(),void(this.pluginLoaded=!0)):(new i.Notice(f("EXCALIDRAW_MINAPP_VERSION"),4e3),p({fn:this.onload,where:"main.ts/onload()",message:"ExcaliBrain requires a new version of Excalidraw"}),void this.app.plugins.disablePlugin("excalibrain")):(new i.Notice(f("EXCALIDRAW_NOT_FOUND"),4e3),p({fn:this.onload,where:"main.ts/onload()",message:"Excalidraw not found"}),void this.app.plugins.disablePlugin("excalibrain"))):(new i.Notice(f("DATAVIEW_NOT_FOUND"),4e3),p({fn:this.onload,where:"main.ts/onload()",message:"Dataview not found"}),void this.app.plugins.disablePlugin("excalibrain")))))}async createIndex(){this.pages=new I(this);let e=0;for(;this.app.metadataCache.inProgressTaskCount>0||this.DVAPI.index.importer.reloadQueue.length>0;)e++%100==10&&new i.Notice("ExcaliBrain is waiting for Dataview initialization",1e3),await sleep(100);for(const e of this.app.vault.getFiles())this.pages.add(e.path,new o(e.path,e,this));this.pages.addUnresolvedLinks(),this.pages.addResolvedLinks(),this.pages.forEach(((e,t)=>{(null==e?void 0:e.file)&&this.pages.addDVFieldLinksToPage(e)}))}registerCommands(){this.addCommand({id:"excalibrain-start",name:f("COMMAND_START"),callback:()=>{if(this.scene&&!this.scene.terminated)this.scene.unloadScene(),this.scene=null;else{const e=this.getBrainLeaf();if(e&&e.view&&e.view.file&&e.view.file.path==this.settings.excalibrainFilepath)return this.scene=new Ge(this,!0,e),void this.scene.initialize();Ge.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,e)}}})}getBrainLeaf(){let e;return app.workspace.iterateAllLeaves((t=>{t.view&&this.EA.isExcalidrawView(t.view)&&t.view.file.path===this.settings.excalibrainFilepath&&(e=t)})),e}registerExcalidrawAutomateHooks(){this.EA.onViewModeChangeHook=e=>{var t;this.EA.targetView&&(null===(t=this.EA.targetView.file)||void 0===t?void 0:t.path)===this.settings.excalibrainFilepath&&(e||this.stop())},this.EA.onLinkHoverHook=(e,t)=>{var i;return!(this.scene&&this.EA.targetView&&(null===(i=this.EA.targetView.file)||void 0===i?void 0:i.path)===this.settings.excalibrainFilepath&&this.EA.targetView.excalidrawAPI&&this.EA.targetView.excalidrawAPI.getAppState().viewModeEnabled&&(this.scene.disregardLeafChange=!0,this.disregardLeafChangeTimer&&clearTimeout(this.disregardLeafChangeTimer),this.disregardLeafChangeTimer=setTimeout((()=>{this.disregardLeafChangeTimer=null,this.scene&&(this.scene.disregardLeafChange=!1)}),1e3),0))},this.EA.onViewUnloadHook=e=>{this.scene&&this.scene.leaf===e.leaf&&this.stop()}}onunload(){this.scene&&(this.scene.unloadScene(),this.scene=null)}async loadSettings(){this.settings=Object.assign({},E,await this.loadData()),this.nodeStyles={},this.nodeStyles.base={style:this.settings.baseNodeStyle,allowOverride:!1,userStyle:!1,display:f("NODESTYLE_BASE"),getInheritedStyle:()=>Object.assign({},this.settings.baseNodeStyle)},this.nodeStyles.inferred={style:this.settings.inferredNodeStyle,allowOverride:!0,userStyle:!1,display:f("NODESTYLE_INFERRED"),getInheritedStyle:()=>Object.assign({},this.settings.baseNodeStyle)},this.nodeStyles.virtual={style:this.settings.virtualNodeStyle,allowOverride:!0,userStyle:!1,display:f("NODESTYLE_VIRTUAL"),getInheritedStyle:()=>Object.assign({},this.settings.baseNodeStyle)},this.nodeStyles.central={style:this.settings.centralNodeStyle,allowOverride:!0,userStyle:!1,display:f("NODESTYLE_CENTRAL"),getInheritedStyle:()=>Object.assign({},this.settings.baseNodeStyle)},this.nodeStyles.sibling={style:this.settings.siblingNodeStyle,allowOverride:!0,userStyle:!1,display:f("NODESTYLE_SIBLING"),getInheritedStyle:()=>Object.assign({},this.settings.baseNodeStyle)},this.nodeStyles.attachment={style:this.settings.attachmentNodeStyle,allowOverride:!0,userStyle:!1,display:f("NODESTYLE_ATTACHMENT"),getInheritedStyle:()=>Object.assign({},this.settings.baseNodeStyle)},Object.entries(this.settings.tagNodeStyles).forEach((e=>{this.nodeStyles[e[0]]={style:e[1],allowOverride:!0,userStyle:!0,display:e[0],getInheritedStyle:()=>Object.assign({},this.settings.baseNodeStyle)}}))}async saveSettings(){await this.saveData(this.settings)}stop(){this.scene&&!this.scene.terminated&&(this.scene.unloadScene(),this.scene=null)}async start(e){let t=0;for(;!this.pluginLoaded&&t++<100;)await sleep(50);if(!this.pluginLoaded)return new i.Notice("ExcaliBrain plugin did not load - aborting start()"),void p({where:"ExcaliBrain.start()",fn:this.start,message:"ExcaliBrain did not load. Aborting after 5000ms of trying"});if(t<4)for(;t++<8;)await sleep(50);this.stop(),e?(this.scene=new Ge(this,!0,e),this.scene.initialize()):await Ge.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,this.getBrainLeaf())}}module.exports=je;