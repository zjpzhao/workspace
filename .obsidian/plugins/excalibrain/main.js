"use strict";var e,t,i,s=require("obsidian");!function(e){e[e.DEFINED=1]="DEFINED",e[e.INFERRED=2]="INFERRED"}(e||(e={})),function(e){e[e.PARENT=0]="PARENT",e[e.CHILD=1]="CHILD",e[e.FRIEND=2]="FRIEND"}(t||(t={})),function(e){e[e.TO=1]="TO",e[e.FROM=2]="FROM",e[e.BOTH=3]="BOTH"}(i||(i={}));const n={target:null,isParent:!1,isChild:!1,isFriend:!1,direction:null},a=t=>({pi:t.isParent&&t.parentType===e.INFERRED,pd:t.isParent&&t.parentType===e.DEFINED,ci:t.isChild&&t.childType===e.INFERRED,cd:t.isChild&&t.childType===e.DEFINED,fd:t.isFriend}),r=(e,t)=>e&&t?e+", "+t:e||t,o=(e,t)=>e?e===i.BOTH||e===t?e:i.BOTH:t,l=(t,i)=>t===e.DEFINED?e.DEFINED:t===e.INFERRED?i===e.DEFINED?e.DEFINED:e.INFERRED:i;class d{constructor(t,i,s){this.isChild=t=>{const{pi:i,pd:s,ci:n,cd:r,fd:o}=a(t);return!r||s||o?i||s||!n||r||o?null:e.INFERRED:e.DEFINED},this.path=t,this.file=i,this.mtime=i?i.stat.mtime:null,this.neighbours=new Map,this.plugin=s,this.settings=s.settings}getNeighbours(){const{showVirtualNodes:e,showAttachments:t,showInferredNodes:i}=this.settings;return Array.from(this.neighbours).filter((i=>(e||!i[1].target.isVirtual)&&(t||!i[1].target.isAttachment)))}get isVirtual(){return null===this.file}get isAttachment(){return!!this.file&&"md"!==this.file.extension}get isMarkdown(){var e;return"md"===(null===(e=this.file)||void 0===e?void 0:e.extension)||!this.file}addParent(e,t,i,s){if(e.path===this.plugin.settings.excalibrainFilepath)return;const a=this.neighbours.get(e.path);if(a)return a.isParent=!0,a.parentType=l(a.parentType,t),a.parentTypeDefinition=r(s,a.parentTypeDefinition),void(a.direction=o(a.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},n),{target:e,isParent:!0,parentType:t,parentTypeDefinition:s,direction:i}))}addChild(e,t,i,s){if(e.path===this.plugin.settings.excalibrainFilepath)return;const a=this.neighbours.get(e.path);if(a)return a.isChild=!0,a.childType=l(a.childType,t),a.childTypeDefinition=r(s,a.childTypeDefinition),void(a.direction=o(a.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},n),{target:e,isChild:!0,childType:t,childTypeDefinition:s,direction:i}))}addFriend(e,t,i,s){if(e.path===this.plugin.settings.excalibrainFilepath)return;const a=this.neighbours.get(e.path);if(a)return a.isFriend=!0,a.friendType=l(a.friendType,t),a.friendTypeDefinition=r(s,a.friendTypeDefinition),void(a.direction=o(a.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},n),{target:e,isFriend:!0,friendType:t,friendTypeDefinition:s,direction:i}))}unlinkNeighbour(e){this.neighbours.delete(e)}hasChildren(){return this.getNeighbours().some((t=>{const i=this.isChild(t[1]);return i&&this.settings.showInferredNodes||i===e.DEFINED}))}getChildren(){return this.getNeighbours().filter((t=>{const i=this.isChild(t[1]);return i&&this.settings.showInferredNodes||i===e.DEFINED})).map((e=>({page:e[1].target,relationType:e[1].childType,typeDefinition:e[1].childTypeDefinition,linkDirection:e[1].direction})))}isParent(t){const{pi:i,pd:s,ci:n,cd:r,fd:o}=a(t);return r||!s||o?!i||s||n||r||o?null:e.INFERRED:e.DEFINED}hasParents(){return this.getNeighbours().some((t=>{const i=this.isParent(t[1]);return i&&this.settings.showInferredNodes||i===e.DEFINED}))}getParents(){return this.getNeighbours().filter((t=>{const i=this.isParent(t[1]);return i&&this.settings.showInferredNodes||i===e.DEFINED})).map((e=>({page:e[1].target,relationType:e[1].parentType,typeDefinition:e[1].parentTypeDefinition,linkDirection:e[1].direction})))}isFriend(t){const{pi:i,pd:s,ci:n,cd:r,fd:o}=a(t);return o?e.DEFINED:!i||s||!n||r||o?null:e.INFERRED}hasFriends(){return this.getNeighbours().some((t=>{const i=this.isFriend(t[1]);return i&&this.settings.showInferredNodes||i===e.DEFINED}))}getFriends(){return this.getNeighbours().filter((t=>{const i=this.isFriend(t[1]);return i&&this.settings.showInferredNodes||i===e.DEFINED})).map((t=>{var i;return{page:t[1].target,relationType:(null!==(i=t[1].friendType)&&void 0!==i?i:t[1].parentType===e.DEFINED&&t[1].childType===e.DEFINED)?e.DEFINED:e.INFERRED,typeDefinition:t[1].friendTypeDefinition,linkDirection:t[1].direction}}))}getRelationToPage(e){const t=this.neighbours.get(e.path);return t?this.isChild(t)?{type:"child",relationType:t.childType,typeDefinition:t.childTypeDefinition}:this.isParent(t)?{type:"parent",relationType:t.parentType,typeDefinition:t.parentTypeDefinition}:{type:"friend",relationType:t.friendType,typeDefinition:t.friendTypeDefinition}:null}getSiblings(){const t=new Map;return this.getParents().forEach((i=>i.page.getChildren().forEach((i=>{t.has(i.page.path)?i.relationType===e.DEFINED&&(t.get(i.page.path).relationType=e.DEFINED):t.set(i.page.path,i)})))),Array.from(t.values())}}var h={};Object.defineProperty(h,"__esModule",{value:!0});const c=e=>{try{return window.ExcalidrawAutomate.getAPI(e)}catch(e){return console.log({message:"Excalidraw not available",fn:c}),null}};var p=h.getEA=c;const g=e=>{console.error(Object.assign({plugin:"ExcaliBrain"},e))},u=console.log.bind(window.console);console.log.bind(window.console);const f=e=>`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(e.replaceAll("&nbsp;"," "))))}`;var m={JSON_MALFORMED:"Malformed JSON",JSON_MISSING_KEYS:'JSON must have these 3 keys: "parents", "children", "friends"',JSON_VALUES_NOT_STRING_ARRAYS:'Key values must be a non-empty array of strings. e.g. "parents": ["Parent", "Parents", "up"]',EXCALIBRAIN_FILE_NAME:"Filepath of Excalibrain drawing",EXCALIBRAIN_FILE_DESC:"⚠ This file will be overwritten by the plugin. If you stop the script and make changes to the graph, you should rename the file so your edits are preserved, because the next time you initiate ExcaliBrain your edits will be overwritten by the automatically generated ExcaliBrain graph.",HIERARCHY_HEAD:"Hierarchy",HIERARCHY_DESC:"Enter the Dataview field names separated by comma (,) that you will use to define link directions in your graph.",PARENTS_NAME:"Parents",CHILDREN_NAME:"Children",FRIENDS_NAME:"Friends",DISPLAY_HEAD:"Display",EXCLUDE_PATHLIST_NAME:"Filepaths to exclude",EXCLUDE_PATHLIST_DESC:"Enter comma-separated list of filepaths to exclude from the index.",RENDERALIAS_NAME:"Display alias if available",RENDERALIAS_DESC:"Displays the page alias instead of the filename if it is specified in the page's front matter.",SHOWINFERRED_NAME:"Display inferred relationships",SHOWINFERRED_DESC:"<b>Toggle ON</b>: Display both explicitly defined and inferred links. Forward links are children, backlinks are parents, if two page mutually referes to one another then relationship is inferred to be a friendship. Explicitly defined relationships always take priority.<br><b>Toggle OFF</b>: Display only explicitely defined relationships.",SHOWVIRTUAL_NAME:"Display virtual child nodes",SHOWVIRTUAL_DESC:"<b>Toggle ON</b>: Display unresolved links.<br><b>Toggle OFF</b>: Do not display unresolved links.",SHOWATTACHMENTS_NAME:"Include attachments",SHOWATTACHMENTS_DESC:"<b>Toggle ON</b>: Display every type of file on the graph. <br><b>Toggle OFF</b>: Display only markdown files.",STYLE_HEAD:"Styling",STYLE_DESC:"Styles are applied in sequence.<br><ol><li><b>Base</b> node style</li><li><b>Inferred</b> node style (only applied if the node is inferred)</li><li><b>Virtual</b> node style (only applied if the node is virtual)</li> <li><b>Central</b> node style (only applied if the node is in the center)</li><li><b>Sibling</b> node style (only applied if the node is a sibling)</li> <li><b>Attachment</b> node style (only applied if the node is an attachment)</li><li><b>Optional</b> tag based style</li></ol>All the attributes of the base node style must be specified. All other styles may have partial definitions. e.g. You may add a prefix and override the base node-background color in the tag-based style, override the font color in the inferred-node style and set the border stroke style to dotted in the virtual-node style.",CANVAS_BGCOLOR:"Canvas color",TAGLIST_NAME:"Formatted tags",TAGLIST_DESC:"You can specify special formatting rules for Nodes based on tags. If multiple tags are present on the page the first matching a specification will be used. <br>Tagnames should start with <mark>#</mark> and may be incomplete. i.e. <code>#book</code> will match #books, #book/fiction, etc.<br>Enter a comma separated list of tags here, then select from the dropdown list to change the formatting.",MAX_ITEMCOUNT_DESC:"Maximum node count",MAX_ITEMCOUNT_NAME:"Maximum number of nodes to display in a given area of the layout.i.e. the maximum number of parents, the maximum number of children, the maximum number of friends, and the maximum number of siblings to display. If there are more items, they will be ommitted from the drawing.",NODESTYLE_INCLUDE_TOGGLE:"Toggle ON: override base node style for this attribute; OFF: apply base node style for this attribute",NODESTYLE_PREFIX_NAME:"Prefix",NODESTYLE_PREFIX_DESC:"Prefix character or emoji to display in front of the node's label",NODESTYLE_BGCOLOR:"Background color",NODESTYLE_BG_FILLSTYLE:"Bacground fill-style",NODESTYLE_TEXTCOLOR:"Text color",NODESTYLE_BORDERCOLOR:"Border color",NODESTYLE_FONTSIZE:"Font size",NODESTYLE_FONTFAMILY:"Font family",NODESTYLE_MAXLABELLENGTH_NAME:"Max label length",NODESTYLE_MAXLABELLENGTH_DESC:"Maximum number of characters to display from node title. Longer nodes will end with '...'",NODESTYLE_ROUGHNESS:"Stroke roughness",NODESTYLE_SHARPNESS:"Stroke sharpness",NODESTYLE_STROKEWIDTH:"Stroke width",NODESTYLE_STROKESTYLE:"Stroke style",NODESTYLE_RECTANGLEPADDING:"Padding of the node rectangle",NODESTYLE_GATE_RADIUS_NAME:"Gate radius",NODESTYLE_GATE_RADIUS_DESC:"The radius of the 3 small circles (alias: gates) serving as connection points for nodes",NODESTYLE_GATE_OFFSET_NAME:"Gate offset",NODESTYLE_GATE_OFFSET_DESC:"The offset to the left and right of the parent and child gates.",NODESTYLE_GATE_COLOR:"Gate border color",NODESTYLE_GATE_BGCOLOR_NAME:"Gate background color",NODESTYLE_GATE_BGCOLOR_DESC:"The fill color of the gate if it has children",NODESTYLE_GATE_FILLSTYLE:"Gate background fill-style",NODESTYLE_BASE:"Base node style",NODESTYLE_CENTRAL:"Style of central node",NODESTYLE_INFERRED:"Style of inferred nodes",NODESTYLE_VIRTUAL:"Style of virtual nodes",NODESTYLE_SIBLING:"Style of sibling nodes",NODESTYLE_ATTACHMENT:"Style of attachment nodes",LINKSTYLE_COLOR:"Color",LINKSTYLE_WIDTH:"Width",LINKSTYLE_STROKE:"Stroke style",LINKSTYLE_ROUGHNESS:"Roughness",LINKSTYLE_ARROWSTART:"Start arrow head",LINKSTYLE_ARROWEND:"End arrow head",LINKSTYLE_BASE:"Base link style",LINKSTYLE_INFERRED:"Style of inferred link",DATAVIEW_NOT_FOUND:"Dataview plugin not found. Please install or enable Dataview, then try restarting ExcaliBrain",EXCALIDRAW_NOT_FOUND:"Excalidraw plugin not found. Please install or enable Excalidraw, then try restarting ExcaliBrain",EXCALIDRAW_MINAPP_VERSION:"ExcaliBrain requires Excalidraw 1.6.27 or higher. Please upgrade Excalidraw",COMMAND_START:"Open ExcaliBrain",OPEN_DRAWING:"Save snapshot for editing",SEARCH_IN_VAULT:"Search for a file in your Vault",SHOW_HIDE_ATTACHMENTS:"Show/Hide attachments",SHOW_HIDE_VIRTUAL:"Show/Hide virtual nodes",SHOW_HIDE_INFERRED:"Show/Hide inferred nodes",SHOW_HIDE_ALIAS:"Show/Hide document alias"};const E={en:m}[s.moment.locale()];function y(e){return E||g({fn:y,where:"src/lang/helpers.ts",message:"Error: locale not found",data:s.moment.locale()}),E&&E[e]||m[e]}class S extends s.Modal{constructor(e,t,i){super(e),this.title=t,this.message=i}onOpen(){this.createForm()}onClose(){}createForm(){this.titleEl.setText(this.title),this.contentEl.createDiv({cls:"excalibrain-prompt-center",text:this.message}),this.contentEl.createDiv({cls:"excalibrain-prompt-center"},(e=>{e.style.textAlign="right",e.createEl("button",{text:"Ok"}).onclick=()=>{this.resolve(!0),this.close()},e.createEl("button",{text:"Cancel"}).onclick=()=>{this.resolve(!1),this.close()}}))}show(e){this.resolve=e,this.open()}}function b(e){const t=e.lastIndexOf("/"),i=-1==t?e:e.substring(t+1);return{folderpath:s.normalizePath(e.substring(0,t)),filename:i,basename:i.replace(/\.[^/.]+$/,"")}}class w{constructor(e){this.style={},this.center={x:0,y:0},this.page=e.page,this.settings=e.page.plugin.settings,this.ea=e.page.plugin.EA,this.style=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isInferred?this.settings.inferredNodeStyle:{}),e.page.isVirtual?this.settings.virtualNodeStyle:{}),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),e.page.isAttachment?this.settings.attachmentNodeStyle:{}),this.getTagStyle()),this.friendGateOnLeft=e.friendGateOnLeft,this.title=this.getTitle()}getTitle(){var e,t,i,s;const n=this.page.file&&this.settings.renderAlias&&null!==(s=null===(i=null===(t=null===(e=this.page.dvPage)||void 0===e?void 0:e.file)||void 0===t?void 0:t.aliases)||void 0===i?void 0:i.values)&&void 0!==s?s:[];return n.length>0?n[0]:this.page.file?"md"===this.page.file.extension?this.page.file.basename:this.page.file.name:(e=>{const t=e.endsWith(".md"),i=e.substring(e.lastIndexOf("/")+1);return t?i.slice(0,-3):i})(this.page.path)}displayText(){var e;const t=(null!==(e=this.style.prefix)&&void 0!==e?e:"")+this.title;return t.length>this.style.maxLabelLength?t.substring(0,this.style.maxLabelLength-1)+"...":t}setCenter(e){this.center=e}getTagStyle(){var e,t,i,s;const n=(null!==(s=null===(i=null===(t=null===(e=this.page.dvPage)||void 0===e?void 0:e.file)||void 0===t?void 0:t.tags)||void 0===i?void 0:i.values)&&void 0!==s?s:[]).filter((e=>this.settings.tagStyleList.some((t=>e.startsWith(t)))))[0];return n?this.settings.tagNodeStyles[this.settings.tagStyleList.filter((e=>n.startsWith(e)))[0]]:{}}render(){var e,t;const i=this.ea,s=this.displayText();i.style.fontSize=this.style.fontSize,i.style.fontFamily=this.style.fontFamily;const n=i.measureText(s);i.style.fillStyle=this.style.fillStyle,i.style.roughness=this.style.roughness,i.style.strokeSharpness=this.style.strokeShaprness,i.style.strokeWidth=this.style.strokeWidth,i.style.strokeColor=this.style.textColor,i.style.backgroundColor="transparent",this.id=i.addText(this.center.x-n.width/2,this.center.y-n.height/2,s,{wrapAt:this.style.maxLabelLength+5,textAlign:"center",box:!0,boxPadding:this.style.padding});const a=i.getElement(this.id);a.link=`[[${null!==(t=null===(e=this.page.file)||void 0===e?void 0:e.path)&&void 0!==t?t:this.page.path}]]`,a.backgroundColor=this.style.backgroundColor,a.strokeColor=this.style.borderColor,a.strokeStyle=this.style.strokeStyle,i.style.fillStyle=this.style.gateFillStyle,i.style.strokeColor=this.style.gateStrokeColor,i.style.strokeStyle="solid",i.style.backgroundColor=this.page.hasFriends()?this.style.gateBackgroundColor:"transparent",this.friendGateId=i.addEllipse(this.friendGateOnLeft?this.center.x-2*this.style.gateRadius-this.style.padding-n.width/2:this.center.x+this.style.padding+n.width/2,this.center.y-this.style.gateRadius,2*this.style.gateRadius,2*this.style.gateRadius),i.style.backgroundColor=this.page.hasParents()?this.style.gateBackgroundColor:"transparent",this.parentGateId=i.addEllipse(this.center.x-this.style.gateRadius-this.style.gateOffset,this.center.y-2*this.style.gateRadius-this.style.padding-n.height/2,2*this.style.gateRadius,2*this.style.gateRadius),i.style.backgroundColor=this.page.hasChildren()?this.style.gateBackgroundColor:"transparent",this.childGateId=i.addEllipse(this.center.x-this.style.gateRadius+this.style.gateOffset,this.center.y+this.style.padding+n.height/2,2*this.style.gateRadius,2*this.style.gateRadius),i.addToGroup([this.friendGateId,this.parentGateId,this.childGateId,this.id,a.boundElements[0].id])}}class v{constructor(t,i,s,n,a,r,o,l){this.nodeA=t,this.nodeB=i,this.nodeBRole=s,this.ea=r;const d=null==a?void 0:a.split(",").map((e=>e.trim()));let h={};d&&d.forEach((e=>{l.hierarchyLinkStylesExtended[e]&&(h=Object.assign(Object.assign({},h),l.hierarchyLinkStylesExtended[e]))})),this.style=Object.assign(Object.assign(Object.assign({},o.baseLinkStyle),n===e.INFERRED?o.inferredLinkStyle:{}),h)}render(){const e=this.ea,i=this.style;let s,n;switch(e.style.strokeStyle=i.strokeStyle,e.style.strokeColor=i.strokeColor,e.style.strokeWidth=i.strokeWidth,this.nodeBRole){case t.CHILD:s=this.nodeA.childGateId,n=this.nodeB.parentGateId;break;case t.PARENT:s=this.nodeA.parentGateId,n=this.nodeB.childGateId;break;default:s=this.nodeA.friendGateId,n=this.nodeB.friendGateId}e.connectObjects(s,null,n,null,{startArrowHead:"none"===i.startArrowHead?null:i.startArrowHead,endArrowHead:"none"===i.endArrowHead?null:i.endArrowHead})}}const D={excalibrainFilepath:"excalibrain.md",hierarchy:{parents:["Parent","Parents","up","u"],children:["Children","Child","down","d"],friends:["Friends","Friend","Jump","Jumps","j"]},renderAlias:!0,backgroundColor:"#0c3e6aff",excludeFilepaths:[],showInferredNodes:!0,showAttachments:!0,showVirtualNodes:!0,maxItemCount:30,baseNodeStyle:{prefix:"",backgroundColor:"#00000066",fillStyle:"solid",textColor:"#ffffffff",borderColor:"#00000000",fontSize:20,fontFamily:3,maxLabelLength:30,roughness:0,strokeShaprness:"round",strokeWidth:1,strokeStyle:"solid",padding:10,gateRadius:5,gateOffset:15,gateStrokeColor:"#ffffffff",gateBackgroundColor:"#ffffffff",gateFillStyle:"solid"},centralNodeStyle:{fontSize:30,backgroundColor:"#C49A13FF",textColor:"#000000ff"},inferredNodeStyle:{backgroundColor:"#000005b3",textColor:"#95c7f3ff"},virtualNodeStyle:{backgroundColor:"#ff000066",fillStyle:"hachure",textColor:"#ffffffff"},siblingNodeStyle:{fontSize:15},attachmentNodeStyle:{prefix:"📎 "},tagNodeStyles:{},tagStyleList:[],baseLinkStyle:{strokeColor:"#696969FF",strokeWidth:1,strokeStyle:"solid",roughness:0,startArrowHead:"none",endArrowHead:"none"},inferredLinkStyle:{strokeStyle:"dashed"},hierarchyLinkStyles:{}},N="excalibrain-settings-disabled",T=e=>(255*e|256).toString(16).slice(1),x=e=>createFragment((t=>t.createDiv().innerHTML=e)),O=e=>{const t=document.getElementById(e);if(!t)return;const i=t.parentNode;i&&i.removeChild(t)},I=(e,t)=>{const i=document.createElement("style");i.id=e,i.innerHTML=`.${t} {display: none;}`,document.body.appendChild(i)};class L extends s.PluginSettingTab{constructor(e,t){super(e,t),this.dirty=!1,this.plugin=t}get hierarchyStyleList(){return["base","inferred"].concat(Array.from(this.plugin.settings.hierarchy.parents)).concat(Array.from(this.plugin.settings.hierarchy.children)).concat(Array.from(this.plugin.settings.hierarchy.friends))}async updateNodeDemoImg(){this.ea.reset(),this.ea.canvas.viewBackgroundColor=this.plugin.settings.backgroundColor,this.demoNode.style=Object.assign(Object.assign({},this.demoNodeStyle.getInheritedStyle()),this.demoNodeStyle.style),this.demoNode.render();const e=await this.ea.createSVG(null,!0,{withBackground:!0,withTheme:!1},null,"",40);e.removeAttribute("width"),e.removeAttribute("height"),this.demoNodeImg.setAttribute("src",f(e.outerHTML))}async updateLinkDemoImg(){this.ea.reset(),this.ea.canvas.viewBackgroundColor=this.plugin.settings.backgroundColor;const s=new d("Start node",null,this.plugin),n=new d("End node",null,this.plugin),a=this.plugin.settings.hierarchy;a.friends.contains(this.demoLinkStyle.display)?(s.addFriend(n,e.DEFINED,i.FROM),n.addFriend(s,e.DEFINED,i.TO)):a.parents.contains(this.demoLinkStyle.display)?(s.addParent(n,e.DEFINED,i.FROM),n.addChild(s,e.DEFINED,i.TO)):(s.addChild(n,e.DEFINED,i.FROM),n.addParent(s,e.DEFINED,i.TO));const r=new w({page:s,isInferred:!1,isCentral:!0,isSibling:!1,friendGateOnLeft:!0});r.ea=this.ea,r.setCenter({x:0,y:0});const o=new w({page:n,isInferred:!1,isCentral:!1,isSibling:!1,friendGateOnLeft:!1});o.ea=this.ea;let l=t.CHILD;a.friends.contains(this.demoLinkStyle.display)?(o.setCenter({x:-300,y:0}),l=t.FRIEND):a.parents.contains(this.demoLinkStyle.display)?(o.setCenter({x:0,y:-150}),l=t.PARENT):o.setCenter({x:0,y:150});const h=new v(r,o,l,e.DEFINED,"base",this.ea,this.plugin.settings,this.plugin);r.style=Object.assign(Object.assign({},this.plugin.settings.baseNodeStyle),this.plugin.settings.centralNodeStyle),r.render(),o.style=Object.assign(Object.assign({},this.demoNodeStyle.getInheritedStyle()),this.demoNodeStyle.style),o.render(),h.style=Object.assign(Object.assign({},this.demoLinkStyle.getInheritedStyle()),this.demoLinkStyle.style),h.render();const c=await this.ea.createSVG(null,!0,{withBackground:!0,withTheme:!1},null,"",40);c.removeAttribute("width"),c.removeAttribute("height"),this.demoLinkImg.setAttribute("src",f(c.outerHTML))}async hide(){var e;this.dirty&&(this.plugin.setHierarchyLinkStylesExtended(),this.plugin.settings.tagStyleList=Object.keys(this.plugin.settings.tagNodeStyles),this.plugin.saveSettings(),null===(e=this.plugin.scene)||void 0===e||e.reRender())}colorpicker(e,t,i,n,a,r,o,l){let d,h,c,p,g,u;const f=new s.Setting(e).setName(t);i&&f.setDesc(x(i));const m=e=>{e?f.settingEl.addClass(N):f.settingEl.removeClass(N),h.disabled=e,h.style.opacity=e?"0.3":"1",d.setDisabled(e),d.sliderEl.style.opacity=e?"0.3":"1",p.style.opacity=e?"0.3":"1",g.style.opacity=e?"0.3":"1",u.style.opacity=e?"0.3":"1"};o&&f.addToggle((e=>{c=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==n()).setTooltip(y("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return m(!0),void r();a(h.value+T(d.getValue())),m(!1)}))})),f.settingEl.removeClass("mod-toggle"),p=createEl("span",{text:"color:",cls:"excalibrain-settings-colorlabel"}),f.controlEl.appendChild(p),h=createEl("input",{type:"color",cls:"excalibrain-settings-colorpicker"},(e=>{var t;e.value=(null!==(t=n())&&void 0!==t?t:l).substring(0,7),e.onchange=()=>{a(e.value+T(d.getValue()))}})),f.controlEl.appendChild(h),g=createEl("span",{text:"opacity:",cls:"excalibrain-settings-opacitylabel"}),f.controlEl.appendChild(g),f.addSlider((e=>{var t,i;d=e,e.setLimits(0,1,.1).setValue((i=null!==(t=n())&&void 0!==t?t:l,parseInt(i.substring(7,9),16)/255)).onChange((e=>{a(h.value+T(e)),u.innerText=` ${e.toString()}`,h.style.opacity=e.toString()}))})),u=createDiv({text:`${d.getValue().toString()}`,cls:"excalibrain-settings-sliderlabel"}),f.controlEl.appendChild(u),h.style.opacity=d.getValue().toString(),m(o&&!c.getValue())}numberslider(e,t,i,n,a,r,o,l,d){let h,c,p;const g=new s.Setting(e).setName(t),u=e=>{e?g.settingEl.addClass(N):g.settingEl.removeClass(N),p.setDisabled(e),p.sliderEl.style.opacity=e?"0.3":"1",h.style.opacity=e?"0.3":"1"};l&&g.addToggle((e=>{c=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==a()).setTooltip(y("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return u(!0),void o();r(p.getValue()),u(!1)}))})),g.addSlider((e=>{var t;p=e,e.setLimits(n.min,n.max,n.step).setValue(null!==(t=a())&&void 0!==t?t:d).onChange((async e=>{h.innerText=` ${e.toString()}`,r(e),this.dirty=!0}))})),i&&g.setDesc(x(i)),g.settingEl.createDiv("",(e=>{h=e,e.style.minWidth="2.3em",e.style.textAlign="right",e.innerText=` ${p.getValue().toString()}`})),u(l&&!c.getValue())}dropdownpicker(e,t,i,n,a,r,o,l,d){let h,c;const p=new s.Setting(e).setName(t),g=e=>{e?p.settingEl.addClass(N):p.settingEl.removeClass(N),h.setDisabled(e),h.selectEl.style.opacity=e?"0.3":"1"};l&&p.addToggle((e=>{c=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==a()).setTooltip(y("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return g(!0),void o();r(h.getValue()),g(!1)}))})),p.addDropdown((e=>{var t;h=e,e.addOptions(n).setValue(null!==(t=a())&&void 0!==t?t:d).onChange((e=>{r(e),this.dirty=!0}))})),i&&p.setDesc(x(i)),g(l&&!c.getValue())}nodeSettings(e,t,i=!0,n){let a,r;const o=new s.Setting(e).setName(y("NODESTYLE_PREFIX_NAME")).setDesc(x(y("NODESTYLE_PREFIX_DESC"))),l=e=>{e?o.settingEl.addClass(N):o.settingEl.removeClass(N),a.setDisabled(e),a.inputEl.style.opacity=e?"0.3":"1"};i&&o.addToggle((e=>{r=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==t.prefix).setTooltip(y("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return l(!0),t.prefix=void 0,void this.updateNodeDemoImg();l(!1)}))})),o.addText((e=>{var i;a=e,e.setValue(null!==(i=t.prefix)&&void 0!==i?i:n.prefix).onChange((e=>{t.prefix=e,this.updateNodeDemoImg(),this.dirty=!0}))})),l(i&&!r.getValue()),this.colorpicker(e,y("NODESTYLE_BGCOLOR"),null,(()=>t.backgroundColor),(e=>{t.backgroundColor=e,this.updateNodeDemoImg()}),(()=>{delete t.backgroundColor,this.updateNodeDemoImg()}),i,n.backgroundColor),this.dropdownpicker(e,y("NODESTYLE_BG_FILLSTYLE"),null,{hachure:"Hachure","cross-hatch":"Cross-hatch",solid:"Solid"},(()=>{var e;return null===(e=t.fillStyle)||void 0===e?void 0:e.toString()}),(e=>{t.fillStyle=e,this.updateNodeDemoImg()}),(()=>{delete t.fillStyle,this.updateNodeDemoImg()}),i,n.fillStyle.toString()),this.colorpicker(e,y("NODESTYLE_TEXTCOLOR"),null,(()=>t.textColor),(e=>{t.textColor=e,this.updateNodeDemoImg()}),(()=>{delete t.textColor,this.updateNodeDemoImg()}),i,n.textColor),this.colorpicker(e,y("NODESTYLE_BORDERCOLOR"),null,(()=>t.borderColor),(e=>{t.borderColor=e,this.updateNodeDemoImg()}),(()=>{delete t.borderColor,this.updateNodeDemoImg()}),i,n.borderColor),this.numberslider(e,y("NODESTYLE_FONTSIZE"),null,{min:10,max:50,step:5},(()=>t.fontSize),(e=>{t.fontSize=e,this.updateNodeDemoImg()}),(()=>{delete t.fontSize,this.updateNodeDemoImg()}),i,n.fontSize),this.dropdownpicker(e,y("NODESTYLE_FONTFAMILY"),null,{1:"Hand-drawn",2:"Normal",3:"Code",4:"Fourth (custom) Font"},(()=>{var e;return null===(e=t.fontFamily)||void 0===e?void 0:e.toString()}),(e=>{t.fontFamily=parseInt(e),this.updateNodeDemoImg()}),(()=>{delete t.fontFamily,this.updateNodeDemoImg()}),i,n.fontFamily.toString()),this.numberslider(e,y("NODESTYLE_MAXLABELLENGTH_NAME"),y("NODESTYLE_MAXLABELLENGTH_DESC"),{min:15,max:100,step:5},(()=>t.maxLabelLength),(e=>{t.maxLabelLength=e,this.updateNodeDemoImg()}),(()=>{delete t.maxLabelLength,this.updateNodeDemoImg()}),i,n.maxLabelLength),this.dropdownpicker(e,y("NODESTYLE_ROUGHNESS"),null,{0:"Architect",1:"Artist",2:"Cartoonist"},(()=>{var e;return null===(e=t.roughness)||void 0===e?void 0:e.toString()}),(e=>{t.roughness=parseInt(e),this.updateNodeDemoImg()}),(()=>{delete t.roughness,this.updateNodeDemoImg()}),i,n.roughness.toString()),this.dropdownpicker(e,y("NODESTYLE_SHARPNESS"),null,{sharp:"Sharp",round:"Round"},(()=>t.strokeShaprness),(e=>{t.strokeShaprness=e,this.updateNodeDemoImg()}),(()=>{delete t.strokeShaprness,this.updateNodeDemoImg()}),i,n.strokeShaprness),this.numberslider(e,y("NODESTYLE_STROKEWIDTH"),null,{min:.5,max:6,step:.5},(()=>t.strokeWidth),(e=>{t.strokeWidth=e,this.updateNodeDemoImg()}),(()=>{delete t.strokeWidth,this.updateNodeDemoImg()}),i,n.strokeWidth),this.dropdownpicker(e,y("NODESTYLE_STROKESTYLE"),null,{solid:"Solid",dashed:"Dashed",dotted:"Dotted"},(()=>t.strokeStyle),(e=>{t.strokeStyle=e,this.updateNodeDemoImg()}),(()=>{delete t.strokeStyle,this.updateNodeDemoImg()}),i,n.strokeStyle),this.numberslider(e,y("NODESTYLE_RECTANGLEPADDING"),null,{min:5,max:50,step:5},(()=>t.padding),(e=>{t.padding=e,this.updateNodeDemoImg()}),(()=>{delete t.padding,this.updateNodeDemoImg()}),i,n.padding),this.numberslider(e,y("NODESTYLE_GATE_RADIUS_NAME"),y("NODESTYLE_GATE_RADIUS_DESC"),{min:3,max:10,step:1},(()=>t.gateRadius),(e=>{t.gateRadius=e,this.updateNodeDemoImg()}),(()=>{delete t.gateRadius,this.updateNodeDemoImg()}),i,n.gateRadius),this.numberslider(e,y("NODESTYLE_GATE_OFFSET_NAME"),y("NODESTYLE_GATE_OFFSET_DESC"),{min:0,max:25,step:1},(()=>t.gateOffset),(e=>{t.gateOffset=e,this.updateNodeDemoImg()}),(()=>{delete t.gateOffset,this.updateNodeDemoImg()}),i,n.gateOffset),this.colorpicker(e,y("NODESTYLE_GATE_COLOR"),null,(()=>t.gateStrokeColor),(e=>{t.gateStrokeColor=e,this.updateNodeDemoImg()}),(()=>{delete t.gateStrokeColor,this.updateNodeDemoImg()}),i,n.gateStrokeColor),this.colorpicker(e,y("NODESTYLE_GATE_BGCOLOR_NAME"),y("NODESTYLE_GATE_BGCOLOR_DESC"),(()=>t.gateBackgroundColor),(e=>{t.gateBackgroundColor=e,this.updateNodeDemoImg()}),(()=>{delete t.gateBackgroundColor,this.updateNodeDemoImg()}),i,n.gateBackgroundColor),this.dropdownpicker(e,y("NODESTYLE_GATE_FILLSTYLE"),null,{hachure:"Hachure","cross-hatch":"Cross-hatch",solid:"Solid"},(()=>{var e;return null===(e=t.gateFillStyle)||void 0===e?void 0:e.toString()}),(e=>{t.gateFillStyle=e,this.updateNodeDemoImg()}),(()=>{delete t.gateFillStyle,this.updateNodeDemoImg()}),i,n.gateFillStyle.toString())}linkSettings(e,t,i=!0,s){this.colorpicker(e,y("LINKSTYLE_COLOR"),null,(()=>t.strokeColor),(e=>{t.strokeColor=e,this.updateLinkDemoImg()}),(()=>{delete t.strokeColor,this.updateLinkDemoImg()}),i,s.strokeColor),this.numberslider(e,y("LINKSTYLE_WIDTH"),null,{min:.5,max:10,step:.5},(()=>t.strokeWidth),(e=>{t.strokeWidth=e,this.updateLinkDemoImg()}),(()=>{delete t.strokeWidth,this.updateLinkDemoImg()}),i,s.strokeWidth),this.dropdownpicker(e,y("LINKSTYLE_STROKE"),null,{solid:"Solid",dashed:"Dashed",dotted:"Dotted"},(()=>t.strokeStyle),(e=>{t.strokeStyle=e,this.updateLinkDemoImg()}),(()=>{delete t.strokeStyle,this.updateLinkDemoImg()}),i,s.strokeStyle),this.dropdownpicker(e,y("LINKSTYLE_ARROWSTART"),null,{none:"None",arrow:"Arrow",bar:"Bar",dot:"Dot",triangle:"Triangle"},(()=>t.startArrowHead),(e=>{t.startArrowHead=""===e?null:e,this.updateLinkDemoImg()}),(()=>{delete t.startArrowHead,this.updateLinkDemoImg()}),i,s.startArrowHead),this.dropdownpicker(e,y("LINKSTYLE_ARROWEND"),null,{none:"None",arrow:"Arrow",bar:"Bar",dot:"Dot",triangle:"Triangle"},(()=>t.endArrowHead),(e=>{t.endArrowHead=""===e?null:e,this.updateLinkDemoImg()}),(()=>{delete t.endArrowHead,this.updateLinkDemoImg()}),i,s.endArrowHead)}async display(){await this.plugin.loadSettings(),this.ea=p();const t=new d("This is a demo node that is 46 characters long",null,this.plugin),n=new d("This is a child node",null,this.plugin);t.addChild(n,e.DEFINED,i.FROM),n.addParent(t,e.DEFINED,i.TO),this.demoNode=new w({page:t,isInferred:!1,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.demoNode.ea=this.ea,this.demoNode.setCenter({x:0,y:0});const{containerEl:a}=this;this.containerEl.empty();const r=a.createDiv("coffee");r.addClass("ex-coffee-div"),r.createEl("a",{href:"https://ko-fi.com/zsolt"}).createEl("img",{attr:{src:"https://cdn.ko-fi.com/cdn/kofi3.png?v=3"}}).height=45,new s.Setting(a).setName(y("EXCALIBRAIN_FILE_NAME")).setDesc(x(y("EXCALIBRAIN_FILE_DESC"))).addText((e=>e.setValue(this.plugin.settings.excalibrainFilepath).onChange((async e=>{this.dirty=!0,e.endsWith(".md")||(e+=".md"),this.app.vault.getAbstractFileByPath(e)?new S(this.app,"⚠ File Exists",`${e} already exists in your Vault. Is it ok to overwrite this file?`).show((t=>{t&&(this.plugin.settings.excalibrainFilepath=e,this.dirty=!0)})):(this.plugin.settings.excalibrainFilepath=e,this.dirty=!0)})).inputEl.onblur=()=>{e.setValue(this.plugin.settings.excalibrainFilepath)})),this.containerEl.createEl("h1",{cls:"excalibrain-settings-h1",text:y("HIERARCHY_HEAD")}),this.containerEl.createEl("p",{}).innerHTML=y("HIERARCHY_DESC");let o,l,h=()=>{};new s.Setting(a).setName(y("PARENTS_NAME")).addText((e=>{e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.parents.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.parents=e.split(",").map((e=>e.trim())),h(),this.dirty=!0}))})),new s.Setting(a).setName(y("CHILDREN_NAME")).addText((e=>{e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.children.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.children=e.split(",").map((e=>e.trim())),h(),this.dirty=!0}))})),new s.Setting(a).setName(y("FRIENDS_NAME")).addText((e=>{e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.friends.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.friends=e.split(",").map((e=>e.trim())),h(),this.dirty=!0}))})),this.containerEl.createEl("h1",{cls:"excalibrain-settings-h1",text:y("DISPLAY_HEAD")}),new s.Setting(a).setName(y("EXCLUDE_PATHLIST_NAME")).setDesc(y("EXCLUDE_PATHLIST_DESC")).addTextArea((e=>{e.inputEl.style.height="100px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.excludeFilepaths.join(", ")).onChange((e=>{const t=(e=e.replaceAll("\n"," ")).split(",").map((e=>e.trim()));this.plugin.settings.excludeFilepaths=t.filter((e=>""!==e)),this.dirty=!0}))})).descEl.style.maxWidth="400px",new s.Setting(a).setName(y("RENDERALIAS_NAME")).setDesc(x(y("RENDERALIAS_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.renderAlias).onChange((e=>{this.plugin.settings.renderAlias=e,this.dirty=!0})))),new s.Setting(a).setName(y("SHOWINFERRED_NAME")).setDesc(x(y("SHOWINFERRED_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showInferredNodes).onChange((e=>{this.plugin.settings.showInferredNodes=e,this.dirty=!0})))),new s.Setting(a).setName(y("SHOWATTACHMENTS_NAME")).setDesc(x(y("SHOWATTACHMENTS_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showAttachments).onChange((e=>{this.plugin.settings.showAttachments=e,this.dirty=!0})))),new s.Setting(a).setName(y("SHOWVIRTUAL_NAME")).setDesc(x(y("SHOWVIRTUAL_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showVirtualNodes).onChange((e=>{this.plugin.settings.showVirtualNodes=e,this.dirty=!0})))),this.numberslider(a,y("MAX_ITEMCOUNT_NAME"),y("MAX_ITEMCOUNT_DESC"),{min:5,max:150,step:5},(()=>this.plugin.settings.maxItemCount),(e=>this.plugin.settings.maxItemCount=e),(()=>{}),!1,30),a.createEl("h1",{cls:"excalibrain-settings-h1",text:y("STYLE_HEAD")}),this.containerEl.createEl("p",{}).innerHTML=y("STYLE_DESC"),this.colorpicker(a,y("CANVAS_BGCOLOR"),null,(()=>this.plugin.settings.backgroundColor),(e=>{this.plugin.settings.backgroundColor=e,this.updateNodeDemoImg()}),(()=>{}),!1,this.plugin.settings.backgroundColor);const c=e=>{l.empty();const t=this.plugin.nodeStyles[e];this.nodeSettings(l,t.style,t.allowOverride,t.getInheritedStyle()),this.demoNodeStyle=t,this.updateNodeDemoImg()};new s.Setting(a).setName(y("TAGLIST_NAME")).setDesc(y("TAGLIST_DESC")).addTextArea((e=>{e.inputEl.style.height="200px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.tagStyleList.join(", ")).onChange((e=>{const t=this.plugin.settings.tagNodeStyles,i=this.plugin.nodeStyles,s=(e=e.replaceAll("\n"," ")).split(",").map((e=>e.trim()));this.plugin.settings.tagStyleList=s,Object.keys(t).forEach((e=>{s.contains(e)||(delete t[e],delete i[e])})),s.forEach((e=>{Object.keys(t).contains(e)||(t[e]={},i[e]={style:t[e],allowOverride:!0,userStyle:!0,display:e,getInheritedStyle:()=>this.plugin.settings.baseNodeStyle})}));const n=o.getValue();for(let e=o.selectEl.options.length-1;e>=0;e--)o.selectEl.remove(e);Object.entries(i).forEach((e=>{o.addOption(e[0],e[1].display)})),i[n]?o.setValue(n):(o.setValue("base"),c("base")),this.dirty=!0}))})).descEl.style.maxWidth="400px";const g=a.createDiv({cls:"setting-item"}),u=g.createDiv({cls:"setting-item-info"});let f;o=new s.DropdownComponent(u),g.createDiv({text:"Show inherited",cls:"setting-item-name"}).style.marginRight="10px";let m=!1;const E=new s.ToggleComponent(g);E.setValue(!0).setTooltip("Show/Hide Inherited Properties").onChange((e=>{m?m=!1:(e?O("excalibrain-hide-disabled"):I("excalibrain-hide-disabled",N),m=!0,f.setValue(e))})),Object.entries(this.plugin.nodeStyles).forEach((e=>{o.addOption(e[0],e[1].display)})),this.demoNodeImg=a.createEl("img",{cls:"excalibrain-settings-demoimg"}),l=a.createDiv({cls:"excalibrain-setting-style-section"}),O("excalibrain-hide-disabled"),o.setValue("base").onChange(c);const b=this.plugin.nodeStyles.base;let v,D;this.nodeSettings(l,b.style,b.allowOverride,b.getInheritedStyle()),this.demoNodeStyle=b,this.updateNodeDemoImg();const T=e=>{D.empty();const t=this.plugin.linkStyles[e];this.linkSettings(D,t.style,t.allowOverride,t.getInheritedStyle()),this.demoLinkStyle=t,this.updateLinkDemoImg()},L=a.createDiv({cls:"setting-item"}),A=L.createDiv({cls:"setting-item-info"});v=new s.DropdownComponent(A),L.createDiv({text:"Show inherited",cls:"setting-item-name"}).style.marginRight="10px",f=new s.ToggleComponent(L),f.setValue(!0).setTooltip("Show/Hide Inherited Properties").onChange((e=>{m?m=!1:(e?O("excalibrain-hide-disabled"):I("excalibrain-hide-disabled",N),m=!0,E.setValue(e))})),Object.entries(this.plugin.linkStyles).forEach((e=>{v.addOption(e[0],e[1].display)})),this.demoLinkImg=a.createEl("img",{cls:"excalibrain-settings-demoimg"}),D=a.createDiv({cls:"excalibrain-setting-nodestyle-section"}),v.setValue("base").onChange(T);const C=this.plugin.linkStyles.base;this.linkSettings(D,C.style,C.allowOverride,C.getInheritedStyle()),this.demoLinkStyle=C,this.updateLinkDemoImg(),h=()=>{const e=this.plugin.settings.hierarchyLinkStyles,t=this.plugin.linkStyles;Object.keys(t).forEach((i=>{this.hierarchyStyleList.contains(i)||(delete t[i],delete e[i])})),this.hierarchyStyleList.forEach((i=>{Object.keys(e).contains(i)||(e[i]={},t[i]={style:e[i],allowOverride:!0,userStyle:!0,display:i,getInheritedStyle:()=>this.plugin.settings.baseLinkStyle})}));const i=v.getValue();for(let e=v.selectEl.options.length-1;e>=0;e--)v.selectEl.remove(e);Object.entries(t).forEach((e=>{v.addOption(e[0],e[1].display)})),t[i]?v.setValue(i):(v.setValue("base"),T("base"))},h()}}var A={};Object.defineProperty(A,"__esModule",{value:!0});var C=A.getAPI=e=>{var t;return e?null===(t=e.plugins.plugins.dataview)||void 0===t?void 0:t.api:window.DataviewAPI};A.isPluginEnabled=e=>e.plugins.enabledPlugins.has("dataview");const k=(e,t,i)=>{const s=e.metadataCache.getFirstLinkpathDest(t,i);return s?s.path:t},F=(e,t,i)=>{const s=[],n=new Set;return i.forEach((i=>{i=i.toLowerCase().replaceAll(" ","-"),t[i]&&!n.has(i)&&(n.add(i),((e,t,i)=>{const s=new Set;if(t.values)return t.values.forEach((t=>{if("file"===t.type||"header"===t.type){const n=k(e,t.path,i.path);n&&s.add(n)}})),Array.from(s);if(t.path){const s=k(e,t.path,i.path);return s?[s]:[]}const n=t.matchAll(/[^[]*\[\[([^#\]\|]*)[^\]]*]]/g);let a;for(;!(a=n.next()).done;)if(a.value[1]){const t=k(e,a.value[1],i.path);t&&s.add(t)}return Array.from(s)})(e.app,t[i],t.file).forEach((e=>s.push({link:e,field:i}))))})),s};class _{constructor(e){this.pages=new Map,this.forEach=this.pages.forEach.bind(this.pages),this.app=e.app,this.plugin=e}add(e,t){this.pages.set(e,t)}get(e){return this.pages.get(e)}get size(){return this.pages.size}delete(e){const t=this.pages.get(e);t&&(t.neighbours.forEach(((t,i)=>{const s=this.pages.get(i);s&&(s.unlinkNeighbour(e),s.file||0!==s.neighbours.size||this.pages.delete(i))})),this.pages.delete(e))}addWithConnections(t){var s,n;const a=new d(t.path,t,this.plugin);this.add(t.path,a);const r=new Set(Object.keys(null!==(n=null===(s=app.metadataCache.getBacklinksForFile(t))||void 0===s?void 0:s.data)&&void 0!==n?n:{}).map((e=>{var i,s;return null!==(s=null===(i=app.metadataCache.getFirstLinkpathDest(e,t.path))||void 0===i?void 0:i.path)&&void 0!==s?s:e})));r.forEach((t=>{const s=this.pages.get(t);t?(s.addChild(a,e.INFERRED,i.TO),a.addParent(s,e.INFERRED,i.FROM)):u(`Unexpected: ${a.file.path} is referenced from ${t} as backlink in metadataCache, but page for ${t} has not yet been registered in ExcaliBrain index.`)})),this.addUnresolvedLinks(a),this.addResolvedLinks(a),this.addDVFieldLinksToPage(a)}addResolvedLinks(t){const s=this.app.metadataCache.resolvedLinks;Object.keys(s).forEach((n=>{if(t&&t.path!==n)return;const a=this.pages.get(n);Object.keys(s[n]).forEach((t=>{const s=this.pages.get(t);s.addParent(a,e.INFERRED,i.TO),a.addChild(s,e.INFERRED,i.FROM)}))}))}addUnresolvedLinks(t){const s=this.app.metadataCache.unresolvedLinks;Object.keys(s).forEach((n=>{if(t&&t.path!==n)return;const a=this.pages.get(n);Object.keys(s[n]).forEach((t=>{const s=new d(t,null,this.plugin);s.addParent(a,e.INFERRED,i.TO),a.addChild(s,e.INFERRED,i.FROM),this.add(t,s)}))}))}addDVFieldLinksToPage(t){const s=this.plugin.DVAPI.page(t.file.path);if(!s)return;t.dvPage=s;const n=this.plugin.settings.hierarchy.parents;F(this.plugin,s,n).forEach((s=>{const n=this.pages.get(s.link);n?(t.addParent(n,e.DEFINED,i.FROM,s.field),n.addChild(t,e.DEFINED,i.TO,s.field)):u(`Unexpected: ${t.file.path} references ${s.link} in DV, but it was not found in app.metadataCache. The page was skipped.`)}));const a=this.plugin.settings.hierarchy.children;F(this.plugin,s,a).forEach((s=>{const n=this.pages.get(s.link);n?(t.addChild(n,e.DEFINED,i.FROM,s.field),n.addParent(t,e.DEFINED,i.TO,s.field)):u(`Unexpected: ${t.file.path} references ${s.link} in DV, but it was not found in app.metadataCache. The page was skipped.`)}));const r=this.plugin.settings.hierarchy.friends;F(this.plugin,s,r).forEach((s=>{const n=this.pages.get(s.link);n?(t.addFriend(n,e.DEFINED,i.FROM,s.field),n.addFriend(t,e.DEFINED,i.TO,s.field)):u(`Unexpected: ${t.file.path} references ${s.link} in DV, but it was not found in app.metadataCache. The page was skipped.`)}))}}const R=`---\n\nexcalidraw-plugin: parsed\nexcalidraw-default-mode: view\nexcalidraw-export-dark: false\nexcalidraw-export-transparent: false\nexcalidraw-linkbutton-opacity: 0.3\nexcalidraw-onload-script: "app.plugins.plugins[${String.fromCharCode(96)}excalibrain${String.fromCharCode(96)}].start(ea.targetView.leaf);"\n\ntags: [excalidraw]\n\n---\n\n# Text Elements\nOpen a document in another pane and click it to get started.\n\nFor the best experience enable 'Open in adjacent pane'\nin Excalidraw settings under 'Links and Transclusion'. ^4mylk7KK\n\n%%\n# Drawing\n${String.fromCharCode(96,96,96)}json\n{\n\t"type": "excalidraw",\n\t"version": 2,\n\t"source": "https://excalidraw.com",\n\t"elements": [\n\t\t{\n\t\t\t"type": "text",\n\t\t\t"version": 1,\n\t\t\t"versionNonce": 423577018,\n\t\t\t"isDeleted": false,\n\t\t\t"id": "4mylk7KK",\n\t\t\t"fillStyle": "hachure",\n\t\t\t"strokeWidth": 1,\n\t\t\t"strokeStyle": "solid",\n\t\t\t"roughness": 1,\n\t\t\t"opacity": 100,\n\t\t\t"angle": 0,\n\t\t\t"x": 0,\n\t\t\t"y": 0,\n\t\t\t"strokeColor": "white",\n\t\t\t"backgroundColor": "transparent",\n\t\t\t"width": 703,\n\t\t\t"height": 96,\n\t\t\t"seed": 4429,\n\t\t\t"groupIds": [],\n\t\t\t"strokeSharpness": "sharp",\n\t\t\t"boundElements": [],\n\t\t\t"updated": 1650784785611,\n\t\t\t"link": null,\n\t\t\t"locked": false,\n\t\t\t"fontSize": 20,\n\t\t\t"fontFamily": 3,\n\t\t\t"text": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'.",\n\t\t\t"rawText": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'.",\n\t\t\t"baseline": 91,\n\t\t\t"textAlign": "center",\n\t\t\t"verticalAlign": "top",\n\t\t\t"containerId": null,\n\t\t\t"originalText": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'."\n\t\t}\n\t],\n\t"appState": {\n\t\t"theme": "dark",\n\t\t"viewBackgroundColor": "hsl(208, 80%, 23%)",\n\t\t"currentItemStrokeColor": "#000000",\n\t\t"currentItemBackgroundColor": "transparent",\n\t\t"currentItemFillStyle": "hachure",\n\t\t"currentItemStrokeWidth": 2,\n\t\t"currentItemStrokeStyle": "solid",\n\t\t"currentItemRoughness": 1,\n\t\t"currentItemOpacity": 100,\n\t\t"currentItemFontFamily": 1,\n\t\t"currentItemFontSize": 16,\n\t\t"currentItemTextAlign": "left",\n\t\t"currentItemStrokeSharpness": "sharp",\n\t\t"currentItemStartArrowhead": null,\n\t\t"currentItemEndArrowhead": "arrow",\n\t\t"currentItemLinearStrokeSharpness": "round",\n\t\t"gridSize": null,\n\t\t"colorPalette": {}\n\t},\n\t"files": {}\n}\n${String.fromCharCode(96,96,96)}\n%%\n`;class H{constructor(e){this.nodes=[],this.renderedNodes=[],this.spec=e}layout(e=this.spec.columns){const t=this.nodes.sort(((e,t)=>e.title.toLowerCase()<t.title.toLowerCase()?-1:1)),i=t.length;if(0===i)return;const s=Math.ceil(i/e);this.renderedNodes=Array(s).fill(null).map(((n,a)=>{return a+1<s||i%e==0?Array(e).fill(null).map(((i,s)=>t[a*e+s])):(r=i%e,(e=>{const t=[];let i=1,s=!0;return e.map((e=>Math.floor(e))).forEach((e=>{for(let n=0;n<e;n++)t.push(s?null:i++);s=!s})),t})(r%2?[(e-r)/2,r,(e-r)/2]:[(e-r)/2,r/2,1,r/2,(e-r)/2])).map((i=>i?t[a*e+i-1]:null));var r}))}render(){this.layout();const e=this.renderedNodes.length*this.spec.rowHeight,t=null===this.spec.top&&null===this.spec.bottom?this.spec.origoY-e/2:null!==this.spec.top?this.spec.origoY-e/2<this.spec.top?this.spec.top:this.spec.origoY-e/2:this.spec.origoY+e/2>this.spec.bottom?this.spec.bottom-e:this.spec.origoY-e/2,i=this.spec.origoX-(1===this.spec.columns?0:(this.spec.columns-1)/2*this.spec.columnWidth),s=t;this.renderedNodes.forEach(((e,t)=>e.forEach(((e,n)=>{e&&(e.setCenter({x:i+n*this.spec.columnWidth,y:s+t*this.spec.rowHeight}),e.render())}))))}}class P{constructor(e){this.plugin=e,this.links=new Map,this.reverseLinks=new Set}addLink(e,s,n,a,r,o,l,d){const h=e.page.path+"|:?:|"+s.page.path;if(this.links.has(h)||this.reverseLinks.has(h))return;const c=s.page.path+"|:?:|"+e.page.path,p=new v(o===i.FROM?s:e,o===i.FROM?e:s,o===i.FROM?n===t.FRIEND?t.FRIEND:n===t.CHILD?t.PARENT:t.CHILD:n,a,r,l,d,this.plugin);this.links.set(h,p),this.reverseLinks.add(c)}render(){this.links.forEach((e=>e.render()))}}class V{constructor(e,t,i,s,n){this.getVal=t,this.button=s.createEl("button",{cls:"excalibrain-button"}),this.button.createSpan({text:n.display}),this.button.ariaLabel=n.tooltip,this.setColor(),this.button.onclick=()=>{var s;i(!t()),e.saveSettings(),this.setColor(),null===(s=e.scene)||void 0===s||s.reRender()}}setColor(){if(this.getVal())return this.button.removeClass("off"),void this.button.addClass("on");this.button.removeClass("on"),this.button.addClass("off")}}var M="top",Y="bottom",B="right",W="left",j=[M,Y,B,W],G=j.reduce((function(e,t){return e.concat([t+"-start",t+"-end"])}),[]),U=[].concat(j,["auto"]).reduce((function(e,t){return e.concat([t,t+"-start",t+"-end"])}),[]),z=["beforeRead","read","afterRead","beforeMain","main","afterMain","beforeWrite","write","afterWrite"];function X(e){return e?(e.nodeName||"").toLowerCase():null}function K(e){if(null==e)return window;if("[object Window]"!==e.toString()){var t=e.ownerDocument;return t&&t.defaultView||window}return e}function $(e){return e instanceof K(e).Element||e instanceof Element}function q(e){return e instanceof K(e).HTMLElement||e instanceof HTMLElement}function J(e){return"undefined"!=typeof ShadowRoot&&(e instanceof K(e).ShadowRoot||e instanceof ShadowRoot)}var Z={name:"applyStyles",enabled:!0,phase:"write",fn:function(e){var t=e.state;Object.keys(t.elements).forEach((function(e){var i=t.styles[e]||{},s=t.attributes[e]||{},n=t.elements[e];q(n)&&X(n)&&(Object.assign(n.style,i),Object.keys(s).forEach((function(e){var t=s[e];!1===t?n.removeAttribute(e):n.setAttribute(e,!0===t?"":t)})))}))},effect:function(e){var t=e.state,i={popper:{position:t.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(t.elements.popper.style,i.popper),t.styles=i,t.elements.arrow&&Object.assign(t.elements.arrow.style,i.arrow),function(){Object.keys(t.elements).forEach((function(e){var s=t.elements[e],n=t.attributes[e]||{},a=Object.keys(t.styles.hasOwnProperty(e)?t.styles[e]:i[e]).reduce((function(e,t){return e[t]="",e}),{});q(s)&&X(s)&&(Object.assign(s.style,a),Object.keys(n).forEach((function(e){s.removeAttribute(e)})))}))}},requires:["computeStyles"]};function Q(e){return e.split("-")[0]}var ee=Math.max,te=Math.min,ie=Math.round;function se(e,t){void 0===t&&(t=!1);var i=e.getBoundingClientRect(),s=1,n=1;if(q(e)&&t){var a=e.offsetHeight,r=e.offsetWidth;r>0&&(s=ie(i.width)/r||1),a>0&&(n=ie(i.height)/a||1)}return{width:i.width/s,height:i.height/n,top:i.top/n,right:i.right/s,bottom:i.bottom/n,left:i.left/s,x:i.left/s,y:i.top/n}}function ne(e){var t=se(e),i=e.offsetWidth,s=e.offsetHeight;return Math.abs(t.width-i)<=1&&(i=t.width),Math.abs(t.height-s)<=1&&(s=t.height),{x:e.offsetLeft,y:e.offsetTop,width:i,height:s}}function ae(e,t){var i=t.getRootNode&&t.getRootNode();if(e.contains(t))return!0;if(i&&J(i)){var s=t;do{if(s&&e.isSameNode(s))return!0;s=s.parentNode||s.host}while(s)}return!1}function re(e){return K(e).getComputedStyle(e)}function oe(e){return["table","td","th"].indexOf(X(e))>=0}function le(e){return(($(e)?e.ownerDocument:e.document)||window.document).documentElement}function de(e){return"html"===X(e)?e:e.assignedSlot||e.parentNode||(J(e)?e.host:null)||le(e)}function he(e){return q(e)&&"fixed"!==re(e).position?e.offsetParent:null}function ce(e){for(var t=K(e),i=he(e);i&&oe(i)&&"static"===re(i).position;)i=he(i);return i&&("html"===X(i)||"body"===X(i)&&"static"===re(i).position)?t:i||function(e){var t=-1!==navigator.userAgent.toLowerCase().indexOf("firefox");if(-1!==navigator.userAgent.indexOf("Trident")&&q(e)&&"fixed"===re(e).position)return null;var i=de(e);for(J(i)&&(i=i.host);q(i)&&["html","body"].indexOf(X(i))<0;){var s=re(i);if("none"!==s.transform||"none"!==s.perspective||"paint"===s.contain||-1!==["transform","perspective"].indexOf(s.willChange)||t&&"filter"===s.willChange||t&&s.filter&&"none"!==s.filter)return i;i=i.parentNode}return null}(e)||t}function pe(e){return["top","bottom"].indexOf(e)>=0?"x":"y"}function ge(e,t,i){return ee(e,te(t,i))}function ue(e){return Object.assign({},{top:0,right:0,bottom:0,left:0},e)}function fe(e,t){return t.reduce((function(t,i){return t[i]=e,t}),{})}var me={name:"arrow",enabled:!0,phase:"main",fn:function(e){var t,i=e.state,s=e.name,n=e.options,a=i.elements.arrow,r=i.modifiersData.popperOffsets,o=Q(i.placement),l=pe(o),d=[W,B].indexOf(o)>=0?"height":"width";if(a&&r){var h=function(e,t){return ue("number"!=typeof(e="function"==typeof e?e(Object.assign({},t.rects,{placement:t.placement})):e)?e:fe(e,j))}(n.padding,i),c=ne(a),p="y"===l?M:W,g="y"===l?Y:B,u=i.rects.reference[d]+i.rects.reference[l]-r[l]-i.rects.popper[d],f=r[l]-i.rects.reference[l],m=ce(a),E=m?"y"===l?m.clientHeight||0:m.clientWidth||0:0,y=u/2-f/2,S=h[p],b=E-c[d]-h[g],w=E/2-c[d]/2+y,v=ge(S,w,b),D=l;i.modifiersData[s]=((t={})[D]=v,t.centerOffset=v-w,t)}},effect:function(e){var t=e.state,i=e.options.element,s=void 0===i?"[data-popper-arrow]":i;null!=s&&("string"!=typeof s||(s=t.elements.popper.querySelector(s)))&&ae(t.elements.popper,s)&&(t.elements.arrow=s)},requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function Ee(e){return e.split("-")[1]}var ye={top:"auto",right:"auto",bottom:"auto",left:"auto"};function Se(e){var t,i=e.popper,s=e.popperRect,n=e.placement,a=e.variation,r=e.offsets,o=e.position,l=e.gpuAcceleration,d=e.adaptive,h=e.roundOffsets,c=e.isFixed,p=r.x,g=void 0===p?0:p,u=r.y,f=void 0===u?0:u,m="function"==typeof h?h({x:g,y:f}):{x:g,y:f};g=m.x,f=m.y;var E=r.hasOwnProperty("x"),y=r.hasOwnProperty("y"),S=W,b=M,w=window;if(d){var v=ce(i),D="clientHeight",N="clientWidth";v===K(i)&&"static"!==re(v=le(i)).position&&"absolute"===o&&(D="scrollHeight",N="scrollWidth"),v=v,(n===M||(n===W||n===B)&&"end"===a)&&(b=Y,f-=(c&&v===w&&w.visualViewport?w.visualViewport.height:v[D])-s.height,f*=l?1:-1),n!==W&&(n!==M&&n!==Y||"end"!==a)||(S=B,g-=(c&&v===w&&w.visualViewport?w.visualViewport.width:v[N])-s.width,g*=l?1:-1)}var T,x=Object.assign({position:o},d&&ye),O=!0===h?function(e){var t=e.x,i=e.y,s=window.devicePixelRatio||1;return{x:ie(t*s)/s||0,y:ie(i*s)/s||0}}({x:g,y:f}):{x:g,y:f};return g=O.x,f=O.y,l?Object.assign({},x,((T={})[b]=y?"0":"",T[S]=E?"0":"",T.transform=(w.devicePixelRatio||1)<=1?"translate("+g+"px, "+f+"px)":"translate3d("+g+"px, "+f+"px, 0)",T)):Object.assign({},x,((t={})[b]=y?f+"px":"",t[S]=E?g+"px":"",t.transform="",t))}var be={passive:!0},we={left:"right",right:"left",bottom:"top",top:"bottom"};function ve(e){return e.replace(/left|right|bottom|top/g,(function(e){return we[e]}))}var De={start:"end",end:"start"};function Ne(e){return e.replace(/start|end/g,(function(e){return De[e]}))}function Te(e){var t=K(e);return{scrollLeft:t.pageXOffset,scrollTop:t.pageYOffset}}function xe(e){return se(le(e)).left+Te(e).scrollLeft}function Oe(e){var t=re(e),i=t.overflow,s=t.overflowX,n=t.overflowY;return/auto|scroll|overlay|hidden/.test(i+n+s)}function Ie(e){return["html","body","#document"].indexOf(X(e))>=0?e.ownerDocument.body:q(e)&&Oe(e)?e:Ie(de(e))}function Le(e,t){var i;void 0===t&&(t=[]);var s=Ie(e),n=s===(null==(i=e.ownerDocument)?void 0:i.body),a=K(s),r=n?[a].concat(a.visualViewport||[],Oe(s)?s:[]):s,o=t.concat(r);return n?o:o.concat(Le(de(r)))}function Ae(e){return Object.assign({},e,{left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height})}function Ce(e,t){return"viewport"===t?Ae(function(e){var t=K(e),i=le(e),s=t.visualViewport,n=i.clientWidth,a=i.clientHeight,r=0,o=0;return s&&(n=s.width,a=s.height,/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(r=s.offsetLeft,o=s.offsetTop)),{width:n,height:a,x:r+xe(e),y:o}}(e)):$(t)?function(e){var t=se(e);return t.top=t.top+e.clientTop,t.left=t.left+e.clientLeft,t.bottom=t.top+e.clientHeight,t.right=t.left+e.clientWidth,t.width=e.clientWidth,t.height=e.clientHeight,t.x=t.left,t.y=t.top,t}(t):Ae(function(e){var t,i=le(e),s=Te(e),n=null==(t=e.ownerDocument)?void 0:t.body,a=ee(i.scrollWidth,i.clientWidth,n?n.scrollWidth:0,n?n.clientWidth:0),r=ee(i.scrollHeight,i.clientHeight,n?n.scrollHeight:0,n?n.clientHeight:0),o=-s.scrollLeft+xe(e),l=-s.scrollTop;return"rtl"===re(n||i).direction&&(o+=ee(i.clientWidth,n?n.clientWidth:0)-a),{width:a,height:r,x:o,y:l}}(le(e)))}function ke(e){var t,i=e.reference,s=e.element,n=e.placement,a=n?Q(n):null,r=n?Ee(n):null,o=i.x+i.width/2-s.width/2,l=i.y+i.height/2-s.height/2;switch(a){case M:t={x:o,y:i.y-s.height};break;case Y:t={x:o,y:i.y+i.height};break;case B:t={x:i.x+i.width,y:l};break;case W:t={x:i.x-s.width,y:l};break;default:t={x:i.x,y:i.y}}var d=a?pe(a):null;if(null!=d){var h="y"===d?"height":"width";switch(r){case"start":t[d]=t[d]-(i[h]/2-s[h]/2);break;case"end":t[d]=t[d]+(i[h]/2-s[h]/2)}}return t}function Fe(e,t){void 0===t&&(t={});var i=t,s=i.placement,n=void 0===s?e.placement:s,a=i.boundary,r=void 0===a?"clippingParents":a,o=i.rootBoundary,l=void 0===o?"viewport":o,d=i.elementContext,h=void 0===d?"popper":d,c=i.altBoundary,p=void 0!==c&&c,g=i.padding,u=void 0===g?0:g,f=ue("number"!=typeof u?u:fe(u,j)),m="popper"===h?"reference":"popper",E=e.rects.popper,y=e.elements[p?m:h],S=function(e,t,i){var s="clippingParents"===t?function(e){var t=Le(de(e)),i=["absolute","fixed"].indexOf(re(e).position)>=0&&q(e)?ce(e):e;return $(i)?t.filter((function(e){return $(e)&&ae(e,i)&&"body"!==X(e)})):[]}(e):[].concat(t),n=[].concat(s,[i]),a=n[0],r=n.reduce((function(t,i){var s=Ce(e,i);return t.top=ee(s.top,t.top),t.right=te(s.right,t.right),t.bottom=te(s.bottom,t.bottom),t.left=ee(s.left,t.left),t}),Ce(e,a));return r.width=r.right-r.left,r.height=r.bottom-r.top,r.x=r.left,r.y=r.top,r}($(y)?y:y.contextElement||le(e.elements.popper),r,l),b=se(e.elements.reference),w=ke({reference:b,element:E,strategy:"absolute",placement:n}),v=Ae(Object.assign({},E,w)),D="popper"===h?v:b,N={top:S.top-D.top+f.top,bottom:D.bottom-S.bottom+f.bottom,left:S.left-D.left+f.left,right:D.right-S.right+f.right},T=e.modifiersData.offset;if("popper"===h&&T){var x=T[n];Object.keys(N).forEach((function(e){var t=[B,Y].indexOf(e)>=0?1:-1,i=[M,Y].indexOf(e)>=0?"y":"x";N[e]+=x[i]*t}))}return N}var Re={name:"flip",enabled:!0,phase:"main",fn:function(e){var t=e.state,i=e.options,s=e.name;if(!t.modifiersData[s]._skip){for(var n=i.mainAxis,a=void 0===n||n,r=i.altAxis,o=void 0===r||r,l=i.fallbackPlacements,d=i.padding,h=i.boundary,c=i.rootBoundary,p=i.altBoundary,g=i.flipVariations,u=void 0===g||g,f=i.allowedAutoPlacements,m=t.options.placement,E=Q(m),y=l||(E!==m&&u?function(e){if("auto"===Q(e))return[];var t=ve(e);return[Ne(e),t,Ne(t)]}(m):[ve(m)]),S=[m].concat(y).reduce((function(e,i){return e.concat("auto"===Q(i)?function(e,t){void 0===t&&(t={});var i=t,s=i.placement,n=i.boundary,a=i.rootBoundary,r=i.padding,o=i.flipVariations,l=i.allowedAutoPlacements,d=void 0===l?U:l,h=Ee(s),c=h?o?G:G.filter((function(e){return Ee(e)===h})):j,p=c.filter((function(e){return d.indexOf(e)>=0}));0===p.length&&(p=c);var g=p.reduce((function(t,i){return t[i]=Fe(e,{placement:i,boundary:n,rootBoundary:a,padding:r})[Q(i)],t}),{});return Object.keys(g).sort((function(e,t){return g[e]-g[t]}))}(t,{placement:i,boundary:h,rootBoundary:c,padding:d,flipVariations:u,allowedAutoPlacements:f}):i)}),[]),b=t.rects.reference,w=t.rects.popper,v=new Map,D=!0,N=S[0],T=0;T<S.length;T++){var x=S[T],O=Q(x),I="start"===Ee(x),L=[M,Y].indexOf(O)>=0,A=L?"width":"height",C=Fe(t,{placement:x,boundary:h,rootBoundary:c,altBoundary:p,padding:d}),k=L?I?B:W:I?Y:M;b[A]>w[A]&&(k=ve(k));var F=ve(k),_=[];if(a&&_.push(C[O]<=0),o&&_.push(C[k]<=0,C[F]<=0),_.every((function(e){return e}))){N=x,D=!1;break}v.set(x,_)}if(D)for(var R=function(e){var t=S.find((function(t){var i=v.get(t);if(i)return i.slice(0,e).every((function(e){return e}))}));if(t)return N=t,"break"},H=u?3:1;H>0&&"break"!==R(H);H--);t.placement!==N&&(t.modifiersData[s]._skip=!0,t.placement=N,t.reset=!0)}},requiresIfExists:["offset"],data:{_skip:!1}};function He(e,t,i){return void 0===i&&(i={x:0,y:0}),{top:e.top-t.height-i.y,right:e.right-t.width+i.x,bottom:e.bottom-t.height+i.y,left:e.left-t.width-i.x}}function Pe(e){return[M,B,Y,W].some((function(t){return e[t]>=0}))}function Ve(e,t,i){void 0===i&&(i=!1);var s,n,a=q(t),r=q(t)&&function(e){var t=e.getBoundingClientRect(),i=ie(t.width)/e.offsetWidth||1,s=ie(t.height)/e.offsetHeight||1;return 1!==i||1!==s}(t),o=le(t),l=se(e,r),d={scrollLeft:0,scrollTop:0},h={x:0,y:0};return(a||!a&&!i)&&(("body"!==X(t)||Oe(o))&&(d=(s=t)!==K(s)&&q(s)?{scrollLeft:(n=s).scrollLeft,scrollTop:n.scrollTop}:Te(s)),q(t)?((h=se(t,!0)).x+=t.clientLeft,h.y+=t.clientTop):o&&(h.x=xe(o))),{x:l.left+d.scrollLeft-h.x,y:l.top+d.scrollTop-h.y,width:l.width,height:l.height}}function Me(e){var t=new Map,i=new Set,s=[];function n(e){i.add(e.name),[].concat(e.requires||[],e.requiresIfExists||[]).forEach((function(e){if(!i.has(e)){var s=t.get(e);s&&n(s)}})),s.push(e)}return e.forEach((function(e){t.set(e.name,e)})),e.forEach((function(e){i.has(e.name)||n(e)})),s}var Ye={placement:"bottom",modifiers:[],strategy:"absolute"};function Be(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return!t.some((function(e){return!(e&&"function"==typeof e.getBoundingClientRect)}))}var je,Ge=function(e){void 0===e&&(e={});var t=e,i=t.defaultModifiers,s=void 0===i?[]:i,n=t.defaultOptions,a=void 0===n?Ye:n;return function(e,t,i){void 0===i&&(i=a);var n,r,o={placement:"bottom",orderedModifiers:[],options:Object.assign({},Ye,a),modifiersData:{},elements:{reference:e,popper:t},attributes:{},styles:{}},l=[],d=!1,h={state:o,setOptions:function(i){var n="function"==typeof i?i(o.options):i;c(),o.options=Object.assign({},a,o.options,n),o.scrollParents={reference:$(e)?Le(e):e.contextElement?Le(e.contextElement):[],popper:Le(t)};var r,d,p=function(e){var t=Me(e);return z.reduce((function(e,i){return e.concat(t.filter((function(e){return e.phase===i})))}),[])}((r=[].concat(s,o.options.modifiers),d=r.reduce((function(e,t){var i=e[t.name];return e[t.name]=i?Object.assign({},i,t,{options:Object.assign({},i.options,t.options),data:Object.assign({},i.data,t.data)}):t,e}),{}),Object.keys(d).map((function(e){return d[e]}))));return o.orderedModifiers=p.filter((function(e){return e.enabled})),o.orderedModifiers.forEach((function(e){var t=e.name,i=e.options,s=void 0===i?{}:i,n=e.effect;if("function"==typeof n){var a=n({state:o,name:t,instance:h,options:s});l.push(a||function(){})}})),h.update()},forceUpdate:function(){if(!d){var e=o.elements,t=e.reference,i=e.popper;if(Be(t,i)){o.rects={reference:Ve(t,ce(i),"fixed"===o.options.strategy),popper:ne(i)},o.reset=!1,o.placement=o.options.placement,o.orderedModifiers.forEach((function(e){return o.modifiersData[e.name]=Object.assign({},e.data)}));for(var s=0;s<o.orderedModifiers.length;s++)if(!0!==o.reset){var n=o.orderedModifiers[s],a=n.fn,r=n.options,l=void 0===r?{}:r,c=n.name;"function"==typeof a&&(o=a({state:o,options:l,name:c,instance:h})||o)}else o.reset=!1,s=-1}}},update:(n=function(){return new Promise((function(e){h.forceUpdate(),e(o)}))},function(){return r||(r=new Promise((function(e){Promise.resolve().then((function(){r=void 0,e(n())}))}))),r}),destroy:function(){c(),d=!0}};if(!Be(e,t))return h;function c(){l.forEach((function(e){return e()})),l=[]}return h.setOptions(i).then((function(e){!d&&i.onFirstUpdate&&i.onFirstUpdate(e)})),h}}({defaultModifiers:[{name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect:function(e){var t=e.state,i=e.instance,s=e.options,n=s.scroll,a=void 0===n||n,r=s.resize,o=void 0===r||r,l=K(t.elements.popper),d=[].concat(t.scrollParents.reference,t.scrollParents.popper);return a&&d.forEach((function(e){e.addEventListener("scroll",i.update,be)})),o&&l.addEventListener("resize",i.update,be),function(){a&&d.forEach((function(e){e.removeEventListener("scroll",i.update,be)})),o&&l.removeEventListener("resize",i.update,be)}},data:{}},{name:"popperOffsets",enabled:!0,phase:"read",fn:function(e){var t=e.state,i=e.name;t.modifiersData[i]=ke({reference:t.rects.reference,element:t.rects.popper,strategy:"absolute",placement:t.placement})},data:{}},{name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:function(e){var t=e.state,i=e.options,s=i.gpuAcceleration,n=void 0===s||s,a=i.adaptive,r=void 0===a||a,o=i.roundOffsets,l=void 0===o||o,d={placement:Q(t.placement),variation:Ee(t.placement),popper:t.elements.popper,popperRect:t.rects.popper,gpuAcceleration:n,isFixed:"fixed"===t.options.strategy};null!=t.modifiersData.popperOffsets&&(t.styles.popper=Object.assign({},t.styles.popper,Se(Object.assign({},d,{offsets:t.modifiersData.popperOffsets,position:t.options.strategy,adaptive:r,roundOffsets:l})))),null!=t.modifiersData.arrow&&(t.styles.arrow=Object.assign({},t.styles.arrow,Se(Object.assign({},d,{offsets:t.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:l})))),t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-placement":t.placement})},data:{}},Z,{name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:function(e){var t=e.state,i=e.options,s=e.name,n=i.offset,a=void 0===n?[0,0]:n,r=U.reduce((function(e,i){return e[i]=function(e,t,i){var s=Q(e),n=[W,M].indexOf(s)>=0?-1:1,a="function"==typeof i?i(Object.assign({},t,{placement:e})):i,r=a[0],o=a[1];return r=r||0,o=(o||0)*n,[W,B].indexOf(s)>=0?{x:o,y:r}:{x:r,y:o}}(i,t.rects,a),e}),{}),o=r[t.placement],l=o.x,d=o.y;null!=t.modifiersData.popperOffsets&&(t.modifiersData.popperOffsets.x+=l,t.modifiersData.popperOffsets.y+=d),t.modifiersData[s]=r}},Re,{name:"preventOverflow",enabled:!0,phase:"main",fn:function(e){var t=e.state,i=e.options,s=e.name,n=i.mainAxis,a=void 0===n||n,r=i.altAxis,o=void 0!==r&&r,l=i.boundary,d=i.rootBoundary,h=i.altBoundary,c=i.padding,p=i.tether,g=void 0===p||p,u=i.tetherOffset,f=void 0===u?0:u,m=Fe(t,{boundary:l,rootBoundary:d,padding:c,altBoundary:h}),E=Q(t.placement),y=Ee(t.placement),S=!y,b=pe(E),w="x"===b?"y":"x",v=t.modifiersData.popperOffsets,D=t.rects.reference,N=t.rects.popper,T="function"==typeof f?f(Object.assign({},t.rects,{placement:t.placement})):f,x="number"==typeof T?{mainAxis:T,altAxis:T}:Object.assign({mainAxis:0,altAxis:0},T),O=t.modifiersData.offset?t.modifiersData.offset[t.placement]:null,I={x:0,y:0};if(v){if(a){var L,A="y"===b?M:W,C="y"===b?Y:B,k="y"===b?"height":"width",F=v[b],_=F+m[A],R=F-m[C],H=g?-N[k]/2:0,P="start"===y?D[k]:N[k],V="start"===y?-N[k]:-D[k],j=t.elements.arrow,G=g&&j?ne(j):{width:0,height:0},U=t.modifiersData["arrow#persistent"]?t.modifiersData["arrow#persistent"].padding:{top:0,right:0,bottom:0,left:0},z=U[A],X=U[C],K=ge(0,D[k],G[k]),$=S?D[k]/2-H-K-z-x.mainAxis:P-K-z-x.mainAxis,q=S?-D[k]/2+H+K+X+x.mainAxis:V+K+X+x.mainAxis,J=t.elements.arrow&&ce(t.elements.arrow),Z=J?"y"===b?J.clientTop||0:J.clientLeft||0:0,ie=null!=(L=null==O?void 0:O[b])?L:0,se=F+q-ie,ae=ge(g?te(_,F+$-ie-Z):_,F,g?ee(R,se):R);v[b]=ae,I[b]=ae-F}if(o){var re,oe="x"===b?M:W,le="x"===b?Y:B,de=v[w],he="y"===w?"height":"width",ue=de+m[oe],fe=de-m[le],me=-1!==[M,W].indexOf(E),ye=null!=(re=null==O?void 0:O[w])?re:0,Se=me?ue:de-D[he]-N[he]-ye+x.altAxis,be=me?de+D[he]+N[he]-ye-x.altAxis:fe,we=g&&me?function(e,t,i){var s=ge(e,t,i);return s>i?i:s}(Se,de,be):ge(g?Se:ue,de,g?be:fe);v[w]=we,I[w]=we-de}t.modifiersData[s]=I}},requiresIfExists:["offset"]},me,{name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:function(e){var t=e.state,i=e.name,s=t.rects.reference,n=t.rects.popper,a=t.modifiersData.preventOverflow,r=Fe(t,{elementContext:"reference"}),o=Fe(t,{altBoundary:!0}),l=He(r,s),d=He(o,n,a),h=Pe(l),c=Pe(d);t.modifiersData[i]={referenceClippingOffsets:l,popperEscapeOffsets:d,isReferenceHidden:h,hasPopperEscaped:c},t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-reference-hidden":h,"data-popper-escaped":c})}}]});class Ue{constructor(e,t,i,s=30){this.owner=e,this.containerEl=t,this.limit=s,this.owner=e,this.containerEl=t,t.on("click",".suggestion-item",this.onSuggestionClick.bind(this)),t.on("mousemove",".suggestion-item",this.onSuggestionMouseover.bind(this)),i.register([],"ArrowUp",(e=>{if(!e.isComposing)return this.setSelectedItem(this.selectedItem-1,!0),!1})),i.register([],"ArrowDown",(e=>{if(!e.isComposing)return this.setSelectedItem(this.selectedItem+1,!0),!1})),i.register([],"Enter",(e=>{if(!e.isComposing)return this.useSelectedItem(e),!1}))}onSuggestionClick(e,t){e.preventDefault();const i=this.suggestions.indexOf(t);this.setSelectedItem(i,!1),this.useSelectedItem(e)}onSuggestionMouseover(e,t){const i=this.suggestions.indexOf(t);this.setSelectedItem(i,!1)}setSuggestions(e){this.containerEl.empty();const t=[];e.slice(0,this.limit).forEach((e=>{const i=this.containerEl.createDiv("suggestion-item");this.owner.renderSuggestion(e,i),t.push(i)})),this.values=e,this.suggestions=t,this.setSelectedItem(0,!1)}useSelectedItem(e){const t=this.values[this.selectedItem];t&&this.owner.selectSuggestion(t,e)}setSelectedItem(e,t){const i=(e%(s=this.suggestions.length)+s)%s;var s;const n=this.suggestions[this.selectedItem],a=this.suggestions[i];null==n||n.removeClass("is-selected"),null==a||a.addClass("is-selected"),this.selectedItem=i,t&&a.scrollIntoView(!1)}}!function(e){e[e.TemplateFiles=0]="TemplateFiles",e[e.ScriptFiles=1]="ScriptFiles"}(je||(je={}));class ze extends class{constructor(e,t){this.app=e,this.inputEl=t,this.scope=new s.Scope,this.suggestEl=createDiv("suggestion-container");const i=this.suggestEl.createDiv("suggestion");this.suggest=new Ue(this,i,this.scope),this.scope.register([],"Escape",this.close.bind(this)),this.inputEl.addEventListener("input",this.onInputChanged.bind(this)),this.inputEl.addEventListener("focus",this.onInputChanged.bind(this)),this.inputEl.addEventListener("blur",this.close.bind(this)),this.suggestEl.on("mousedown",".suggestion-container",(e=>{e.preventDefault()}))}onInputChanged(){const e=this.inputEl.value,t=this.getSuggestions(e);t&&t.length>0?(this.suggest.setSuggestions(t),this.open(this.app.dom.appContainerEl,this.inputEl)):this.close()}open(e,t){this.app.keymap.pushScope(this.scope),e.appendChild(this.suggestEl),this.popper=Ge(t,this.suggestEl,{placement:"bottom-start",modifiers:[{name:"sameWidth",enabled:!0,fn:({state:e,instance:t})=>{const i=`${e.rects.reference.width}px`;e.styles.popper.width!==i&&(e.styles.popper.width=i,t.update())},phase:"beforeWrite",requires:["computeStyles"]}]})}close(){this.app.keymap.popScope(this.scope),this.suggest.setSuggestions([]),this.popper&&this.popper.destroy(),this.suggestEl.detach()}}{constructor(e,t,i){super(e,t),this.app=e,this.inputEl=t,this.plugin=i}getSuggestions(e){const t=e.toLowerCase();return app.vault.getFiles().filter((e=>(this.plugin.settings.showAttachments||"md"===e.extension)&&e.path.toLowerCase().contains(t)&&!this.plugin.settings.excludeFilepaths.some((t=>e.path.startsWith(t)))))}renderSuggestion(e,t){t.setText(e.path)}selectSuggestion(e){this.inputEl.value=e.path,this.inputEl.trigger("input"),this.close()}}class Xe{constructor(e,t){this.contentEl=e,this.plugin=t,this.buttons=[],e.addClass("excalibrain-contentEl"),this.wrapperDiv=this.contentEl.createDiv({cls:"excalibrain-toolspanel-wrapper"});const i=this.wrapperDiv.createEl("input",{type:"text",cls:"excalibrain-searchinput"});i.ariaLabel=y("SEARCH_IN_VAULT"),i.oninput=()=>{var e;const t=app.vault.getAbstractFileByPath(i.value);t&&t instanceof s.TFile&&(null===(e=this.plugin.scene)||void 0===e||e.renderGraphForFile(i.value),i.value=t.basename)},new ze(this.plugin.app,i,this.plugin);const n=this.wrapperDiv.createDiv({cls:"excalibrain-buttons"}),a=n.createEl("button",{cls:"excalibrain-button",text:"✏"});a.ariaLabel=y("OPEN_DRAWING"),a.onclick=()=>{const e=this.plugin.EA.getExcalidrawAPI().getSceneElements(),t=this.plugin.EA.getExcalidrawAPI().getAppState(),i=this.plugin.EA;i.reset(),i.canvas.viewBackgroundColor=t.viewBackgroundColor,i.canvas.theme="light",e.forEach((e=>i.elementsDict[e.id]=e)),i.create({filename:`ExcaliBrain Snapshot - ${b(this.plugin.scene.centralPagePath).basename}`,onNewPane:!0})},this.buttons.push(new V(this.plugin,(()=>this.plugin.settings.showAttachments),(e=>this.plugin.settings.showAttachments=e),n,{display:"📎",tooltip:y("SHOW_HIDE_ATTACHMENTS")})),this.buttons.push(new V(this.plugin,(()=>this.plugin.settings.showVirtualNodes),(e=>this.plugin.settings.showVirtualNodes=e),n,{display:"∅",tooltip:y("SHOW_HIDE_VIRTUAL")})),this.buttons.push(new V(this.plugin,(()=>this.plugin.settings.showInferredNodes),(e=>this.plugin.settings.showInferredNodes=e),n,{display:"🤔",tooltip:y("SHOW_HIDE_INFERRED")})),this.buttons.push(new V(this.plugin,(()=>this.plugin.settings.renderAlias),(e=>this.plugin.settings.renderAlias=e),n,{display:"🧥",tooltip:y("SHOW_HIDE_ALIAS")})),this.contentEl.appendChild(this.wrapperDiv)}rerender(){this.buttons.forEach((e=>e.setColor()))}terminate(){var e;if(this.wrapperDiv){try{null===(e=this.contentEl)||void 0===e||e.removeChild(this.wrapperDiv)}catch(e){}this.wrapperDiv=null}}}class Ke{constructor(e,t,i){this.disregardLeafChange=!1,this.nodesMap=new Map,this.layouts=[],this.blockUpdateTimer=!1,this.settings=e.settings,this.ea=e.EA,this.plugin=e,this.app=e.app,this.leaf=null!=i?i:app.workspace.getLeaf(t),this.terminated=!1,this.links=new P(e)}async initialize(){await this.initilizeScene(),this.toolsPanel=new Xe(this.leaf.view.contentEl,this.plugin)}isActive(){var e;return!this.terminated&&app.workspace.getLeafById(null===(e=this.leaf)||void 0===e?void 0:e.id)}async reRender(){this.isActive()&&this.centralLeaf&&this.centralPagePath&&(await this.plugin.createIndex(),await this.render(),this.toolsPanel.rerender())}async renderGraphForFile(e){var t;if(!this.isActive())return;this.blockUpdateTimer=!0;const i=this.plugin.pages.get(e);if(!i||!i.file)return void(this.blockUpdateTimer=!1);if(!(null===(t=this.ea.targetView)||void 0===t?void 0:t.file)||this.ea.targetView.file.path!==this.settings.excalibrainFilepath)return void this.unloadScene();if(i.file.path===this.ea.targetView.file.path)return void(this.blockUpdateTimer=!1);const s=this.plugin.pages.get(this.centralPagePath);s&&s.path===e&&i.file.stat.mtime===s.mtime?this.blockUpdateTimer=!1:(this.centralLeaf.openFile(i.file),this.centralPagePath=e,await this.plugin.createIndex(),await this.render())}static async openExcalidrawLeaf(e,t,i){let n=0,a=app.vault.getAbstractFileByPath(t.excalibrainFilepath);if(!a||a instanceof s.TFile){if(!a)for(a=await app.vault.create(t.excalibrainFilepath,R);a instanceof s.TFile&&!e.isExcalidrawFile(a)&&n++<10;)await sleep(50);if(n=0,a&&a instanceof s.TFile&&!e.isExcalidrawFile(a)){for(a=await app.vault.create(t.excalibrainFilepath,R);a instanceof s.TFile&&!e.isExcalidrawFile(a)&&n++<10;)await sleep(50);if(!e.isExcalidrawFile(a))return void new s.Notice(`Couldn't open ${t.excalibrainFilepath}. Please try again later.`)}await(null!=i?i:app.workspace.getLeaf(!0)).openFile(a)}else new s.Notice(`Please check settings. ExcaliBrain path (${t.excalibrainFilepath}) points to a folder, not a file`)}async initilizeScene(){this.disregardLeafChange=!1;const e=this.ea,t=this.settings.baseNodeStyle;let i=0;for(e.clear(),e.setView(this.leaf.view),i=0;!e.targetView.excalidrawAPI&&i++<10;)await sleep(50);e.targetView.excalidrawAPI?(this.ea.registerThisAsViewEA(),this.ea.targetView.semaphores.saving=!0,e.style.fontFamily=t.fontFamily,e.style.fontSize=t.fontSize,this.textSize=e.measureText("m".repeat(t.maxLabelLength+3)),this.nodeWidth=this.textSize.width+3*t.padding,this.nodeHeight=2*(this.textSize.height+2*t.padding),e.getExcalidrawAPI().updateScene({appState:{viewModeEnabled:!0,activeTool:{lastActiveToolBeforeEraser:null,locked:!1,type:"selection"},theme:"light",viewBackgroundColor:this.settings.backgroundColor},elements:[]}),e.style.strokeColor=t.textColor,e.addText(0,0,"Open a document in another pane and click it to get started.\n\nFor the best experience enable 'Open in adjacent pane'\nin Excalidraw settings under 'Links and Transclusion'.\n\nNote, that ExcaliBrain may need to wait for DataView to initialize its index,\nwhich can take up to a few minutes after starting Obsidian.",{textAlign:"center"}),await e.addElementsToView(),e.getExcalidrawAPI().zoomToFit(null,5),e.targetView.linksAlwaysOpenInANewPane=!0,this.addEventHandler(),new s.Notice("ExcaliBrain On")):new s.Notice("Error initializing Excalidraw view")}addNodes(t){t.neighbours.forEach((i=>{if(i.page.path===this.ea.targetView.file.path)return;const s=new w({page:i.page,isInferred:i.relationType===e.INFERRED,isCentral:t.isCentral,isSibling:t.isSibling,friendGateOnLeft:t.friendGateOnLeft});this.nodesMap.set(i.page.path,s),t.layout.nodes.push(s)}))}async render(){this.ea.clear(),this.ea.getExcalidrawAPI().updateScene({elements:[]}),this.ea.style.verticalAlign="middle";const e=this.plugin.pages.get(this.centralPagePath),i=e.getParents().filter((t=>t.page.path!==e.path&&!this.plugin.settings.excludeFilepaths.some((e=>t.page.path.startsWith(e))))).slice(0,this.plugin.settings.maxItemCount),s=e.getChildren().filter((t=>t.page.path!==e.path&&!this.plugin.settings.excludeFilepaths.some((e=>t.page.path.startsWith(e))))).slice(0,this.plugin.settings.maxItemCount),n=e.getFriends().filter((t=>t.page.path!==e.path&&!this.plugin.settings.excludeFilepaths.some((e=>t.page.path.startsWith(e))))).slice(0,this.plugin.settings.maxItemCount),a=e.getSiblings().filter((t=>!(i.some((e=>e.page.path===t.page.path))||s.some((e=>e.page.path===t.page.path))||n.some((e=>e.page.path===t.page.path))||this.plugin.settings.excludeFilepaths.some((e=>t.page.path.startsWith(e))))&&t.page.path!==e.path)).slice(0,this.plugin.settings.maxItemCount);this.nodesMap=new Map,this.links=new P(this.plugin),this.layouts=[];const r=s.length>10,o=a.length>10,l=i.length<=1,d=new H({origoX:0,origoY:0,top:null,bottom:null,columns:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(d);const h=new H({origoX:0,origoY:2.5*this.nodeHeight,top:2*this.nodeHeight,bottom:null,columns:r?5:3,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(h);const c=new H({origoX:(r?-3:-2)*this.nodeWidth,origoY:0,top:null,bottom:null,columns:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(c);const p=new H({origoX:0,origoY:-2.5*this.nodeHeight,top:null,bottom:-2*this.nodeHeight,columns:3,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(p);const g=new H({origoX:this.nodeWidth*((l?0:1)+(o?2:1)),origoY:-2.5*this.nodeHeight,top:null,bottom:this.nodeHeight,columns:o?3:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(g);const u=new w({page:e,isInferred:!1,isCentral:!0,isSibling:!1,friendGateOnLeft:!0});this.nodesMap.set(e.path,u),d.nodes.push(u),this.addNodes({neighbours:i,layout:p,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.addNodes({neighbours:s,layout:h,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.addNodes({neighbours:n,layout:c,isCentral:!1,isSibling:!1,friendGateOnLeft:!1}),this.addNodes({neighbours:a,layout:g,isCentral:!1,isSibling:!0,friendGateOnLeft:!0});const f=(e,t,i)=>{t.forEach((t=>{const s=this.nodesMap.get(t.page.path);s&&this.links.addLink(e,s,i,t.relationType,t.typeDefinition,t.linkDirection,this.ea,this.settings)}))};Array.from(this.nodesMap.values()).forEach((e=>{f(e,e.page.getChildren(),t.CHILD),f(e,e.page.getParents(),t.PARENT),f(e,e.page.getFriends(),t.FRIEND)})),this.layouts.forEach((e=>e.render())),this.links.render();const m=this.ea.getElements();this.ea.getExcalidrawAPI().updateScene({elements:m.filter((e=>"arrow"===e.type)).concat(m.filter((e=>"arrow"!==e.type)))}),this.ea.getExcalidrawAPI().zoomToFit(null,5),this.blockUpdateTimer=!1}addEventHandler(){const e=this,t=async t=>{var i;if(this.disregardLeafChange)return;if(e.blockUpdateTimer=!0,await e.plugin.createIndex(),!(null===(i=e.ea.targetView)||void 0===i?void 0:i.file)||e.ea.targetView.file.path!==e.settings.excalibrainFilepath)return void e.unloadScene();if(!((null==t?void 0:t.view)&&t.view instanceof s.FileView&&t.view.file))return void(e.blockUpdateTimer=!1);const n=t.view.file;if(n.path===e.ea.targetView.file.path)return void(e.blockUpdateTimer=!1);const a=e.plugin.pages.get(e.centralPagePath);a&&a.path===n.path&&n.stat.mtime===a.mtime?e.blockUpdateTimer=!1:(e.centralPagePath=n.path,e.centralLeaf=t,e.render())};app.workspace.on("active-leaf-change",t),this.removeEH=()=>app.workspace.off("active-leaf-change",t);const i=setInterval((async()=>{if(!this.blockUpdateTimer)for(const e of this.nodesMap.values()){const{file:t,mtime:i}=e.page;if(t&&t.stat.mtime!==i)return await this.plugin.createIndex(),this.centralPagePath=t.path,void this.render()}}),5e3);this.removeTimer=()=>clearInterval(i);const n=[];app.workspace.iterateAllLeaves((e=>{e.view instanceof s.FileView&&e.view.file&&e.view.file.path!==this.ea.targetView.file.path&&n.push(e)})),n.length>0&&t(n[0])}unloadScene(){var e;if(this.removeEH&&(this.removeEH(),this.removeEH=void 0),this.removeTimer&&(this.removeTimer(),this.removeTimer=void 0),this.ea.targetView&&isBoolean(this.ea.targetView.linksAlwaysOpenInANewPane)&&(this.ea.targetView.linksAlwaysOpenInANewPane=!1),this.ea.targetView&&this.ea.targetView.excalidrawAPI)try{this.ea.targetView.semaphores.saving=!1,this.ea.targetView.excalidrawAPI.updateScene({appState:{viewModeEnabled:!1}})}catch(e){}if(this.ea.targetView&&this.ea.targetView._loaded)try{this.ea.deregisterThisAsViewEA()}catch(e){}null===(e=this.toolsPanel)||void 0===e||e.terminate(),this.toolsPanel=void 0,this.ea.targetView=void 0,this.leaf=void 0,this.centralLeaf=void 0,this.centralPagePath=void 0,this.terminated=!0,new s.Notice("Brain Graph Off")}}class $e extends s.Plugin{constructor(e,t){super(e,t),this.scene=null,this.pluginLoaded=!1}async onload(){await this.loadSettings(),this.addSettingTab(new L(this.app,this)),this.app.workspace.onLayoutReady((()=>(this.DVAPI=C(),this.DVAPI?(this.EA=p(),this.EA?this.EA.verifyMinimumPluginVersion("1.6.27")?(this.registerCommands(),this.registerExcalidrawAutomateHooks(),void(this.pluginLoaded=!0)):(new s.Notice(y("EXCALIDRAW_MINAPP_VERSION"),4e3),g({fn:this.onload,where:"main.ts/onload()",message:"ExcaliBrain requires a new version of Excalidraw"}),void this.app.plugins.disablePlugin("excalibrain")):(new s.Notice(y("EXCALIDRAW_NOT_FOUND"),4e3),g({fn:this.onload,where:"main.ts/onload()",message:"Excalidraw not found"}),void this.app.plugins.disablePlugin("excalibrain"))):(new s.Notice(y("DATAVIEW_NOT_FOUND"),4e3),g({fn:this.onload,where:"main.ts/onload()",message:"Dataview not found"}),void this.app.plugins.disablePlugin("excalibrain")))))}async createIndex(){this.pages=new _(this);let e=0;for(;this.app.metadataCache.inProgressTaskCount>0||this.DVAPI.index.importer.reloadQueue.length>0;)e++%100==10&&new s.Notice("ExcaliBrain is waiting for Dataview to update its index",1e3),await sleep(100);for(const e of this.app.vault.getFiles())this.pages.add(e.path,new d(e.path,e,this));this.pages.addUnresolvedLinks(),this.pages.addResolvedLinks(),this.pages.forEach(((e,t)=>{(null==e?void 0:e.file)&&this.pages.addDVFieldLinksToPage(e)}))}registerCommands(){this.addCommand({id:"excalibrain-start",name:y("COMMAND_START"),callback:()=>{if(this.scene&&!this.scene.terminated)this.scene.unloadScene(),this.scene=null;else{const e=this.getBrainLeaf();if(e&&e.view&&e.view.file&&e.view.file.path==this.settings.excalibrainFilepath)return this.scene=new Ke(this,!0,e),void this.scene.initialize();Ke.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,e)}}})}getBrainLeaf(){let e;return app.workspace.iterateAllLeaves((t=>{t.view&&this.EA.isExcalidrawView(t.view)&&t.view.file.path===this.settings.excalibrainFilepath&&(e=t)})),e}registerExcalidrawAutomateHooks(){this.EA.onViewModeChangeHook=e=>{var t;this.EA.targetView&&(null===(t=this.EA.targetView.file)||void 0===t?void 0:t.path)===this.settings.excalibrainFilepath&&(e||this.stop())},this.EA.onLinkHoverHook=(e,t)=>{var i;return!(this.scene&&this.EA.targetView&&(null===(i=this.EA.targetView.file)||void 0===i?void 0:i.path)===this.settings.excalibrainFilepath&&this.EA.targetView.excalidrawAPI&&this.EA.targetView.excalidrawAPI.getAppState().viewModeEnabled&&(this.scene.disregardLeafChange=!0,this.disregardLeafChangeTimer&&clearTimeout(this.disregardLeafChangeTimer),this.disregardLeafChangeTimer=setTimeout((()=>{this.disregardLeafChangeTimer=null,this.scene&&(this.scene.disregardLeafChange=!1)}),1e3),0))},this.EA.onViewUnloadHook=e=>{this.scene&&this.scene.leaf===e.leaf&&this.stop()}}onunload(){this.scene&&(this.scene.unloadScene(),this.scene=null)}setHierarchyLinkStylesExtended(){this.hierarchyLinkStylesExtended={},Object.entries(this.settings.hierarchyLinkStyles).forEach((e=>{const t=e[0].toLowerCase().replaceAll(" ","-");this.hierarchyLinkStylesExtended[e[0]]=e[1],e[0]!==t&&(this.hierarchyLinkStylesExtended[t]=e[1])}))}async loadSettings(){this.settings=Object.assign({},D,await this.loadData()),this.setHierarchyLinkStylesExtended(),this.linkStyles={},this.linkStyles.base={style:this.settings.baseLinkStyle,allowOverride:!1,userStyle:!1,display:y("LINKSTYLE_BASE"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles.inferred={style:this.settings.inferredLinkStyle,allowOverride:!0,userStyle:!1,display:y("LINKSTYLE_INFERRED"),getInheritedStyle:()=>this.settings.baseLinkStyle},Object.entries(this.settings.hierarchyLinkStyles).forEach((e=>{["base","inferred"].contains(e[0])||(this.linkStyles[e[0]]={style:e[1],allowOverride:!0,userStyle:!0,display:e[0],getInheritedStyle:()=>this.settings.baseLinkStyle})})),this.nodeStyles={},this.nodeStyles.base={style:this.settings.baseNodeStyle,allowOverride:!1,userStyle:!1,display:y("NODESTYLE_BASE"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.inferred={style:this.settings.inferredNodeStyle,allowOverride:!0,userStyle:!1,display:y("NODESTYLE_INFERRED"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.virtual={style:this.settings.virtualNodeStyle,allowOverride:!0,userStyle:!1,display:y("NODESTYLE_VIRTUAL"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.central={style:this.settings.centralNodeStyle,allowOverride:!0,userStyle:!1,display:y("NODESTYLE_CENTRAL"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.sibling={style:this.settings.siblingNodeStyle,allowOverride:!0,userStyle:!1,display:y("NODESTYLE_SIBLING"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.attachment={style:this.settings.attachmentNodeStyle,allowOverride:!0,userStyle:!1,display:y("NODESTYLE_ATTACHMENT"),getInheritedStyle:()=>this.settings.baseNodeStyle},Object.entries(this.settings.tagNodeStyles).forEach((e=>{this.nodeStyles[e[0]]={style:e[1],allowOverride:!0,userStyle:!0,display:e[0],getInheritedStyle:()=>this.settings.baseNodeStyle}}))}async saveSettings(){await this.saveData(this.settings)}stop(){this.scene&&!this.scene.terminated&&(this.scene.unloadScene(),this.scene=null)}async start(e){if(!e.view)return;let t=0;for(;!this.pluginLoaded&&t++<100;)await sleep(50);if(!this.pluginLoaded)return new s.Notice("ExcaliBrain plugin did not load - aborting start()"),void g({where:"ExcaliBrain.start()",fn:this.start,message:"ExcaliBrain did not load. Aborting after 5000ms of trying"});this.stop(),e?(this.scene=new Ke(this,!0,e),this.scene.initialize()):await Ke.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,this.getBrainLeaf())}}module.exports=$e;