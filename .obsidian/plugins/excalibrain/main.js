"use strict";var S,M,C,O=require("obsidian");(function(s){s[s.DEFINED=1]="DEFINED",s[s.INFERRED=2]="INFERRED"})(S||(S={})),function(s){s[s.PARENT=0]="PARENT",s[s.CHILD=1]="CHILD",s[s.FRIEND=2]="FRIEND"}(M||(M={})),function(s){s[s.TO=1]="TO",s[s.FROM=2]="FROM",s[s.BOTH=3]="BOTH"}(C||(C={}));var Ne=s=>{console.error(Object.assign({plugin:"ExcaliBrain"},s))},Te=console.log.bind(window.console);console.log.bind(window.console);var Et=s=>`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(s.replaceAll("&nbsp;"," "))))}`;function Jt(s){let e=s.lastIndexOf("/"),t=e==-1?s:s.substring(e+1);return{folderpath:O.normalizePath(s.substring(0,e)),filename:t,basename:t.replace(/\.[^/.]+$/,"")}}var Ue={target:null,isParent:!1,isChild:!1,isFriend:!1,direction:null},ze=s=>({pi:s.isParent&&s.parentType===S.INFERRED,pd:s.isParent&&s.parentType===S.DEFINED,ci:s.isChild&&s.childType===S.INFERRED,cd:s.isChild&&s.childType===S.DEFINED,fd:s.isFriend}),Xe=(s,e)=>s&&e?s+", "+e:s||e,Ke=(s,e)=>s?s===C.BOTH||s===e?s:C.BOTH:e,$e=(s,e)=>s===S.DEFINED?S.DEFINED:s===S.INFERRED?e===S.DEFINED?S.DEFINED:S.INFERRED:e,$=class{constructor(e,t,i,a=!1,n=!1,r){this.path=e,this.file=t,this.plugin=i,this.isFolder=a,this.isTag=n,this.name=r,this.isChild=l=>{let{pi:d,pd:o,ci:h,cd:p,fd:m}=ze(l);return!p||o||m?d||o||!h||p||m?null:S.INFERRED:S.DEFINED},r||(this.name=t?t.extension==="md"?t.basename:t.name:(l=>{let d=l.endsWith(".md"),o=l.substring(l.lastIndexOf("/")+1);return d?o.slice(0,-3):o})(e)),this.mtime=t?t.stat.mtime:null,this.neighbours=new Map,this.settings=i.settings}getNeighbours(){let{showVirtualNodes:e,showAttachments:t,showFolderNodes:i,showTagNodes:a,showPageNodes:n}=this.settings;return Array.from(this.neighbours).filter(r=>(e||!r[1].target.isVirtual)&&(t||!r[1].target.isAttachment)&&(i||!r[1].target.isFolder)&&(a||!r[1].target.isTag)&&(n||r[1].target.isFolder||r[1].target.isTag))}get isVirtual(){return this.file===null&&!this.isFolder&&!this.isTag}get isAttachment(){return!!this.file&&this.file.extension!=="md"}get isMarkdown(){var e;return((e=this.file)===null||e===void 0?void 0:e.extension)==="md"||!this.file}addParent(e,t,i,a){if(e.path===this.plugin.settings.excalibrainFilepath)return;let n=this.neighbours.get(e.path);if(n)return n.isParent=!0,n.parentType=$e(n.parentType,t),n.parentTypeDefinition=Xe(a,n.parentTypeDefinition),void(n.direction=Ke(n.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},Ue),{target:e,isParent:!0,parentType:t,parentTypeDefinition:a,direction:i}))}addChild(e,t,i,a){if(e.path===this.plugin.settings.excalibrainFilepath)return;let n=this.neighbours.get(e.path);if(n)return n.isChild=!0,n.childType=$e(n.childType,t),n.childTypeDefinition=Xe(a,n.childTypeDefinition),void(n.direction=Ke(n.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},Ue),{target:e,isChild:!0,childType:t,childTypeDefinition:a,direction:i}))}addFriend(e,t,i,a){if(e.path===this.plugin.settings.excalibrainFilepath)return;let n=this.neighbours.get(e.path);if(n)return n.isFriend=!0,n.friendType=$e(n.friendType,t),n.friendTypeDefinition=Xe(a,n.friendTypeDefinition),void(n.direction=Ke(n.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},Ue),{target:e,isFriend:!0,friendType:t,friendTypeDefinition:a,direction:i}))}unlinkNeighbour(e){this.neighbours.delete(e)}hasChildren(){return this.getNeighbours().some(e=>{let t=this.isChild(e[1]);return t&&this.settings.showInferredNodes||t===S.DEFINED})}getChildren(){return this.getNeighbours().filter(e=>{let t=this.isChild(e[1]);return t&&this.settings.showInferredNodes||t===S.DEFINED}).map(e=>({page:e[1].target,relationType:e[1].childType,typeDefinition:e[1].childTypeDefinition,linkDirection:e[1].direction}))}isParent(e){let{pi:t,pd:i,ci:a,cd:n,fd:r}=ze(e);return n||!i||r?!t||i||a||n||r?null:S.INFERRED:S.DEFINED}hasParents(){return this.getNeighbours().some(e=>{let t=this.isParent(e[1]);return t&&this.settings.showInferredNodes||t===S.DEFINED})}getParents(){return this.getNeighbours().filter(e=>{let t=this.isParent(e[1]);return t&&this.settings.showInferredNodes||t===S.DEFINED}).map(e=>({page:e[1].target,relationType:e[1].parentType,typeDefinition:e[1].parentTypeDefinition,linkDirection:e[1].direction}))}isFriend(e){let{pi:t,pd:i,ci:a,cd:n,fd:r}=ze(e);return r?S.DEFINED:!t||i||!a||n||r?null:S.INFERRED}hasFriends(){return this.getNeighbours().some(e=>{let t=this.isFriend(e[1]);return t&&this.settings.showInferredNodes||t===S.DEFINED})}getFriends(){return this.getNeighbours().filter(e=>{let t=this.isFriend(e[1]);return t&&this.settings.showInferredNodes||t===S.DEFINED}).map(e=>{var t;return{page:e[1].target,relationType:((t=e[1].friendType)!==null&&t!==void 0?t:e[1].parentType===S.DEFINED&&e[1].childType===S.DEFINED)?S.DEFINED:S.INFERRED,typeDefinition:e[1].friendTypeDefinition,linkDirection:e[1].direction}})}getRelationToPage(e){let t=this.neighbours.get(e.path);return t?this.isChild(t)?{type:"child",relationType:t.childType,typeDefinition:t.childTypeDefinition}:this.isParent(t)?{type:"parent",relationType:t.parentType,typeDefinition:t.parentTypeDefinition}:{type:"friend",relationType:t.friendType,typeDefinition:t.friendTypeDefinition}:null}getSiblings(){let e=new Map;return this.getParents().forEach(t=>t.page.getChildren().forEach(i=>{e.has(i.page.path)?i.relationType===S.DEFINED&&(e.get(i.page.path).relationType=S.DEFINED):e.set(i.page.path,i)})),Array.from(e.values())}},St={};Object.defineProperty(St,"__esModule",{value:!0});var bt=s=>{try{return window.ExcalidrawAutomate.getAPI(s)}catch(e){return console.log({message:"Excalidraw not available",fn:bt}),null}},vt=St.getEA=bt,Re=["base","inferred","file-tree","tag-tree"],wt={JSON_MALFORMED:"Malformed JSON",JSON_MISSING_KEYS:'JSON must have these 3 keys: "parents", "children", "friends"',JSON_VALUES_NOT_STRING_ARRAYS:'Key values must be a non-empty array of strings. e.g. "parents": ["Parent", "Parents", "up"]',EXCALIBRAIN_FILE_NAME:"Filepath of Excalibrain drawing",EXCALIBRAIN_FILE_DESC:"\u26A0 This file will be overwritten by the plugin. If you stop the script and make changes to the graph, you should rename the file so your edits are preserved, because the next time you initiate ExcaliBrain your edits will be overwritten by the automatically generated ExcaliBrain graph.",HIERARCHY_HEAD:"Hierarchy",HIERARCHY_DESC:"Enter the Dataview field names separated by comma (,) that you will use to define link directions in your graph.",PARENTS_NAME:"Parents",CHILDREN_NAME:"Children",FRIENDS_NAME:"Friends",DISPLAY_HEAD:"Display",EXCLUDE_PATHLIST_NAME:"Filepaths to exclude",EXCLUDE_PATHLIST_DESC:"Enter comma-separated list of filepaths to exclude from the index.",RENDERALIAS_NAME:"Display alias if available",RENDERALIAS_DESC:"Displays the page alias instead of the filename if it is specified in the page's front matter.",SHOWINFERRED_NAME:"Display inferred relationships",SHOWINFERRED_DESC:"<b>Toggle ON</b>: Display both explicitly defined and inferred links. Forward links are children, backlinks are parents, if two page mutually referes to one another then relationship is inferred to be a friendship. Explicitly defined relationships always take priority.<br><b>Toggle OFF</b>: Display only explicitely defined relationships.",SHOWVIRTUAL_NAME:"Display virtual child nodes",SHOWVIRTUAL_DESC:"<b>Toggle ON</b>: Display unresolved links.<br><b>Toggle OFF</b>: Do not display unresolved links.",SHOWATTACHMENTS_NAME:"Include attachments",SHOWATTACHMENTS_DESC:"<b>Toggle ON</b>: Display every type of file on the graph. <br><b>Toggle OFF</b>: Display only markdown files.",STYLE_HEAD:"Styling",STYLE_DESC:"Styles are applied in sequence.<br><ol><li><b>Base</b> node style</li><li><b>Inferred</b> node style (only applied if the node is inferred)</li><li><b>Virtual</b> node style (only applied if the node is virtual)</li> <li><b>Central</b> node style (only applied if the node is in the center)</li><li><b>Sibling</b> node style (only applied if the node is a sibling)</li> <li><b>Attachment</b> node style (only applied if the node is an attachment)</li><li><b>Optional</b> tag based style</li></ol>All the attributes of the base node style must be specified. All other styles may have partial definitions. e.g. You may add a prefix and override the base node-background color in the tag-based style, override the font color in the inferred-node style and set the border stroke style to dotted in the virtual-node style.",CANVAS_BGCOLOR:"Canvas color",TAGLIST_NAME:"Formatted tags",TAGLIST_DESC:"You can specify special formatting rules for Nodes based on tags. If multiple tags are present on the page the first matching a specification will be used. <br>Tagnames should start with <mark>#</mark> and may be incomplete. i.e. <code>#book</code> will match #books, #book/fiction, etc.<br>Enter a comma separated list of tags here, then select from the dropdown list to change the formatting.",MAX_ITEMCOUNT_DESC:"Maximum node count",MAX_ITEMCOUNT_NAME:"Maximum number of nodes to display in a given area of the layout.i.e. the maximum number of parents, the maximum number of children, the maximum number of friends, and the maximum number of siblings to display. If there are more items, they will be ommitted from the drawing.",NODESTYLE_INCLUDE_TOGGLE:"Toggle ON: override base node style for this attribute; OFF: apply base node style for this attribute",NODESTYLE_PREFIX_NAME:"Prefix",NODESTYLE_PREFIX_DESC:"Prefix character or emoji to display in front of the node's label",NODESTYLE_BGCOLOR:"Background color",NODESTYLE_BG_FILLSTYLE:"Bacground fill-style",NODESTYLE_TEXTCOLOR:"Text color",NODESTYLE_BORDERCOLOR:"Border color",NODESTYLE_FONTSIZE:"Font size",NODESTYLE_FONTFAMILY:"Font family",NODESTYLE_MAXLABELLENGTH_NAME:"Max label length",NODESTYLE_MAXLABELLENGTH_DESC:"Maximum number of characters to display from node title. Longer nodes will end with '...'",NODESTYLE_ROUGHNESS:"Stroke roughness",NODESTYLE_SHARPNESS:"Stroke sharpness",NODESTYLE_STROKEWIDTH:"Stroke width",NODESTYLE_STROKESTYLE:"Stroke style",NODESTYLE_RECTANGLEPADDING:"Padding of the node rectangle",NODESTYLE_GATE_RADIUS_NAME:"Gate radius",NODESTYLE_GATE_RADIUS_DESC:"The radius of the 3 small circles (alias: gates) serving as connection points for nodes",NODESTYLE_GATE_OFFSET_NAME:"Gate offset",NODESTYLE_GATE_OFFSET_DESC:"The offset to the left and right of the parent and child gates.",NODESTYLE_GATE_COLOR:"Gate border color",NODESTYLE_GATE_BGCOLOR_NAME:"Gate background color",NODESTYLE_GATE_BGCOLOR_DESC:"The fill color of the gate if it has children",NODESTYLE_GATE_FILLSTYLE:"Gate background fill-style",NODESTYLE_BASE:"Base node style",NODESTYLE_CENTRAL:"Style of central node",NODESTYLE_INFERRED:"Style of inferred nodes",NODESTYLE_VIRTUAL:"Style of virtual nodes",NODESTYLE_SIBLING:"Style of sibling nodes",NODESTYLE_ATTACHMENT:"Style of attachment nodes",NODESTYLE_FOLDER:"Style of folder nodes",NODESTYLE_TAG:"Style of tag nodes",LINKSTYLE_COLOR:"Color",LINKSTYLE_WIDTH:"Width",LINKSTYLE_STROKE:"Stroke style",LINKSTYLE_ROUGHNESS:"Roughness",LINKSTYLE_ARROWSTART:"Start arrow head",LINKSTYLE_ARROWEND:"End arrow head",LINKSTYLE_BASE:"Base link style",LINKSTYLE_INFERRED:"Style of inferred link",LINKSTYLE_FOLDER:"Style of folder link",LINKSTYLE_TAG:"Style of tag link",DATAVIEW_NOT_FOUND:"Dataview plugin not found. Please install or enable Dataview then try restarting ExcaliBrain.",EXCALIDRAW_NOT_FOUND:"Excalidraw plugin not found. Please install or enable Excalidraw then try restarting ExcaliBrain.",EXCALIDRAW_MINAPP_VERSION:"ExcaliBrain requires Excalidraw 1.6.28 or higher. Please upgrade Excalidraw then try restarting ExcaliBrain.",COMMAND_START:"Open ExcaliBrain",OPEN_DRAWING:"Save snapshot for editing",SEARCH_IN_VAULT:`Starred items will be listed in empty search.
Search for a file, a folder or a tag in your Vault.
Toggle folders and tags on/off to show in the list.`,SHOW_HIDE_ATTACHMENTS:"Show/Hide attachments",SHOW_HIDE_VIRTUAL:"Show/Hide virtual nodes",SHOW_HIDE_INFERRED:"Show/Hide inferred nodes",SHOW_HIDE_ALIAS:"Show/Hide document alias",SHOW_HIDE_SIBLINGS:"Show/Hide siblings",SHOW_HIDE_FOLDER:"Show/Hide folder nodes",SHOW_HIDE_TAG:"Show/Hide tag nodes",SHOW_HIDE_PAGES:"Show/Hide page nodes (incl. defined, inferred, virtual and attachments)",PIN_LEAF:"Link ExcaliBrain to most recent active leaf"},qe={en:wt}[O.moment.locale()];function u(s){return qe||Ne({fn:u,where:"src/lang/helpers.ts",message:"Error: locale not found",data:O.moment.locale()}),qe&&qe[s]||wt[s]}var me=class extends O.Modal{constructor(e,t,i){super(e),this.title=t,this.message=i}onOpen(){this.createForm()}onClose(){}createForm(){this.titleEl.setText(this.title),this.contentEl.createDiv({cls:"excalibrain-prompt-center",text:this.message}),this.contentEl.createDiv({cls:"excalibrain-prompt-center"},e=>{e.style.textAlign="right",e.createEl("button",{text:"Ok"}).onclick=()=>{this.resolve(!0),this.close()},e.createEl("button",{text:"Cancel"}).onclick=()=>{this.resolve(!1),this.close()}})}show(e){this.resolve=e,this.open()}},Je=(s,e,t)=>{let i=s.metadataCache.getFirstLinkpathDest(e,t);return i?i.path:e},Ze=(s,e,t)=>{let i=[],a=new Set;return t.forEach(n=>{n=n.toLowerCase().replaceAll(" ","-"),e[n]&&!a.has(n)&&(a.add(n),((r,l,d)=>{let o=new Set;if(l.values)return l.values.forEach(m=>{if(m.type==="file"||m.type==="header"){let y=Je(r,m.path,d.path);y&&o.add(y)}}),Array.from(o);if(l.path){let m=Je(r,l.path,d.path);return m?[m]:[]}let h=l.matchAll(/[^[]*\[\[([^#\]\|]*)[^\]]*]]/g),p;for(;!(p=h.next()).done;)if(p.value[1]){let m=Je(r,p.value[1],d.path);m&&o.add(m)}return Array.from(o)})(s.app,e[n],e.file).forEach(r=>i.push({link:r,field:n})))}),i},Dt=(s,e)=>{var t,i,a;if(!s)return{};let n=((a=(i=(t=s.file)===null||t===void 0?void 0:t.tags)===null||i===void 0?void 0:i.values)!==null&&a!==void 0?a:[]).filter(r=>e.tagStyleList.some(l=>r.startsWith(l)))[0];return n?e.tagNodeStyles[e.tagStyleList.filter(r=>n.startsWith(r))[0]]:{}},ye=class{constructor(e){this.style={},this.center={x:0,y:0},this.page=e.page,this.settings=e.page.plugin.settings,this.ea=e.page.plugin.EA,this.page.isFolder?this.style=Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),this.settings.folderNodeStyle):this.page.isTag?this.style=Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),this.settings.tagNodeStyle):this.style=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isInferred?this.settings.inferredNodeStyle:{}),e.page.isVirtual?this.settings.virtualNodeStyle:{}),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),e.page.isAttachment?this.settings.attachmentNodeStyle:{}),Dt(this.page.dvPage,this.settings)),this.friendGateOnLeft=e.friendGateOnLeft,this.title=this.getTitle()}getTitle(){var e,t,i,a;let n=this.page.file&&this.settings.renderAlias&&(a=(i=(t=(e=this.page.dvPage)===null||e===void 0?void 0:e.file)===null||t===void 0?void 0:t.aliases)===null||i===void 0?void 0:i.values)!==null&&a!==void 0?a:[];return n.length>0?n[0]:this.page.name}displayText(){var e;let t=((e=this.style.prefix)!==null&&e!==void 0?e:"")+this.title;return t.length>this.style.maxLabelLength?t.substring(0,this.style.maxLabelLength-1)+"...":t}setCenter(e){this.center=e}render(){var e,t;let i=this.ea,a=this.displayText();i.style.fontSize=this.style.fontSize,i.style.fontFamily=this.style.fontFamily;let n=i.measureText(a);i.style.fillStyle=this.style.fillStyle,i.style.roughness=this.style.roughness,i.style.strokeSharpness=this.style.strokeShaprness,i.style.strokeWidth=this.style.strokeWidth,i.style.strokeColor=this.style.textColor,i.style.backgroundColor="transparent",this.id=i.addText(this.center.x-n.width/2,this.center.y-n.height/2,a,{wrapAt:this.style.maxLabelLength+5,textAlign:"center",box:!0,boxPadding:this.style.padding});let r=i.getElement(this.id);r.link=`[[${(t=(e=this.page.file)===null||e===void 0?void 0:e.path)!==null&&t!==void 0?t:this.page.path}]]`,r.backgroundColor=this.style.backgroundColor,r.strokeColor=this.style.borderColor,r.strokeStyle=this.style.strokeStyle,i.style.fillStyle=this.style.gateFillStyle,i.style.strokeColor=this.style.gateStrokeColor,i.style.strokeStyle="solid",i.style.backgroundColor=this.page.hasFriends()?this.style.gateBackgroundColor:"transparent",this.friendGateId=i.addEllipse(this.friendGateOnLeft?this.center.x-2*this.style.gateRadius-this.style.padding-n.width/2:this.center.x+this.style.padding+n.width/2,this.center.y-this.style.gateRadius,2*this.style.gateRadius,2*this.style.gateRadius),i.style.backgroundColor=this.page.hasParents()?this.style.gateBackgroundColor:"transparent",this.parentGateId=i.addEllipse(this.center.x-this.style.gateRadius-this.style.gateOffset,this.center.y-2*this.style.gateRadius-this.style.padding-n.height/2,2*this.style.gateRadius,2*this.style.gateRadius),i.style.backgroundColor=this.page.hasChildren()?this.style.gateBackgroundColor:"transparent",this.childGateId=i.addEllipse(this.center.x-this.style.gateRadius+this.style.gateOffset,this.center.y+this.style.padding+n.height/2,2*this.style.gateRadius,2*this.style.gateRadius),i.addToGroup([this.friendGateId,this.parentGateId,this.childGateId,this.id,r.boundElements[0].id])}},Qe=class{constructor(e,t,i,a,n,r,l,d){this.nodeA=e,this.nodeB=t,this.nodeBRole=i,this.ea=r;let o=n==null?void 0:n.split(",").map(p=>p.trim()),h={};o&&o.forEach(p=>{d.hierarchyLinkStylesExtended[p]&&(h=Object.assign(Object.assign({},h),d.hierarchyLinkStylesExtended[p]))}),this.style=Object.assign(Object.assign(Object.assign({},l.baseLinkStyle),a===S.INFERRED?l.inferredLinkStyle:{}),h)}render(){let e=this.ea,t=this.style,i,a;switch(e.style.strokeStyle=t.strokeStyle,e.style.strokeColor=t.strokeColor,e.style.strokeWidth=t.strokeWidth,this.nodeBRole){case M.CHILD:i=this.nodeA.childGateId,a=this.nodeB.parentGateId;break;case M.PARENT:i=this.nodeA.parentGateId,a=this.nodeB.childGateId;break;default:i=this.nodeA.friendGateId,a=this.nodeB.friendGateId}e.connectObjects(i,null,a,null,{startArrowHead:t.startArrowHead==="none"?null:t.startArrowHead,endArrowHead:t.endArrowHead==="none"?null:t.endArrowHead})}},Zt={excalibrainFilepath:"excalibrain.md",hierarchy:{parents:["Parent","Parents","up","u"],children:["Children","Child","down","d"],friends:["Friends","Friend","Jump","Jumps","j"]},renderAlias:!0,backgroundColor:"#0c3e6aff",excludeFilepaths:[],showInferredNodes:!0,showAttachments:!0,showVirtualNodes:!0,showFolderNodes:!1,showTagNodes:!1,showPageNodes:!0,maxItemCount:30,renderSiblings:!0,baseNodeStyle:{prefix:"",backgroundColor:"#00000066",fillStyle:"solid",textColor:"#ffffffff",borderColor:"#00000000",fontSize:20,fontFamily:3,maxLabelLength:30,roughness:0,strokeShaprness:"round",strokeWidth:1,strokeStyle:"solid",padding:10,gateRadius:5,gateOffset:15,gateStrokeColor:"#ffffffff",gateBackgroundColor:"#ffffffff",gateFillStyle:"solid"},centralNodeStyle:{fontSize:30,backgroundColor:"#C49A13FF",textColor:"#000000ff"},inferredNodeStyle:{backgroundColor:"#000005b3",textColor:"#95c7f3ff"},virtualNodeStyle:{backgroundColor:"#ff000066",fillStyle:"hachure",textColor:"#ffffffff"},siblingNodeStyle:{fontSize:15},attachmentNodeStyle:{prefix:"\u{1F4CE} "},folderNodeStyle:{prefix:"\u{1F4C2} ",strokeShaprness:"sharp",borderColor:"#ffd700ff",textColor:"#ffd700ff"},tagNodeStyle:{prefix:"#",strokeShaprness:"sharp",borderColor:"#4682b4ff",textColor:"#4682b4ff"},tagNodeStyles:{},tagStyleList:[],baseLinkStyle:{strokeColor:"#696969FF",strokeWidth:1,strokeStyle:"solid",roughness:0,startArrowHead:"none",endArrowHead:"none"},inferredLinkStyle:{strokeStyle:"dashed"},folderLinkStyle:{strokeColor:"#ffd700ff"},tagLinkStyle:{strokeColor:"#4682b4ff"},hierarchyLinkStyles:{},navigationHistory:[]},Z="excalibrain-settings-disabled",et=s=>(255*s|256).toString(16).slice(1),ie=s=>createFragment(e=>e.createDiv().innerHTML=s),tt=s=>{let e=document.getElementById(s);if(!e)return;let t=e.parentNode;t&&t.removeChild(e)},Nt=(s,e)=>{let t=document.createElement("style");t.id=s,t.innerHTML=`.${e} {display: none;}`,document.body.appendChild(t)},Tt=class extends O.PluginSettingTab{constructor(e,t){super(e,t),this.dirty=!1,this.plugin=t}get hierarchyStyleList(){return Re.concat(Array.from(this.plugin.settings.hierarchy.parents)).concat(Array.from(this.plugin.settings.hierarchy.children)).concat(Array.from(this.plugin.settings.hierarchy.friends))}async updateNodeDemoImg(){this.ea.reset(),this.ea.canvas.viewBackgroundColor=this.plugin.settings.backgroundColor,this.demoNode.style=Object.assign(Object.assign({},this.demoNodeStyle.getInheritedStyle()),this.demoNodeStyle.style),this.demoNode.render();let e=await this.ea.createSVG(null,!0,{withBackground:!0,withTheme:!1},null,"",40);e.removeAttribute("width"),e.removeAttribute("height"),this.demoNodeImg.setAttribute("src",Et(e.outerHTML))}async updateLinkDemoImg(){this.ea.reset(),this.ea.canvas.viewBackgroundColor=this.plugin.settings.backgroundColor;let e=new $("Start node",null,this.plugin),t=new $("End node",null,this.plugin),i=this.plugin.settings.hierarchy;i.friends.contains(this.demoLinkStyle.display)?(e.addFriend(t,S.DEFINED,C.FROM),t.addFriend(e,S.DEFINED,C.TO)):i.parents.contains(this.demoLinkStyle.display)?(e.addParent(t,S.DEFINED,C.FROM),t.addChild(e,S.DEFINED,C.TO)):(e.addChild(t,S.DEFINED,C.FROM),t.addParent(e,S.DEFINED,C.TO));let a=new ye({page:e,isInferred:!1,isCentral:!0,isSibling:!1,friendGateOnLeft:!0});a.ea=this.ea,a.setCenter({x:0,y:0});let n=new ye({page:t,isInferred:!1,isCentral:!1,isSibling:!1,friendGateOnLeft:!1});n.ea=this.ea;let r=M.CHILD;i.friends.contains(this.demoLinkStyle.display)?(n.setCenter({x:-300,y:0}),r=M.FRIEND):i.parents.contains(this.demoLinkStyle.display)?(n.setCenter({x:0,y:-150}),r=M.PARENT):n.setCenter({x:0,y:150});let l=new Qe(a,n,r,S.DEFINED,"base",this.ea,this.plugin.settings,this.plugin);a.style=Object.assign(Object.assign({},this.plugin.settings.baseNodeStyle),this.plugin.settings.centralNodeStyle),a.render(),n.style=Object.assign(Object.assign({},this.demoNodeStyle.getInheritedStyle()),this.demoNodeStyle.style),n.render(),l.style=Object.assign(Object.assign({},this.demoLinkStyle.getInheritedStyle()),this.demoLinkStyle.style),l.render();let d=await this.ea.createSVG(null,!0,{withBackground:!0,withTheme:!1},null,"",40);d.removeAttribute("width"),d.removeAttribute("height"),this.demoLinkImg.setAttribute("src",Et(d.outerHTML))}async hide(){var e;this.dirty&&(this.plugin.setHierarchyLinkStylesExtended(),this.plugin.settings.tagStyleList=Object.keys(this.plugin.settings.tagNodeStyles),this.plugin.saveSettings(),(e=this.plugin.scene)===null||e===void 0||e.reRender())}colorpicker(e,t,i,a,n,r,l,d){let o,h,p,m,y,b,f=new O.Setting(e).setName(t);i&&f.setDesc(ie(i));let v=T=>{T?f.settingEl.addClass(Z):f.settingEl.removeClass(Z),h.disabled=T,h.style.opacity=T?"0.3":"1",o.setDisabled(T),o.sliderEl.style.opacity=T?"0.3":"1",m.style.opacity=T?"0.3":"1",y.style.opacity=T?"0.3":"1",b.style.opacity=T?"0.3":"1"};l&&f.addToggle(T=>{p=T,T.toggleEl.addClass("excalibrain-settings-toggle"),T.setValue(a()!==void 0).setTooltip(u("NODESTYLE_INCLUDE_TOGGLE")).onChange(L=>{if(this.dirty=!0,!L)return v(!0),void r();n(h.value+et(o.getValue())),v(!1)})}),f.settingEl.removeClass("mod-toggle"),m=createEl("span",{text:"color:",cls:"excalibrain-settings-colorlabel"}),f.controlEl.appendChild(m),h=createEl("input",{type:"color",cls:"excalibrain-settings-colorpicker"},T=>{var L;T.value=((L=a())!==null&&L!==void 0?L:d).substring(0,7),T.onchange=()=>{n(T.value+et(o.getValue()))}}),f.controlEl.appendChild(h),y=createEl("span",{text:"opacity:",cls:"excalibrain-settings-opacitylabel"}),f.controlEl.appendChild(y),f.addSlider(T=>{var L,x;o=T,T.setLimits(0,1,.1).setValue((x=(L=a())!==null&&L!==void 0?L:d,parseInt(x.substring(7,9),16)/255)).onChange(I=>{n(h.value+et(I)),b.innerText=` ${I.toString()}`,h.style.opacity=I.toString()})}),b=createDiv({text:`${o.getValue().toString()}`,cls:"excalibrain-settings-sliderlabel"}),f.controlEl.appendChild(b),h.style.opacity=o.getValue().toString(),v(l&&!p.getValue())}numberslider(e,t,i,a,n,r,l,d,o){let h,p,m,y=new O.Setting(e).setName(t),b=f=>{f?y.settingEl.addClass(Z):y.settingEl.removeClass(Z),m.setDisabled(f),m.sliderEl.style.opacity=f?"0.3":"1",h.style.opacity=f?"0.3":"1"};d&&y.addToggle(f=>{p=f,f.toggleEl.addClass("excalibrain-settings-toggle"),f.setValue(n()!==void 0).setTooltip(u("NODESTYLE_INCLUDE_TOGGLE")).onChange(v=>{if(this.dirty=!0,!v)return b(!0),void l();r(m.getValue()),b(!1)})}),y.addSlider(f=>{var v;m=f,f.setLimits(a.min,a.max,a.step).setValue((v=n())!==null&&v!==void 0?v:o).onChange(async T=>{h.innerText=` ${T.toString()}`,r(T),this.dirty=!0})}),i&&y.setDesc(ie(i)),y.settingEl.createDiv("",f=>{h=f,f.style.minWidth="2.3em",f.style.textAlign="right",f.innerText=` ${m.getValue().toString()}`}),b(d&&!p.getValue())}dropdownpicker(e,t,i,a,n,r,l,d,o){let h,p,m=new O.Setting(e).setName(t),y=b=>{b?m.settingEl.addClass(Z):m.settingEl.removeClass(Z),h.setDisabled(b),h.selectEl.style.opacity=b?"0.3":"1"};d&&m.addToggle(b=>{p=b,b.toggleEl.addClass("excalibrain-settings-toggle"),b.setValue(n()!==void 0).setTooltip(u("NODESTYLE_INCLUDE_TOGGLE")).onChange(f=>{if(this.dirty=!0,!f)return y(!0),void l();r(h.getValue()),y(!1)})}),m.addDropdown(b=>{var f;h=b,b.addOptions(a).setValue((f=n())!==null&&f!==void 0?f:o).onChange(v=>{r(v),this.dirty=!0})}),i&&m.setDesc(ie(i)),y(d&&!p.getValue())}nodeSettings(e,t,i=!0,a){let n,r,l=new O.Setting(e).setName(u("NODESTYLE_PREFIX_NAME")).setDesc(ie(u("NODESTYLE_PREFIX_DESC"))),d=o=>{o?l.settingEl.addClass(Z):l.settingEl.removeClass(Z),n.setDisabled(o),n.inputEl.style.opacity=o?"0.3":"1"};i&&l.addToggle(o=>{r=o,o.toggleEl.addClass("excalibrain-settings-toggle"),o.setValue(t.prefix!==void 0).setTooltip(u("NODESTYLE_INCLUDE_TOGGLE")).onChange(h=>{if(this.dirty=!0,!h)return d(!0),t.prefix=void 0,void this.updateNodeDemoImg();d(!1)})}),l.addText(o=>{var h;n=o,o.setValue((h=t.prefix)!==null&&h!==void 0?h:a.prefix).onChange(p=>{t.prefix=p,this.updateNodeDemoImg(),this.dirty=!0})}),d(i&&!r.getValue()),this.colorpicker(e,u("NODESTYLE_BGCOLOR"),null,()=>t.backgroundColor,o=>{t.backgroundColor=o,this.updateNodeDemoImg()},()=>{delete t.backgroundColor,this.updateNodeDemoImg()},i,a.backgroundColor),this.dropdownpicker(e,u("NODESTYLE_BG_FILLSTYLE"),null,{hachure:"Hachure","cross-hatch":"Cross-hatch",solid:"Solid"},()=>{var o;return(o=t.fillStyle)===null||o===void 0?void 0:o.toString()},o=>{t.fillStyle=o,this.updateNodeDemoImg()},()=>{delete t.fillStyle,this.updateNodeDemoImg()},i,a.fillStyle.toString()),this.colorpicker(e,u("NODESTYLE_TEXTCOLOR"),null,()=>t.textColor,o=>{t.textColor=o,this.updateNodeDemoImg()},()=>{delete t.textColor,this.updateNodeDemoImg()},i,a.textColor),this.colorpicker(e,u("NODESTYLE_BORDERCOLOR"),null,()=>t.borderColor,o=>{t.borderColor=o,this.updateNodeDemoImg()},()=>{delete t.borderColor,this.updateNodeDemoImg()},i,a.borderColor),this.numberslider(e,u("NODESTYLE_FONTSIZE"),null,{min:10,max:50,step:5},()=>t.fontSize,o=>{t.fontSize=o,this.updateNodeDemoImg()},()=>{delete t.fontSize,this.updateNodeDemoImg()},i,a.fontSize),this.dropdownpicker(e,u("NODESTYLE_FONTFAMILY"),null,{1:"Hand-drawn",2:"Normal",3:"Code",4:"Fourth (custom) Font"},()=>{var o;return(o=t.fontFamily)===null||o===void 0?void 0:o.toString()},o=>{t.fontFamily=parseInt(o),this.updateNodeDemoImg()},()=>{delete t.fontFamily,this.updateNodeDemoImg()},i,a.fontFamily.toString()),this.numberslider(e,u("NODESTYLE_MAXLABELLENGTH_NAME"),u("NODESTYLE_MAXLABELLENGTH_DESC"),{min:15,max:100,step:5},()=>t.maxLabelLength,o=>{t.maxLabelLength=o,this.updateNodeDemoImg()},()=>{delete t.maxLabelLength,this.updateNodeDemoImg()},i,a.maxLabelLength),this.dropdownpicker(e,u("NODESTYLE_ROUGHNESS"),null,{0:"Architect",1:"Artist",2:"Cartoonist"},()=>{var o;return(o=t.roughness)===null||o===void 0?void 0:o.toString()},o=>{t.roughness=parseInt(o),this.updateNodeDemoImg()},()=>{delete t.roughness,this.updateNodeDemoImg()},i,a.roughness.toString()),this.dropdownpicker(e,u("NODESTYLE_SHARPNESS"),null,{sharp:"Sharp",round:"Round"},()=>t.strokeShaprness,o=>{t.strokeShaprness=o,this.updateNodeDemoImg()},()=>{delete t.strokeShaprness,this.updateNodeDemoImg()},i,a.strokeShaprness),this.numberslider(e,u("NODESTYLE_STROKEWIDTH"),null,{min:.5,max:6,step:.5},()=>t.strokeWidth,o=>{t.strokeWidth=o,this.updateNodeDemoImg()},()=>{delete t.strokeWidth,this.updateNodeDemoImg()},i,a.strokeWidth),this.dropdownpicker(e,u("NODESTYLE_STROKESTYLE"),null,{solid:"Solid",dashed:"Dashed",dotted:"Dotted"},()=>t.strokeStyle,o=>{t.strokeStyle=o,this.updateNodeDemoImg()},()=>{delete t.strokeStyle,this.updateNodeDemoImg()},i,a.strokeStyle),this.numberslider(e,u("NODESTYLE_RECTANGLEPADDING"),null,{min:5,max:50,step:5},()=>t.padding,o=>{t.padding=o,this.updateNodeDemoImg()},()=>{delete t.padding,this.updateNodeDemoImg()},i,a.padding),this.numberslider(e,u("NODESTYLE_GATE_RADIUS_NAME"),u("NODESTYLE_GATE_RADIUS_DESC"),{min:3,max:10,step:1},()=>t.gateRadius,o=>{t.gateRadius=o,this.updateNodeDemoImg()},()=>{delete t.gateRadius,this.updateNodeDemoImg()},i,a.gateRadius),this.numberslider(e,u("NODESTYLE_GATE_OFFSET_NAME"),u("NODESTYLE_GATE_OFFSET_DESC"),{min:0,max:25,step:1},()=>t.gateOffset,o=>{t.gateOffset=o,this.updateNodeDemoImg()},()=>{delete t.gateOffset,this.updateNodeDemoImg()},i,a.gateOffset),this.colorpicker(e,u("NODESTYLE_GATE_COLOR"),null,()=>t.gateStrokeColor,o=>{t.gateStrokeColor=o,this.updateNodeDemoImg()},()=>{delete t.gateStrokeColor,this.updateNodeDemoImg()},i,a.gateStrokeColor),this.colorpicker(e,u("NODESTYLE_GATE_BGCOLOR_NAME"),u("NODESTYLE_GATE_BGCOLOR_DESC"),()=>t.gateBackgroundColor,o=>{t.gateBackgroundColor=o,this.updateNodeDemoImg()},()=>{delete t.gateBackgroundColor,this.updateNodeDemoImg()},i,a.gateBackgroundColor),this.dropdownpicker(e,u("NODESTYLE_GATE_FILLSTYLE"),null,{hachure:"Hachure","cross-hatch":"Cross-hatch",solid:"Solid"},()=>{var o;return(o=t.gateFillStyle)===null||o===void 0?void 0:o.toString()},o=>{t.gateFillStyle=o,this.updateNodeDemoImg()},()=>{delete t.gateFillStyle,this.updateNodeDemoImg()},i,a.gateFillStyle.toString())}linkSettings(e,t,i=!0,a){this.colorpicker(e,u("LINKSTYLE_COLOR"),null,()=>t.strokeColor,n=>{t.strokeColor=n,this.updateLinkDemoImg()},()=>{delete t.strokeColor,this.updateLinkDemoImg()},i,a.strokeColor),this.numberslider(e,u("LINKSTYLE_WIDTH"),null,{min:.5,max:10,step:.5},()=>t.strokeWidth,n=>{t.strokeWidth=n,this.updateLinkDemoImg()},()=>{delete t.strokeWidth,this.updateLinkDemoImg()},i,a.strokeWidth),this.dropdownpicker(e,u("LINKSTYLE_STROKE"),null,{solid:"Solid",dashed:"Dashed",dotted:"Dotted"},()=>t.strokeStyle,n=>{t.strokeStyle=n,this.updateLinkDemoImg()},()=>{delete t.strokeStyle,this.updateLinkDemoImg()},i,a.strokeStyle),this.dropdownpicker(e,u("LINKSTYLE_ARROWSTART"),null,{none:"None",arrow:"Arrow",bar:"Bar",dot:"Dot",triangle:"Triangle"},()=>t.startArrowHead,n=>{t.startArrowHead=n===""?null:n,this.updateLinkDemoImg()},()=>{delete t.startArrowHead,this.updateLinkDemoImg()},i,a.startArrowHead),this.dropdownpicker(e,u("LINKSTYLE_ARROWEND"),null,{none:"None",arrow:"Arrow",bar:"Bar",dot:"Dot",triangle:"Triangle"},()=>t.endArrowHead,n=>{t.endArrowHead=n===""?null:n,this.updateLinkDemoImg()},()=>{delete t.endArrowHead,this.updateLinkDemoImg()},i,a.endArrowHead)}async display(){await this.plugin.loadSettings(),this.ea=vt();let e=new $("This is a demo node that is 46 characters long",null,this.plugin),t=new $("This is a child node",null,this.plugin);e.addChild(t,S.DEFINED,C.FROM),t.addParent(e,S.DEFINED,C.TO),this.demoNode=new ye({page:e,isInferred:!1,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.demoNode.ea=this.ea,this.demoNode.setCenter({x:0,y:0});let{containerEl:i}=this;this.containerEl.empty();let a=i.createDiv("coffee");a.addClass("ex-coffee-div"),a.createEl("a",{href:"https://ko-fi.com/zsolt"}).createEl("img",{attr:{src:"https://cdn.ko-fi.com/cdn/kofi3.png?v=3"}}).height=45,new O.Setting(i).setName(u("EXCALIBRAIN_FILE_NAME")).setDesc(ie(u("EXCALIBRAIN_FILE_DESC"))).addText(c=>c.setValue(this.plugin.settings.excalibrainFilepath).onChange(g=>{this.dirty=!0,g.endsWith(".md")||(g+=g.endsWith(".m")?"d":g.endsWith(".")?"md":".md"),this.app.vault.getAbstractFileByPath(g)?new me(this.app,"\u26A0 File Exists",`${g} already exists in your Vault. Is it ok to overwrite this file?`).show(w=>{w&&(this.plugin.settings.excalibrainFilepath=g,this.dirty=!0,c.inputEl.value=g)}):(this.plugin.settings.excalibrainFilepath=g,this.dirty=!0)}).inputEl.onblur=()=>{c.setValue(this.plugin.settings.excalibrainFilepath)}),this.containerEl.createEl("h1",{cls:"excalibrain-settings-h1",text:u("HIERARCHY_HEAD")}),this.containerEl.createEl("p",{}).innerHTML=u("HIERARCHY_DESC");let n,r,l=()=>{};new O.Setting(i).setName(u("PARENTS_NAME")).addText(c=>{c.inputEl.style.width="100%",c.setValue(this.plugin.settings.hierarchy.parents.join(", ")).onChange(g=>{this.plugin.settings.hierarchy.parents=g.split(",").map(w=>w.trim()),l(),this.dirty=!0})}),new O.Setting(i).setName(u("CHILDREN_NAME")).addText(c=>{c.inputEl.style.width="100%",c.setValue(this.plugin.settings.hierarchy.children.join(", ")).onChange(g=>{this.plugin.settings.hierarchy.children=g.split(",").map(w=>w.trim()),l(),this.dirty=!0})}),new O.Setting(i).setName(u("FRIENDS_NAME")).addText(c=>{c.inputEl.style.width="100%",c.setValue(this.plugin.settings.hierarchy.friends.join(", ")).onChange(g=>{this.plugin.settings.hierarchy.friends=g.split(",").map(w=>w.trim()),l(),this.dirty=!0})}),this.containerEl.createEl("h1",{cls:"excalibrain-settings-h1",text:u("DISPLAY_HEAD")}),new O.Setting(i).setName(u("EXCLUDE_PATHLIST_NAME")).setDesc(u("EXCLUDE_PATHLIST_DESC")).addTextArea(c=>{c.inputEl.style.height="100px",c.inputEl.style.width="100%",c.setValue(this.plugin.settings.excludeFilepaths.join(", ")).onChange(g=>{let w=(g=g.replaceAll(`
`," ")).split(",").map(E=>E.trim());this.plugin.settings.excludeFilepaths=w.filter(E=>E!==""),this.dirty=!0})}).descEl.style.maxWidth="400px",new O.Setting(i).setName(u("RENDERALIAS_NAME")).setDesc(ie(u("RENDERALIAS_DESC"))).addToggle(c=>c.setValue(this.plugin.settings.renderAlias).onChange(g=>{this.plugin.settings.renderAlias=g,this.dirty=!0})),new O.Setting(i).setName(u("SHOWINFERRED_NAME")).setDesc(ie(u("SHOWINFERRED_DESC"))).addToggle(c=>c.setValue(this.plugin.settings.showInferredNodes).onChange(g=>{this.plugin.settings.showInferredNodes=g,this.dirty=!0})),new O.Setting(i).setName(u("SHOWATTACHMENTS_NAME")).setDesc(ie(u("SHOWATTACHMENTS_DESC"))).addToggle(c=>c.setValue(this.plugin.settings.showAttachments).onChange(g=>{this.plugin.settings.showAttachments=g,this.dirty=!0})),new O.Setting(i).setName(u("SHOWVIRTUAL_NAME")).setDesc(ie(u("SHOWVIRTUAL_DESC"))).addToggle(c=>c.setValue(this.plugin.settings.showVirtualNodes).onChange(g=>{this.plugin.settings.showVirtualNodes=g,this.dirty=!0})),this.numberslider(i,u("MAX_ITEMCOUNT_NAME"),u("MAX_ITEMCOUNT_DESC"),{min:5,max:150,step:5},()=>this.plugin.settings.maxItemCount,c=>this.plugin.settings.maxItemCount=c,()=>{},!1,30),i.createEl("h1",{cls:"excalibrain-settings-h1",text:u("STYLE_HEAD")}),this.containerEl.createEl("p",{}).innerHTML=u("STYLE_DESC"),this.colorpicker(i,u("CANVAS_BGCOLOR"),null,()=>this.plugin.settings.backgroundColor,c=>{this.plugin.settings.backgroundColor=c,this.updateNodeDemoImg()},()=>{},!1,this.plugin.settings.backgroundColor);let d=c=>{r.empty();let g=this.plugin.nodeStyles[c];this.nodeSettings(r,g.style,g.allowOverride,g.getInheritedStyle()),this.demoNodeStyle=g,this.updateNodeDemoImg()};new O.Setting(i).setName(u("TAGLIST_NAME")).setDesc(u("TAGLIST_DESC")).addTextArea(c=>{c.inputEl.style.height="200px",c.inputEl.style.width="100%",c.setValue(this.plugin.settings.tagStyleList.join(", ")).onChange(g=>{let w=this.plugin.settings.tagNodeStyles,E=this.plugin.nodeStyles,A=(g=g.replaceAll(`
`," ")).split(",").map(D=>D.trim());this.plugin.settings.tagStyleList=A,Object.keys(w).forEach(D=>{A.contains(D)||(delete w[D],delete E[D])}),A.forEach(D=>{Object.keys(w).contains(D)||(w[D]={},E[D]={style:w[D],allowOverride:!0,userStyle:!0,display:D,getInheritedStyle:()=>this.plugin.settings.baseNodeStyle})});let N=n.getValue();for(let D=n.selectEl.options.length-1;D>=0;D--)n.selectEl.remove(D);Object.entries(E).forEach(D=>{n.addOption(D[0],D[1].display)}),E[N]?n.setValue(N):(n.setValue("base"),d("base")),this.dirty=!0})}).descEl.style.maxWidth="400px";let o=i.createDiv({cls:"setting-item"}),h=o.createDiv({cls:"setting-item-info"}),p;n=new O.DropdownComponent(h),o.createDiv({text:"Show inherited",cls:"setting-item-name"}).style.marginRight="10px";let m=!1,y=new O.ToggleComponent(o);y.setValue(!0).setTooltip("Show/Hide Inherited Properties").onChange(c=>{m?m=!1:(c?tt("excalibrain-hide-disabled"):Nt("excalibrain-hide-disabled",Z),m=!0,p.setValue(c))}),Object.entries(this.plugin.nodeStyles).forEach(c=>{n.addOption(c[0],c[1].display)}),this.demoNodeImg=i.createEl("img",{cls:"excalibrain-settings-demoimg"}),r=i.createDiv({cls:"excalibrain-setting-style-section"}),tt("excalibrain-hide-disabled"),n.setValue("base").onChange(d);let b=this.plugin.nodeStyles.base,f,v;this.nodeSettings(r,b.style,b.allowOverride,b.getInheritedStyle()),this.demoNodeStyle=b,this.updateNodeDemoImg();let T=c=>{v.empty();let g=this.plugin.linkStyles[c];this.linkSettings(v,g.style,g.allowOverride,g.getInheritedStyle()),this.demoLinkStyle=g,this.updateLinkDemoImg()},L=i.createDiv({cls:"setting-item"}),x=L.createDiv({cls:"setting-item-info"});f=new O.DropdownComponent(x),L.createDiv({text:"Show inherited",cls:"setting-item-name"}).style.marginRight="10px",p=new O.ToggleComponent(L),p.setValue(!0).setTooltip("Show/Hide Inherited Properties").onChange(c=>{m?m=!1:(c?tt("excalibrain-hide-disabled"):Nt("excalibrain-hide-disabled",Z),m=!0,y.setValue(c))}),Object.entries(this.plugin.linkStyles).forEach(c=>{f.addOption(c[0],c[1].display)}),this.demoLinkImg=i.createEl("img",{cls:"excalibrain-settings-demoimg"}),v=i.createDiv({cls:"excalibrain-setting-nodestyle-section"}),f.setValue("base").onChange(T);let I=this.plugin.linkStyles.base;this.linkSettings(v,I.style,I.allowOverride,I.getInheritedStyle()),this.demoLinkStyle=I,this.updateLinkDemoImg(),l=()=>{let c=this.plugin.settings.hierarchyLinkStyles,g=this.plugin.linkStyles;Object.keys(g).forEach(E=>{Re.contains(E)||this.hierarchyStyleList.contains(E)||(delete g[E],delete c[E])}),this.hierarchyStyleList.forEach(E=>{Object.keys(c).contains(E)||Re.contains(E)||(c[E]={},g[E]={style:c[E],allowOverride:!0,userStyle:!0,display:E,getInheritedStyle:()=>this.plugin.settings.baseLinkStyle})});let w=f.getValue();for(let E=f.selectEl.options.length-1;E>=0;E--)f.selectEl.remove(E);Object.entries(g).forEach(E=>{f.addOption(E[0],E[1].display)}),g[w]?f.setValue(w):(f.setValue("base"),T("base"))},l()}},it={};Object.defineProperty(it,"__esModule",{value:!0});var Qt=it.getAPI=s=>{var e;return s?(e=s.plugins.plugins.dataview)===null||e===void 0?void 0:e.api:window.DataviewAPI};it.isPluginEnabled=s=>s.plugins.enabledPlugins.has("dataview");var Ot=class{constructor(e){this.pages=new Map,this.forEach=this.pages.forEach.bind(this.pages),this.app=e.app,this.plugin=e}add(e,t){this.pages.set(e,t)}has(e){return this.pages.has(e)}get(e){return this.pages.get(e)}getPages(){return Array.from(this.pages.values())}get size(){return this.pages.size}delete(e){let t=this.pages.get(e);t&&(t.neighbours.forEach((i,a)=>{let n=this.pages.get(a);n&&(n.unlinkNeighbour(e),n.file||n.neighbours.size!==0||this.pages.delete(a))}),this.pages.delete(e))}addWithConnections(e){var t,i;let a=new $(e.path,e,this.plugin);this.add(e.path,a),new Set(Object.keys((i=(t=app.metadataCache.getBacklinksForFile(e))===null||t===void 0?void 0:t.data)!==null&&i!==void 0?i:{}).map(r=>{var l,d;return(d=(l=app.metadataCache.getFirstLinkpathDest(r,e.path))===null||l===void 0?void 0:l.path)!==null&&d!==void 0?d:r})).forEach(r=>{let l=this.pages.get(r);r?(l.addChild(a,S.INFERRED,C.TO),a.addParent(l,S.INFERRED,C.FROM)):Te(`Unexpected: ${a.file.path} is referenced from ${r} as backlink in metadataCache, but page for ${r} has not yet been registered in ExcaliBrain index.`)}),this.addUnresolvedLinks(a),this.addResolvedLinks(a),this.addDVFieldLinksToPage(a)}addResolvedLinks(e){let t=this.app.metadataCache.resolvedLinks;Object.keys(t).forEach(i=>{if(e&&e.path!==i)return;let a=this.pages.get(i);Object.keys(t[i]).forEach(n=>{let r=this.pages.get(n);r.addParent(a,S.INFERRED,C.TO),a.addChild(r,S.INFERRED,C.FROM)})})}addUnresolvedLinks(e){if(e&&(e.isFolder||e.isTag))return;let t=this.app.metadataCache.unresolvedLinks;Object.keys(t).forEach(i=>{if(e&&e.path!==i)return;let a=this.pages.get(i);i!==this.plugin.settings.excalibrainFilepath&&Object.keys(t[i]).forEach(n=>{let r=new $(n,null,this.plugin);r.addParent(a,S.INFERRED,C.TO),a.addChild(r,S.INFERRED,C.FROM),this.add(n,r)})})}addDVFieldLinksToPage(e){var t,i,a;if(e.isFolder||e.isTag)return;let n=this.plugin.DVAPI.page(e.file.path);if(!n||(e.dvPage=n,!n))return;let r=[];((a=(i=(t=n.file)===null||t===void 0?void 0:t.tags)===null||i===void 0?void 0:i.values)!==null&&a!==void 0?a:[]).sort((h,p)=>p.length-h.length).forEach(h=>{if(r.length>0&&r.some(m=>m.startsWith(h+"/")))return;r.push(h),h="tag:"+h.substring(1);let p=this.pages.get(h);p&&(e.addParent(p,S.DEFINED,C.TO,"tag-tree"),p.addChild(e,S.DEFINED,C.FROM,"tag-tree"))});let l=this.plugin.settings.hierarchy.parents;Ze(this.plugin,n,l).forEach(h=>{let p=this.pages.get(h.link);p?(e.addParent(p,S.DEFINED,C.FROM,h.field),p.addChild(e,S.DEFINED,C.TO,h.field)):Te(`Unexpected: ${e.file.path} references ${h.link} in DV, but it was not found in app.metadataCache. The page was skipped.`)});let d=this.plugin.settings.hierarchy.children;Ze(this.plugin,n,d).forEach(h=>{let p=this.pages.get(h.link);p?(e.addChild(p,S.DEFINED,C.FROM,h.field),p.addParent(e,S.DEFINED,C.TO,h.field)):Te(`Unexpected: ${e.file.path} references ${h.link} in DV, but it was not found in app.metadataCache. The page was skipped.`)});let o=this.plugin.settings.hierarchy.friends;Ze(this.plugin,n,o).forEach(h=>{let p=this.pages.get(h.link);p?(e.addFriend(p,S.DEFINED,C.FROM,h.field),p.addFriend(e,S.DEFINED,C.TO,h.field)):Te(`Unexpected: ${e.file.path} references ${h.link} in DV, but it was not found in app.metadataCache. The page was skipped.`)})}},Lt=`---

excalidraw-plugin: parsed
excalidraw-default-mode: view
excalidraw-export-dark: false
excalidraw-export-transparent: false
excalidraw-linkbutton-opacity: 0.3
excalidraw-onload-script: "app.plugins.plugins[${String.fromCharCode(96)}excalibrain${String.fromCharCode(96)}].start(ea.targetView.leaf);"

tags: [excalidraw]

---

# Text Elements
Open a document in another pane and click it to get started.

For the best experience enable 'Open in adjacent pane'
in Excalidraw settings under 'Links and Transclusion'. ^4mylk7KK

%%
# Drawing
${String.fromCharCode(96,96,96)}json
{
	"type": "excalidraw",
	"version": 2,
	"source": "https://excalidraw.com",
	"elements": [
		{
			"type": "text",
			"version": 1,
			"versionNonce": 423577018,
			"isDeleted": false,
			"id": "4mylk7KK",
			"fillStyle": "hachure",
			"strokeWidth": 1,
			"strokeStyle": "solid",
			"roughness": 1,
			"opacity": 100,
			"angle": 0,
			"x": 0,
			"y": 0,
			"strokeColor": "white",
			"backgroundColor": "transparent",
			"width": 703,
			"height": 96,
			"seed": 4429,
			"groupIds": [],
			"strokeSharpness": "sharp",
			"boundElements": [],
			"updated": 1650784785611,
			"link": null,
			"locked": false,
			"fontSize": 20,
			"fontFamily": 3,
			"text": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'.",
			"rawText": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'.",
			"baseline": 91,
			"textAlign": "center",
			"verticalAlign": "top",
			"containerId": null,
			"originalText": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'."
		}
	],
	"appState": {
		"theme": "dark",
		"viewBackgroundColor": "hsl(208, 80%, 23%)",
		"currentItemStrokeColor": "#000000",
		"currentItemBackgroundColor": "transparent",
		"currentItemFillStyle": "hachure",
		"currentItemStrokeWidth": 2,
		"currentItemStrokeStyle": "solid",
		"currentItemRoughness": 1,
		"currentItemOpacity": 100,
		"currentItemFontFamily": 1,
		"currentItemFontSize": 16,
		"currentItemTextAlign": "left",
		"currentItemStrokeSharpness": "sharp",
		"currentItemStartArrowhead": null,
		"currentItemEndArrowhead": "arrow",
		"currentItemLinearStrokeSharpness": "round",
		"gridSize": null,
		"colorPalette": {}
	},
	"files": {}
}
${String.fromCharCode(96,96,96)}
%%
`,Ee=class{constructor(e){this.nodes=[],this.renderedNodes=[],this.spec=e}layout(e=this.spec.columns){let t=this.nodes.sort((n,r)=>n.title.toLowerCase()<r.title.toLowerCase()?-1:1),i=t.length;if(i===0)return;let a=Math.ceil(i/e);this.renderedNodes=Array(a).fill(null).map((n,r)=>{return r+1<a||i%e==0?Array(e).fill(null).map((d,o)=>t[r*e+o]):(l=i%e,(d=>{let o=[],h=1,p=!0;return d.map(m=>Math.floor(m)).forEach(m=>{for(let y=0;y<m;y++)o.push(p?null:h++);p=!p}),o})(l%2?[(e-l)/2,l,(e-l)/2]:[(e-l)/2,l/2,1,l/2,(e-l)/2])).map(d=>d?t[r*e+d-1]:null);var l})}render(){this.layout();let e=this.renderedNodes.length*this.spec.rowHeight,t=this.spec.top===null&&this.spec.bottom===null?this.spec.origoY-e/2:this.spec.top!==null?this.spec.origoY-e/2<this.spec.top?this.spec.top:this.spec.origoY-e/2:this.spec.origoY+e/2>this.spec.bottom?this.spec.bottom-e:this.spec.origoY-e/2,i=this.spec.origoX-(this.spec.columns===1?0:(this.spec.columns-1)/2*this.spec.columnWidth),a=t;this.renderedNodes.forEach((n,r)=>n.forEach((l,d)=>{l&&(l.setCenter({x:i+d*this.spec.columnWidth,y:a+r*this.spec.rowHeight}),l.render())}))}},st=class{constructor(e){this.plugin=e,this.links=new Map,this.reverseLinks=new Set}addLink(e,t,i,a,n,r,l,d){let o=e.page.path+"|:?:|"+t.page.path;if(this.links.has(o)||this.reverseLinks.has(o))return;let h=t.page.path+"|:?:|"+e.page.path,p=new Qe(r===C.FROM?t:e,r===C.FROM?e:t,r===C.FROM?i===M.FRIEND?M.FRIEND:i===M.CHILD?M.PARENT:M.CHILD:i,a,n,l,d,this.plugin);this.links.set(o,p),this.reverseLinks.add(h)}render(){this.links.forEach(e=>e.render())}},Q=class{constructor(e,t,i,a,n){this.getVal=t,this.button=a.createEl("button",{cls:"excalibrain-button"}),this.button.createSpan({text:n.display}),this.button.ariaLabel=n.tooltip,this.setColor(),this.button.onclick=()=>{var r;i(!t()),e.saveSettings(),this.setColor(),(r=e.scene)===null||r===void 0||r.reRender()}}setColor(){if(this.getVal())return this.button.removeClass("off"),void this.button.addClass("on");this.button.removeClass("on"),this.button.addClass("off")}},W="top",G="bottom",U="right",Y="left",Oe=[W,G,U,Y],xt=Oe.reduce(function(s,e){return s.concat([e+"-start",e+"-end"])},[]),It=[].concat(Oe,["auto"]).reduce(function(s,e){return s.concat([e,e+"-start",e+"-end"])},[]),ei=["beforeRead","read","afterRead","beforeMain","main","afterMain","beforeWrite","write","afterWrite"];function ee(s){return s?(s.nodeName||"").toLowerCase():null}function q(s){if(s==null)return window;if(s.toString()!=="[object Window]"){var e=s.ownerDocument;return e&&e.defaultView||window}return s}function Se(s){return s instanceof q(s).Element||s instanceof Element}function z(s){return s instanceof q(s).HTMLElement||s instanceof HTMLElement}function nt(s){return typeof ShadowRoot!="undefined"&&(s instanceof q(s).ShadowRoot||s instanceof ShadowRoot)}var ti={name:"applyStyles",enabled:!0,phase:"write",fn:function(s){var e=s.state;Object.keys(e.elements).forEach(function(t){var i=e.styles[t]||{},a=e.attributes[t]||{},n=e.elements[t];z(n)&&ee(n)&&(Object.assign(n.style,i),Object.keys(a).forEach(function(r){var l=a[r];l===!1?n.removeAttribute(r):n.setAttribute(r,l===!0?"":l)}))})},effect:function(s){var e=s.state,t={popper:{position:e.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(e.elements.popper.style,t.popper),e.styles=t,e.elements.arrow&&Object.assign(e.elements.arrow.style,t.arrow),function(){Object.keys(e.elements).forEach(function(i){var a=e.elements[i],n=e.attributes[i]||{},r=Object.keys(e.styles.hasOwnProperty(i)?e.styles[i]:t[i]).reduce(function(l,d){return l[d]="",l},{});z(a)&&ee(a)&&(Object.assign(a.style,r),Object.keys(n).forEach(function(l){a.removeAttribute(l)}))})}},requires:["computeStyles"]};function te(s){return s.split("-")[0]}var de=Math.max,He=Math.min,be=Math.round;function ve(s,e){e===void 0&&(e=!1);var t=s.getBoundingClientRect(),i=1,a=1;if(z(s)&&e){var n=s.offsetHeight,r=s.offsetWidth;r>0&&(i=be(t.width)/r||1),n>0&&(a=be(t.height)/n||1)}return{width:t.width/i,height:t.height/a,top:t.top/a,right:t.right/i,bottom:t.bottom/a,left:t.left/i,x:t.left/i,y:t.top/a}}function at(s){var e=ve(s),t=s.offsetWidth,i=s.offsetHeight;return Math.abs(e.width-t)<=1&&(t=e.width),Math.abs(e.height-i)<=1&&(i=e.height),{x:s.offsetLeft,y:s.offsetTop,width:t,height:i}}function Ct(s,e){var t=e.getRootNode&&e.getRootNode();if(s.contains(e))return!0;if(t&&nt(t)){var i=e;do{if(i&&s.isSameNode(i))return!0;i=i.parentNode||i.host}while(i)}return!1}function se(s){return q(s).getComputedStyle(s)}function ii(s){return["table","td","th"].indexOf(ee(s))>=0}function re(s){return((Se(s)?s.ownerDocument:s.document)||window.document).documentElement}function Pe(s){return ee(s)==="html"?s:s.assignedSlot||s.parentNode||(nt(s)?s.host:null)||re(s)}function At(s){return z(s)&&se(s).position!=="fixed"?s.offsetParent:null}function Le(s){for(var e=q(s),t=At(s);t&&ii(t)&&se(t).position==="static";)t=At(t);return t&&(ee(t)==="html"||ee(t)==="body"&&se(t).position==="static")?e:t||function(i){var a=navigator.userAgent.toLowerCase().indexOf("firefox")!==-1;if(navigator.userAgent.indexOf("Trident")!==-1&&z(i)&&se(i).position==="fixed")return null;var n=Pe(i);for(nt(n)&&(n=n.host);z(n)&&["html","body"].indexOf(ee(n))<0;){var r=se(n);if(r.transform!=="none"||r.perspective!=="none"||r.contain==="paint"||["transform","perspective"].indexOf(r.willChange)!==-1||a&&r.willChange==="filter"||a&&r.filter&&r.filter!=="none")return n;n=n.parentNode}return null}(s)||e}function rt(s){return["top","bottom"].indexOf(s)>=0?"x":"y"}function xe(s,e,t){return de(s,He(e,t))}function kt(s){return Object.assign({},{top:0,right:0,bottom:0,left:0},s)}function Ft(s,e){return e.reduce(function(t,i){return t[i]=s,t},{})}var si={name:"arrow",enabled:!0,phase:"main",fn:function(s){var e,t=s.state,i=s.name,a=s.options,n=t.elements.arrow,r=t.modifiersData.popperOffsets,l=te(t.placement),d=rt(l),o=[Y,U].indexOf(l)>=0?"height":"width";if(n&&r){var h=function(E,A){return kt(typeof(E=typeof E=="function"?E(Object.assign({},A.rects,{placement:A.placement})):E)!="number"?E:Ft(E,Oe))}(a.padding,t),p=at(n),m=d==="y"?W:Y,y=d==="y"?G:U,b=t.rects.reference[o]+t.rects.reference[d]-r[d]-t.rects.popper[o],f=r[d]-t.rects.reference[d],v=Le(n),T=v?d==="y"?v.clientHeight||0:v.clientWidth||0:0,L=b/2-f/2,x=h[m],I=T-p[o]-h[y],c=T/2-p[o]/2+L,g=xe(x,c,I),w=d;t.modifiersData[i]=((e={})[w]=g,e.centerOffset=g-c,e)}},effect:function(s){var e=s.state,t=s.options.element,i=t===void 0?"[data-popper-arrow]":t;i!=null&&(typeof i!="string"||(i=e.elements.popper.querySelector(i)))&&Ct(e.elements.popper,i)&&(e.elements.arrow=i)},requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function we(s){return s.split("-")[1]}var ni={top:"auto",right:"auto",bottom:"auto",left:"auto"};function _t(s){var e,t=s.popper,i=s.popperRect,a=s.placement,n=s.variation,r=s.offsets,l=s.position,d=s.gpuAcceleration,o=s.adaptive,h=s.roundOffsets,p=s.isFixed,m=r.x,y=m===void 0?0:m,b=r.y,f=b===void 0?0:b,v=typeof h=="function"?h({x:y,y:f}):{x:y,y:f};y=v.x,f=v.y;var T=r.hasOwnProperty("x"),L=r.hasOwnProperty("y"),x=Y,I=W,c=window;if(o){var g=Le(t),w="clientHeight",E="clientWidth";g===q(t)&&se(g=re(t)).position!=="static"&&l==="absolute"&&(w="scrollHeight",E="scrollWidth"),g=g,(a===W||(a===Y||a===U)&&n==="end")&&(I=G,f-=(p&&g===c&&c.visualViewport?c.visualViewport.height:g[w])-i.height,f*=d?1:-1),a!==Y&&(a!==W&&a!==G||n!=="end")||(x=U,y-=(p&&g===c&&c.visualViewport?c.visualViewport.width:g[E])-i.width,y*=d?1:-1)}var A,N=Object.assign({position:l},o&&ni),D=h===!0?function(_){var R=_.x,j=_.y,V=window.devicePixelRatio||1;return{x:be(R*V)/V||0,y:be(j*V)/V||0}}({x:y,y:f}):{x:y,y:f};return y=D.x,f=D.y,d?Object.assign({},N,((A={})[I]=L?"0":"",A[x]=T?"0":"",A.transform=(c.devicePixelRatio||1)<=1?"translate("+y+"px, "+f+"px)":"translate3d("+y+"px, "+f+"px, 0)",A)):Object.assign({},N,((e={})[I]=L?f+"px":"",e[x]=T?y+"px":"",e.transform="",e))}var Me={passive:!0},ai={left:"right",right:"left",bottom:"top",top:"bottom"};function Ve(s){return s.replace(/left|right|bottom|top/g,function(e){return ai[e]})}var ri={start:"end",end:"start"};function Rt(s){return s.replace(/start|end/g,function(e){return ri[e]})}function ot(s){var e=q(s);return{scrollLeft:e.pageXOffset,scrollTop:e.pageYOffset}}function lt(s){return ve(re(s)).left+ot(s).scrollLeft}function dt(s){var e=se(s),t=e.overflow,i=e.overflowX,a=e.overflowY;return/auto|scroll|overlay|hidden/.test(t+a+i)}function Ht(s){return["html","body","#document"].indexOf(ee(s))>=0?s.ownerDocument.body:z(s)&&dt(s)?s:Ht(Pe(s))}function Ie(s,e){var t;e===void 0&&(e=[]);var i=Ht(s),a=i===((t=s.ownerDocument)==null?void 0:t.body),n=q(i),r=a?[n].concat(n.visualViewport||[],dt(i)?i:[]):i,l=e.concat(r);return a?l:l.concat(Ie(Pe(r)))}function ht(s){return Object.assign({},s,{left:s.x,top:s.y,right:s.x+s.width,bottom:s.y+s.height})}function Pt(s,e){return e==="viewport"?ht(function(t){var i=q(t),a=re(t),n=i.visualViewport,r=a.clientWidth,l=a.clientHeight,d=0,o=0;return n&&(r=n.width,l=n.height,/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(d=n.offsetLeft,o=n.offsetTop)),{width:r,height:l,x:d+lt(t),y:o}}(s)):Se(e)?function(t){var i=ve(t);return i.top=i.top+t.clientTop,i.left=i.left+t.clientLeft,i.bottom=i.top+t.clientHeight,i.right=i.left+t.clientWidth,i.width=t.clientWidth,i.height=t.clientHeight,i.x=i.left,i.y=i.top,i}(e):ht(function(t){var i,a=re(t),n=ot(t),r=(i=t.ownerDocument)==null?void 0:i.body,l=de(a.scrollWidth,a.clientWidth,r?r.scrollWidth:0,r?r.clientWidth:0),d=de(a.scrollHeight,a.clientHeight,r?r.scrollHeight:0,r?r.clientHeight:0),o=-n.scrollLeft+lt(t),h=-n.scrollTop;return se(r||a).direction==="rtl"&&(o+=de(a.clientWidth,r?r.clientWidth:0)-l),{width:l,height:d,x:o,y:h}}(re(s)))}function Mt(s){var e,t=s.reference,i=s.element,a=s.placement,n=a?te(a):null,r=a?we(a):null,l=t.x+t.width/2-i.width/2,d=t.y+t.height/2-i.height/2;switch(n){case W:e={x:l,y:t.y-i.height};break;case G:e={x:l,y:t.y+t.height};break;case U:e={x:t.x+t.width,y:d};break;case Y:e={x:t.x-i.width,y:d};break;default:e={x:t.x,y:t.y}}var o=n?rt(n):null;if(o!=null){var h=o==="y"?"height":"width";switch(r){case"start":e[o]=e[o]-(t[h]/2-i[h]/2);break;case"end":e[o]=e[o]+(t[h]/2-i[h]/2)}}return e}function Ce(s,e){e===void 0&&(e={});var t=e,i=t.placement,a=i===void 0?s.placement:i,n=t.boundary,r=n===void 0?"clippingParents":n,l=t.rootBoundary,d=l===void 0?"viewport":l,o=t.elementContext,h=o===void 0?"popper":o,p=t.altBoundary,m=p!==void 0&&p,y=t.padding,b=y===void 0?0:y,f=kt(typeof b!="number"?b:Ft(b,Oe)),v=h==="popper"?"reference":"popper",T=s.rects.popper,L=s.elements[m?v:h],x=function(D,_,R){var j=_==="clippingParents"?function(k){var ne=Ie(Pe(k)),B=["absolute","fixed"].indexOf(se(k).position)>=0&&z(k)?Le(k):k;return Se(B)?ne.filter(function(P){return Se(P)&&Ct(P,B)&&ee(P)!=="body"}):[]}(D):[].concat(_),V=[].concat(j,[R]),H=V[0],F=V.reduce(function(k,ne){var B=Pt(D,ne);return k.top=de(B.top,k.top),k.right=He(B.right,k.right),k.bottom=He(B.bottom,k.bottom),k.left=de(B.left,k.left),k},Pt(D,H));return F.width=F.right-F.left,F.height=F.bottom-F.top,F.x=F.left,F.y=F.top,F}(Se(L)?L:L.contextElement||re(s.elements.popper),r,d),I=ve(s.elements.reference),c=Mt({reference:I,element:T,strategy:"absolute",placement:a}),g=ht(Object.assign({},T,c)),w=h==="popper"?g:I,E={top:x.top-w.top+f.top,bottom:w.bottom-x.bottom+f.bottom,left:x.left-w.left+f.left,right:w.right-x.right+f.right},A=s.modifiersData.offset;if(h==="popper"&&A){var N=A[a];Object.keys(E).forEach(function(D){var _=[U,G].indexOf(D)>=0?1:-1,R=[W,G].indexOf(D)>=0?"y":"x";E[D]+=N[R]*_})}return E}var oi={name:"flip",enabled:!0,phase:"main",fn:function(s){var e=s.state,t=s.options,i=s.name;if(!e.modifiersData[i]._skip){for(var a=t.mainAxis,n=a===void 0||a,r=t.altAxis,l=r===void 0||r,d=t.fallbackPlacements,o=t.padding,h=t.boundary,p=t.rootBoundary,m=t.altBoundary,y=t.flipVariations,b=y===void 0||y,f=t.allowedAutoPlacements,v=e.options.placement,T=te(v),L=d||(T!==v&&b?function(P){if(te(P)==="auto")return[];var X=Ve(P);return[Rt(P),X,Rt(X)]}(v):[Ve(v)]),x=[v].concat(L).reduce(function(P,X){return P.concat(te(X)==="auto"?function(pe,ae){ae===void 0&&(ae={});var K=ae,Ae=K.placement,ke=K.boundary,ce=K.rootBoundary,Be=K.padding,We=K.flipVariations,ge=K.allowedAutoPlacements,Ye=ge===void 0?It:ge,De=we(Ae),Fe=De?We?xt:xt.filter(function(J){return we(J)===De}):Oe,ue=Fe.filter(function(J){return Ye.indexOf(J)>=0});ue.length===0&&(ue=Fe);var fe=ue.reduce(function(J,oe){return J[oe]=Ce(pe,{placement:oe,boundary:ke,rootBoundary:ce,padding:Be})[te(oe)],J},{});return Object.keys(fe).sort(function(J,oe){return fe[J]-fe[oe]})}(e,{placement:X,boundary:h,rootBoundary:p,padding:o,flipVariations:b,allowedAutoPlacements:f}):X)},[]),I=e.rects.reference,c=e.rects.popper,g=new Map,w=!0,E=x[0],A=0;A<x.length;A++){var N=x[A],D=te(N),_=we(N)==="start",R=[W,G].indexOf(D)>=0,j=R?"width":"height",V=Ce(e,{placement:N,boundary:h,rootBoundary:p,altBoundary:m,padding:o}),H=R?_?U:Y:_?G:W;I[j]>c[j]&&(H=Ve(H));var F=Ve(H),k=[];if(n&&k.push(V[D]<=0),l&&k.push(V[H]<=0,V[F]<=0),k.every(function(P){return P})){E=N,w=!1;break}g.set(N,k)}if(w)for(var ne=function(P){var X=x.find(function(pe){var ae=g.get(pe);if(ae)return ae.slice(0,P).every(function(K){return K})});if(X)return E=X,"break"},B=b?3:1;B>0&&ne(B)!=="break";B--);e.placement!==E&&(e.modifiersData[i]._skip=!0,e.placement=E,e.reset=!0)}},requiresIfExists:["offset"],data:{_skip:!1}};function Vt(s,e,t){return t===void 0&&(t={x:0,y:0}),{top:s.top-e.height-t.y,right:s.right-e.width+t.x,bottom:s.bottom-e.height+t.y,left:s.left-e.width-t.x}}function Bt(s){return[W,U,G,Y].some(function(e){return s[e]>=0})}function li(s,e,t){t===void 0&&(t=!1);var i,a,n=z(e),r=z(e)&&function(p){var m=p.getBoundingClientRect(),y=be(m.width)/p.offsetWidth||1,b=be(m.height)/p.offsetHeight||1;return y!==1||b!==1}(e),l=re(e),d=ve(s,r),o={scrollLeft:0,scrollTop:0},h={x:0,y:0};return(n||!n&&!t)&&((ee(e)!=="body"||dt(l))&&(o=(i=e)!==q(i)&&z(i)?{scrollLeft:(a=i).scrollLeft,scrollTop:a.scrollTop}:ot(i)),z(e)?((h=ve(e,!0)).x+=e.clientLeft,h.y+=e.clientTop):l&&(h.x=lt(l))),{x:d.left+o.scrollLeft-h.x,y:d.top+o.scrollTop-h.y,width:d.width,height:d.height}}function di(s){var e=new Map,t=new Set,i=[];function a(n){t.add(n.name),[].concat(n.requires||[],n.requiresIfExists||[]).forEach(function(r){if(!t.has(r)){var l=e.get(r);l&&a(l)}}),i.push(n)}return s.forEach(function(n){e.set(n.name,n)}),s.forEach(function(n){t.has(n.name)||a(n)}),i}var Wt={placement:"bottom",modifiers:[],strategy:"absolute"};function Yt(){for(var s=arguments.length,e=new Array(s),t=0;t<s;t++)e[t]=arguments[t];return!e.some(function(i){return!(i&&typeof i.getBoundingClientRect=="function")})}var jt,hi=function(s){s===void 0&&(s={});var e=s,t=e.defaultModifiers,i=t===void 0?[]:t,a=e.defaultOptions,n=a===void 0?Wt:a;return function(r,l,d){d===void 0&&(d=n);var o,h,p={placement:"bottom",orderedModifiers:[],options:Object.assign({},Wt,n),modifiersData:{},elements:{reference:r,popper:l},attributes:{},styles:{}},m=[],y=!1,b={state:p,setOptions:function(v){var T=typeof v=="function"?v(p.options):v;f(),p.options=Object.assign({},n,p.options,T),p.scrollParents={reference:Se(r)?Ie(r):r.contextElement?Ie(r.contextElement):[],popper:Ie(l)};var L,x,I=function(c){var g=di(c);return ei.reduce(function(w,E){return w.concat(g.filter(function(A){return A.phase===E}))},[])}((L=[].concat(i,p.options.modifiers),x=L.reduce(function(c,g){var w=c[g.name];return c[g.name]=w?Object.assign({},w,g,{options:Object.assign({},w.options,g.options),data:Object.assign({},w.data,g.data)}):g,c},{}),Object.keys(x).map(function(c){return x[c]})));return p.orderedModifiers=I.filter(function(c){return c.enabled}),p.orderedModifiers.forEach(function(c){var g=c.name,w=c.options,E=w===void 0?{}:w,A=c.effect;if(typeof A=="function"){var N=A({state:p,name:g,instance:b,options:E});m.push(N||function(){})}}),b.update()},forceUpdate:function(){if(!y){var v=p.elements,T=v.reference,L=v.popper;if(Yt(T,L)){p.rects={reference:li(T,Le(L),p.options.strategy==="fixed"),popper:at(L)},p.reset=!1,p.placement=p.options.placement,p.orderedModifiers.forEach(function(A){return p.modifiersData[A.name]=Object.assign({},A.data)});for(var x=0;x<p.orderedModifiers.length;x++)if(p.reset!==!0){var I=p.orderedModifiers[x],c=I.fn,g=I.options,w=g===void 0?{}:g,E=I.name;typeof c=="function"&&(p=c({state:p,options:w,name:E,instance:b})||p)}else p.reset=!1,x=-1}}},update:(o=function(){return new Promise(function(v){b.forceUpdate(),v(p)})},function(){return h||(h=new Promise(function(v){Promise.resolve().then(function(){h=void 0,v(o())})})),h}),destroy:function(){f(),y=!0}};if(!Yt(r,l))return b;function f(){m.forEach(function(v){return v()}),m=[]}return b.setOptions(d).then(function(v){!y&&d.onFirstUpdate&&d.onFirstUpdate(v)}),b}}({defaultModifiers:[{name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect:function(s){var e=s.state,t=s.instance,i=s.options,a=i.scroll,n=a===void 0||a,r=i.resize,l=r===void 0||r,d=q(e.elements.popper),o=[].concat(e.scrollParents.reference,e.scrollParents.popper);return n&&o.forEach(function(h){h.addEventListener("scroll",t.update,Me)}),l&&d.addEventListener("resize",t.update,Me),function(){n&&o.forEach(function(h){h.removeEventListener("scroll",t.update,Me)}),l&&d.removeEventListener("resize",t.update,Me)}},data:{}},{name:"popperOffsets",enabled:!0,phase:"read",fn:function(s){var e=s.state,t=s.name;e.modifiersData[t]=Mt({reference:e.rects.reference,element:e.rects.popper,strategy:"absolute",placement:e.placement})},data:{}},{name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:function(s){var e=s.state,t=s.options,i=t.gpuAcceleration,a=i===void 0||i,n=t.adaptive,r=n===void 0||n,l=t.roundOffsets,d=l===void 0||l,o={placement:te(e.placement),variation:we(e.placement),popper:e.elements.popper,popperRect:e.rects.popper,gpuAcceleration:a,isFixed:e.options.strategy==="fixed"};e.modifiersData.popperOffsets!=null&&(e.styles.popper=Object.assign({},e.styles.popper,_t(Object.assign({},o,{offsets:e.modifiersData.popperOffsets,position:e.options.strategy,adaptive:r,roundOffsets:d})))),e.modifiersData.arrow!=null&&(e.styles.arrow=Object.assign({},e.styles.arrow,_t(Object.assign({},o,{offsets:e.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:d})))),e.attributes.popper=Object.assign({},e.attributes.popper,{"data-popper-placement":e.placement})},data:{}},ti,{name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:function(s){var e=s.state,t=s.options,i=s.name,a=t.offset,n=a===void 0?[0,0]:a,r=It.reduce(function(h,p){return h[p]=function(m,y,b){var f=te(m),v=[Y,W].indexOf(f)>=0?-1:1,T=typeof b=="function"?b(Object.assign({},y,{placement:m})):b,L=T[0],x=T[1];return L=L||0,x=(x||0)*v,[Y,U].indexOf(f)>=0?{x,y:L}:{x:L,y:x}}(p,e.rects,n),h},{}),l=r[e.placement],d=l.x,o=l.y;e.modifiersData.popperOffsets!=null&&(e.modifiersData.popperOffsets.x+=d,e.modifiersData.popperOffsets.y+=o),e.modifiersData[i]=r}},oi,{name:"preventOverflow",enabled:!0,phase:"main",fn:function(s){var e=s.state,t=s.options,i=s.name,a=t.mainAxis,n=a===void 0||a,r=t.altAxis,l=r!==void 0&&r,d=t.boundary,o=t.rootBoundary,h=t.altBoundary,p=t.padding,m=t.tether,y=m===void 0||m,b=t.tetherOffset,f=b===void 0?0:b,v=Ce(e,{boundary:d,rootBoundary:o,padding:p,altBoundary:h}),T=te(e.placement),L=we(e.placement),x=!L,I=rt(T),c=I==="x"?"y":"x",g=e.modifiersData.popperOffsets,w=e.rects.reference,E=e.rects.popper,A=typeof f=="function"?f(Object.assign({},e.rects,{placement:e.placement})):f,N=typeof A=="number"?{mainAxis:A,altAxis:A}:Object.assign({mainAxis:0,altAxis:0},A),D=e.modifiersData.offset?e.modifiersData.offset[e.placement]:null,_={x:0,y:0};if(g){if(n){var R,j=I==="y"?W:Y,V=I==="y"?G:U,H=I==="y"?"height":"width",F=g[I],k=F+v[j],ne=F-v[V],B=y?-E[H]/2:0,P=L==="start"?w[H]:E[H],X=L==="start"?-E[H]:-w[H],pe=e.elements.arrow,ae=y&&pe?at(pe):{width:0,height:0},K=e.modifiersData["arrow#persistent"]?e.modifiersData["arrow#persistent"].padding:{top:0,right:0,bottom:0,left:0},Ae=K[j],ke=K[V],ce=xe(0,w[H],ae[H]),Be=x?w[H]/2-B-ce-Ae-N.mainAxis:P-ce-Ae-N.mainAxis,We=x?-w[H]/2+B+ce+ke+N.mainAxis:X+ce+ke+N.mainAxis,ge=e.elements.arrow&&Le(e.elements.arrow),Ye=ge?I==="y"?ge.clientTop||0:ge.clientLeft||0:0,De=(R=D==null?void 0:D[I])!=null?R:0,Fe=F+We-De,ue=xe(y?He(k,F+Be-De-Ye):k,F,y?de(ne,Fe):ne);g[I]=ue,_[I]=ue-F}if(l){var fe,J=I==="x"?W:Y,oe=I==="x"?G:U,le=g[c],_e=c==="y"?"height":"width",pt=le+v[J],ct=le-v[oe],je=[W,Y].indexOf(T)!==-1,gt=(fe=D==null?void 0:D[c])!=null?fe:0,ut=je?pt:le-w[_e]-E[_e]-gt+N.altAxis,ft=je?le+w[_e]+E[_e]-gt-N.altAxis:ct,mt=y&&je?function($t,qt,Ge){var yt=xe($t,qt,Ge);return yt>Ge?Ge:yt}(ut,le,ft):xe(y?ut:pt,le,y?ft:ct);g[c]=mt,_[c]=mt-le}e.modifiersData[i]=_}},requiresIfExists:["offset"]},si,{name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:function(s){var e=s.state,t=s.name,i=e.rects.reference,a=e.rects.popper,n=e.modifiersData.preventOverflow,r=Ce(e,{elementContext:"reference"}),l=Ce(e,{altBoundary:!0}),d=Vt(r,i),o=Vt(l,a,n),h=Bt(d),p=Bt(o);e.modifiersData[t]={referenceClippingOffsets:d,popperEscapeOffsets:o,isReferenceHidden:h,hasPopperEscaped:p},e.attributes.popper=Object.assign({},e.attributes.popper,{"data-popper-reference-hidden":h,"data-popper-escaped":p})}}]}),Gt=class{constructor(e,t,i,a=30){this.owner=e,this.containerEl=t,this.limit=a,this.owner=e,this.containerEl=t,t.on("click",".suggestion-item",this.onSuggestionClick.bind(this)),t.on("mousemove",".suggestion-item",this.onSuggestionMouseover.bind(this)),i.register([],"ArrowUp",n=>{if(!n.isComposing)return this.setSelectedItem(this.selectedItem-1,!0),!1}),i.register([],"ArrowDown",n=>{if(!n.isComposing)return this.setSelectedItem(this.selectedItem+1,!0),!1}),i.register([],"Enter",n=>{if(!n.isComposing)return this.useSelectedItem(n),!1})}onSuggestionClick(e,t){e.preventDefault();let i=this.suggestions.indexOf(t);this.setSelectedItem(i,!1),this.useSelectedItem(e)}onSuggestionMouseover(e,t){let i=this.suggestions.indexOf(t);this.setSelectedItem(i,!1)}setSuggestions(e){this.containerEl.empty();let t=[];e.slice(0,this.limit).forEach(i=>{let a=this.containerEl.createDiv("suggestion-item");this.owner.renderSuggestion(i,a),t.push(a)}),this.values=e,this.suggestions=t,this.setSelectedItem(0,!1)}useSelectedItem(e){let t=this.values[this.selectedItem];t&&this.owner.selectSuggestion(t,e)}setSelectedItem(e,t){let i=(e%(a=this.suggestions.length)+a)%a;var a;let n=this.suggestions[this.selectedItem],r=this.suggestions[i];n==null||n.removeClass("is-selected"),r==null||r.addClass("is-selected"),this.selectedItem=i,t&&r.scrollIntoView(!1)}};(function(s){s[s.TemplateFiles=0]="TemplateFiles",s[s.ScriptFiles=1]="ScriptFiles"})(jt||(jt={}));var Ut=class extends class{constructor(e,t){this.app=e,this.inputEl=t,this.scope=new O.Scope,this.suggestEl=createDiv("suggestion-container");let i=this.suggestEl.createDiv("suggestion");this.suggest=new Gt(this,i,this.scope),this.scope.register([],"Escape",this.close.bind(this)),this.inputEl.addEventListener("input",this.onInputChanged.bind(this)),this.inputEl.addEventListener("focus",this.onInputChanged.bind(this)),this.inputEl.addEventListener("blur",this.close.bind(this)),this.suggestEl.on("mousedown",".suggestion-container",a=>{a.preventDefault()})}onInputChanged(){let e=this.inputEl.value,t=this.getSuggestions(e);t&&t.length>0?(this.suggest.setSuggestions(t),this.open(this.app.dom.appContainerEl,this.inputEl)):this.close()}open(e,t){this.app.keymap.pushScope(this.scope),e.appendChild(this.suggestEl),this.popper=hi(t,this.suggestEl,{placement:"bottom-start",modifiers:[{name:"sameWidth",enabled:!0,fn:({state:i,instance:a})=>{let n=`${i.rects.reference.width}px`;i.styles.popper.width!==n&&(i.styles.popper.width=n,a.update())},phase:"beforeWrite",requires:["computeStyles"]}]})}close(){this.app.keymap.popScope(this.scope),this.suggest.setSuggestions([]),this.popper&&this.popper.destroy(),this.suggestEl.detach()}}{constructor(e,t,i){super(e,t),this.app=e,this.inputEl=t,this.plugin=i}getSuggestions(e){var t,i;if(e==="")return this.plugin.starred;let a=e.toLowerCase(),n=(t=this.plugin.pages)===null||t===void 0?void 0:t.getPages().filter(l=>!l.isVirtual&&(!l.file||(this.plugin.settings.showAttachments||l.file.extension==="md")&&!this.plugin.settings.excludeFilepaths.some(d=>l.path.startsWith(d)))&&(l.file||(this.plugin.settings.showFolderNodes||!l.path.startsWith("folder:"))&&(this.plugin.settings.showTagNodes||!l.path.startsWith("tag:")))&&l.path.toLowerCase().contains(a));if(n.length>30)return n;let r=O.prepareFuzzySearch(e);return n.concat((i=this.plugin.pages)===null||i===void 0?void 0:i.getPages().filter(l=>!l.isVirtual&&(!l.file||(this.plugin.settings.showAttachments||l.file.extension==="md")&&!this.plugin.settings.excludeFilepaths.some(d=>l.path.startsWith(d)))&&(l.file||(this.plugin.settings.showFolderNodes||!l.path.startsWith("folder:"))&&(this.plugin.settings.showTagNodes||!l.path.startsWith("tag:")))&&!n.contains(l)&&r(l.path)))}renderSuggestion(e,t){t.setText(e.path)}selectSuggestion(e){this.inputEl.value=e.path,this.inputEl.trigger("input"),this.close()}},zt=class{constructor(e,t){this.contentEl=e,this.plugin=t,this.buttons=[],e.addClass("excalibrain-contentEl"),this.wrapperDiv=this.contentEl.createDiv({cls:"excalibrain-toolspanel-wrapper"});let i=this.wrapperDiv.createEl("input",{type:"text",cls:"excalibrain-searchinput"});i.ariaLabel=u("SEARCH_IN_VAULT"),i.oninput=()=>{var r;let l=this.plugin.pages.get(i.value);l&&((r=this.plugin.scene)===null||r===void 0||r.renderGraphForPath(l.path))},i.onblur=()=>{i.value=""},new Ut(this.plugin.app,i,this.plugin);let a=this.wrapperDiv.createDiv({cls:"excalibrain-buttons"}),n=a.createEl("button",{cls:"excalibrain-button",text:"\u270F"});n.ariaLabel=u("OPEN_DRAWING"),n.onclick=()=>{let r=this.plugin.EA.getExcalidrawAPI().getSceneElements(),l=this.plugin.EA.getExcalidrawAPI().getAppState(),d=this.plugin.EA;d.reset(),d.canvas.viewBackgroundColor=l.viewBackgroundColor,d.canvas.theme="light",r.forEach(o=>d.elementsDict[o.id]=o),d.create({filename:`ExcaliBrain Snapshot - ${Jt(this.plugin.scene.centralPagePath).basename}`,onNewPane:!0})},this.buttons.push(new Q(this.plugin,()=>this.plugin.settings.showAttachments,r=>this.plugin.settings.showAttachments=r,a,{display:"\u{1F4CE}",tooltip:u("SHOW_HIDE_ATTACHMENTS")})),this.buttons.push(new Q(this.plugin,()=>this.plugin.settings.showVirtualNodes,r=>this.plugin.settings.showVirtualNodes=r,a,{display:"\u2205",tooltip:u("SHOW_HIDE_VIRTUAL")})),this.buttons.push(new Q(this.plugin,()=>this.plugin.settings.showInferredNodes,r=>this.plugin.settings.showInferredNodes=r,a,{display:"\u{1F914}",tooltip:u("SHOW_HIDE_INFERRED")})),this.buttons.push(new Q(this.plugin,()=>this.plugin.settings.showPageNodes,r=>this.plugin.settings.showPageNodes=r,a,{display:"\u{1F4C4}",tooltip:u("SHOW_HIDE_PAGES")})),this.buttons.push(new Q(this.plugin,()=>this.plugin.settings.showFolderNodes,r=>this.plugin.settings.showFolderNodes=r,a,{display:"\u{1F4C2}",tooltip:u("SHOW_HIDE_FOLDER")})),this.buttons.push(new Q(this.plugin,()=>this.plugin.settings.showTagNodes,r=>this.plugin.settings.showTagNodes=r,a,{display:"#",tooltip:u("SHOW_HIDE_TAG")})),this.buttons.push(new Q(this.plugin,()=>this.plugin.settings.renderAlias,r=>this.plugin.settings.renderAlias=r,a,{display:"\u{1F9E5}",tooltip:u("SHOW_HIDE_ALIAS")})),this.buttons.push(new Q(this.plugin,()=>this.plugin.scene.pinLeaf,r=>this.plugin.scene.pinLeaf=r,a,{display:"\u{1F4CC}",tooltip:u("PIN_LEAF")})),this.buttons.push(new Q(this.plugin,()=>this.plugin.settings.renderSiblings,r=>this.plugin.settings.renderSiblings=r,a,{display:"\u{1F468}\u200D\u{1F469}\u200D\u{1F467}\u200D\u{1F466}",tooltip:u("SHOW_HIDE_SIBLINGS")})),this.contentEl.appendChild(this.wrapperDiv)}rerender(){this.buttons.forEach(e=>e.setColor())}terminate(){var e;if(this.contentEl&&this.contentEl.removeClass("excalibrain-contentEl"),this.wrapperDiv){try{(e=this.contentEl)===null||e===void 0||e.removeChild(this.wrapperDiv)}catch(t){}this.wrapperDiv=null}}},Xt=class{constructor(e,t){this.contentEl=e,this.plugin=t,this.wrapperDiv=this.contentEl.createDiv({cls:"excalibrain-history-wrapper"}),this.rerender(),this.contentEl.appendChild(this.wrapperDiv)}rerender(){this.wrapperDiv.empty();let e=this.wrapperDiv.createDiv({cls:"excalibrain-history-container"}),t=this.plugin.settings.navigationHistory;for(let i=t.length-1;i>=0;i--){i!==t.length-1&&e.createDiv({text:"\u2022",cls:"excalibrain-history-divider"});let a="",n="",r=this.plugin.pages.get(t[i]);if(!r)return;let l=r.path.startsWith("folder:")?this.plugin.settings.folderNodeStyle:r.path.startsWith("tag:")?this.plugin.settings.tagNodeStyle:Object.assign(Object.assign({},this.plugin.settings.baseNodeStyle),Dt(r.dvPage,this.plugin.settings));r.file,a=l.prefix+r.name,n=r.path,e.createDiv({text:a,cls:"excalibrain-history-item"},d=>{d.onclick=()=>{var o;return(o=this.plugin.scene)===null||o===void 0?void 0:o.renderGraphForPath(n)}})}}terminate(){var e;if(this.wrapperDiv){try{(e=this.contentEl)===null||e===void 0||e.removeChild(this.wrapperDiv)}catch(t){}this.wrapperDiv=null}}},he=class{constructor(e,t,i){this.disregardLeafChange=!1,this.nodesMap=new Map,this.layouts=[],this.blockUpdateTimer=!1,this.vaultFileChanged=!1,this.pinLeaf=!1,this.ea=e.EA,this.plugin=e,this.app=e.app,this.leaf=i!=null?i:app.workspace.getLeaf(t),this.terminated=!1,this.links=new st(e)}async initialize(){await this.plugin.loadSettings(),await this.initializeScene(),this.toolsPanel=new zt(this.leaf.view.contentEl,this.plugin),this.historyPanel=new Xt(this.leaf.view.contentEl,this.plugin)}isActive(){var e;return!this.terminated&&app.workspace.getLeafById((e=this.leaf)===null||e===void 0?void 0:e.id)}async reRender(){this.isActive()&&this.centralLeaf&&this.centralPagePath&&(await this.plugin.createIndex(),await this.render(),this.toolsPanel.rerender())}async renderGraphForPath(e){var t;if(!this.isActive())return;this.blockUpdateTimer=!0;let i=this.plugin.pages.get(e);if(!i)return void(this.blockUpdateTimer=!1);let a=!(i.isFolder||i.isTag);if(a&&!i.file)return void(this.blockUpdateTimer=!1);if(!((t=this.ea.targetView)===null||t===void 0?void 0:t.file)||this.ea.targetView.file.path!==this.plugin.settings.excalibrainFilepath)return void this.unloadScene();if(a&&i.file.path===this.ea.targetView.file.path)return void(this.blockUpdateTimer=!1);let n=this.plugin.pages.get(this.centralPagePath);if(n&&n.path===e&&a&&i.file.stat.mtime===n.mtime)return Te("!!!"),void(this.blockUpdateTimer=!1);a?(this.centralLeaf&&app.workspace.getLeafById(this.centralLeaf.id)?this.centralLeaf.openFile(i.file):this.centralLeaf=this.ea.openFileInNewOrAdjacentLeaf(i.file),this.addToHistory(i.file.path)):this.addToHistory(i.path),i.isFolder&&!this.plugin.settings.showFolderNodes&&(this.plugin.settings.showFolderNodes=!0,this.toolsPanel.rerender()),i.isTag&&!this.plugin.settings.showTagNodes&&(this.plugin.settings.showTagNodes=!0,this.toolsPanel.rerender()),this.centralPagePath=e,await this.render()}async addToHistory(e){let t=this.plugin.settings.navigationHistory;if(t.last()===e)return;let i=t.indexOf(e);i>-1&&t.splice(i,1),t.length>50&&t.shift(),t.push(e)}static async openExcalidrawLeaf(e,t,i){let a=0,n=app.vault.getAbstractFileByPath(t.excalibrainFilepath);if(!n||n instanceof O.TFile){if(!n)for(n=await app.vault.create(t.excalibrainFilepath,Lt);n instanceof O.TFile&&!e.isExcalidrawFile(n)&&a++<10;)await sleep(50);a=0,n&&n instanceof O.TFile&&!e.isExcalidrawFile(n)?new me(app,"\u26A0 File Exists",`${n.path} already exists in your Vault. Is it ok to overwrite this file? If not, change ExcaliBrain file path in plugin settings.`).show(async r=>{if(r){for(await app.vault.modify(n,Lt);n instanceof O.TFile&&!e.isExcalidrawFile(n)&&a++<10;)await sleep(50);he.openExcalidrawLeaf(e,t,i)}else new O.Notice("Could not start ExcaliBrain. Please change the ExcaliBrain file path in plugin settings.")}):await(i!=null?i:app.workspace.getLeaf(!0)).openFile(n)}else new O.Notice(`Please check settings. ExcaliBrain path (${t.excalibrainFilepath}) points to a folder, not a file`)}async initializeScene(){this.disregardLeafChange=!1;let e=this.ea,t=this.plugin.settings.baseNodeStyle,i=0;for(e.clear(),e.setView(this.leaf.view),i=0;!e.targetView.excalidrawAPI&&i++<10;)await sleep(50);e.targetView.excalidrawAPI?(this.ea.registerThisAsViewEA(),this.ea.targetView.semaphores.saving=!0,this.ea.targetView.excalidrawAPI.setMobileModeAllowed(!1),e.style.fontFamily=t.fontFamily,e.style.fontSize=t.fontSize,this.textSize=e.measureText("m".repeat(t.maxLabelLength+3)),this.nodeWidth=this.textSize.width+3*t.padding,this.nodeHeight=2*(this.textSize.height+2*t.padding),e.getExcalidrawAPI().updateScene({appState:{viewModeEnabled:!0,activeTool:{lastActiveToolBeforeEraser:null,locked:!1,type:"selection"},theme:"light",viewBackgroundColor:this.plugin.settings.backgroundColor},elements:[]}),e.style.strokeColor=t.textColor,e.addText(0,0,`\u{1F680} To get started
select a document using the search in the top left or
open a document in another pane.

\u2728 For the best experience enable 'Open in adjacent pane'
in Excalidraw settings under 'Links and Transclusion'.

\u26A0 ExcaliBrain may need to wait for DataView to initialize its index.
This can take up to a few minutes after starting Obsidian.`,{textAlign:"center"}),await e.addElementsToView(),e.getExcalidrawAPI().zoomToFit(null,5,.1),e.targetView.linksAlwaysOpenInANewPane=!0,this.addEventHandler(),new O.Notice("ExcaliBrain On")):new O.Notice("Error initializing Excalidraw view")}addNodes(e){e.neighbours.forEach(t=>{if(t.page.path===this.ea.targetView.file.path)return;let i=new ye({page:t.page,isInferred:t.relationType===S.INFERRED,isCentral:e.isCentral,isSibling:e.isSibling,friendGateOnLeft:e.friendGateOnLeft});this.nodesMap.set(t.page.path,i),e.layout.nodes.push(i)})}async render(){var e,t;this.historyPanel&&this.historyPanel.rerender(),this.ea.clear(),this.ea.getExcalidrawAPI().updateScene({elements:[]}),this.ea.style.verticalAlign="middle";let i=this.plugin.pages.get(this.centralPagePath),a=i.getParents().filter(N=>N.page.path!==i.path&&!this.plugin.settings.excludeFilepaths.some(D=>N.page.path.startsWith(D))).slice(0,this.plugin.settings.maxItemCount),n=i.getChildren().filter(N=>N.page.path!==i.path&&!this.plugin.settings.excludeFilepaths.some(D=>N.page.path.startsWith(D))).slice(0,this.plugin.settings.maxItemCount),r=i.getFriends().filter(N=>N.page.path!==i.path&&!this.plugin.settings.excludeFilepaths.some(D=>N.page.path.startsWith(D))).slice(0,this.plugin.settings.maxItemCount),l=i.getSiblings().filter(N=>!(a.some(D=>D.page.path===N.page.path)||n.some(D=>D.page.path===N.page.path)||r.some(D=>D.page.path===N.page.path)||this.plugin.settings.excludeFilepaths.some(D=>N.page.path.startsWith(D)))&&N.page.path!==i.path).slice(0,this.plugin.settings.maxItemCount);this.nodesMap=new Map,this.links=new st(this.plugin),this.layouts=[];let d=n.length>10,o=l.length>10,h=a.length<=1,p=this.plugin.settings.baseNodeStyle,m=new Ee({origoX:0,origoY:0,top:null,bottom:null,columns:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(m);let y=new Ee({origoX:0,origoY:2.5*this.nodeHeight,top:2*this.nodeHeight,bottom:null,columns:d?5:3,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(y);let b=new Ee({origoX:(d?-3:-2)*this.nodeWidth,origoY:0,top:null,bottom:null,columns:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(b);let f=new Ee({origoX:0,origoY:-2.5*this.nodeHeight,top:null,bottom:-2*this.nodeHeight,columns:3,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(f);let v=this.plugin.settings.siblingNodeStyle,T=(e=v.padding)!==null&&e!==void 0?e:p.padding,L=(t=v.maxLabelLength)!==null&&t!==void 0?t:p.maxLabelLength;this.ea.style.fontFamily=v.fontFamily,this.ea.style.fontSize=v.fontSize;let x=this.ea.measureText("m".repeat(L+3)),I=x.width+3*T,c=2*(x.height+2*T),g=new Ee({origoX:1.3*this.nodeWidth*((h?0:1)+(o?2:1)),origoY:-2.5*this.nodeHeight,top:null,bottom:0,columns:o?3:1,columnWidth:I,rowHeight:c});this.layouts.push(g);let w=new ye({page:i,isInferred:!1,isCentral:!0,isSibling:!1,friendGateOnLeft:!0});this.nodesMap.set(i.path,w),m.nodes.push(w),this.addNodes({neighbours:a,layout:f,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.addNodes({neighbours:n,layout:y,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.addNodes({neighbours:r,layout:b,isCentral:!1,isSibling:!1,friendGateOnLeft:!1}),this.plugin.settings.renderSiblings&&this.addNodes({neighbours:l,layout:g,isCentral:!1,isSibling:!0,friendGateOnLeft:!0});let E=(N,D,_)=>{D.forEach(R=>{let j=this.nodesMap.get(R.page.path);j&&this.links.addLink(N,j,_,R.relationType,R.typeDefinition,R.linkDirection,this.ea,this.plugin.settings)})};Array.from(this.nodesMap.values()).forEach(N=>{E(N,N.page.getChildren(),M.CHILD),E(N,N.page.getParents(),M.PARENT),E(N,N.page.getFriends(),M.FRIEND)}),this.layouts.forEach(N=>N.render()),this.links.render();let A=this.ea.getElements();this.ea.getExcalidrawAPI().updateScene({elements:A.filter(N=>N.type==="arrow").concat(A.filter(N=>N.type!=="arrow"))}),this.ea.getExcalidrawAPI().zoomToFit(null,5,.1),this.blockUpdateTimer=!1}isCentralLeafStillThere(){return app.workspace.getLeafById(this.centralLeaf.id)!==null}async addEventHandler(){let e=this,t=async r=>{var l;if(this.disregardLeafChange||(e.blockUpdateTimer=!0,await new Promise(h=>setTimeout(h,100)),this.pinLeaf&&!this.isCentralLeafStillThere()&&(this.pinLeaf=!1,this.toolsPanel.rerender()),this.pinLeaf&&r!==this.centralLeaf))return;if(!((l=e.ea.targetView)===null||l===void 0?void 0:l.file)||e.ea.targetView.file.path!==e.plugin.settings.excalibrainFilepath)return void e.unloadScene();if(!((r==null?void 0:r.view)&&r.view instanceof O.FileView&&r.view.file))return void(e.blockUpdateTimer=!1);let d=r.view.file;if(d.path===e.ea.targetView.file.path)return void(e.blockUpdateTimer=!1);let o=e.plugin.pages.get(e.centralPagePath);o&&o.path===d.path&&d.stat.mtime===o.mtime?e.blockUpdateTimer=!1:(e.plugin.pages.get(d.path)||await e.plugin.createIndex(),this.addToHistory(d.path),e.centralPagePath=d.path,e.centralLeaf=r,e.render())},i=()=>{this.vaultFileChanged=!0};app.workspace.on("active-leaf-change",t),this.removeEH=()=>app.workspace.off("active-leaf-change",t);let a=setInterval(async()=>{this.blockUpdateTimer||this.vaultFileChanged&&(this.vaultFileChanged=!1,await this.plugin.createIndex(),this.render())},5e3);this.removeTimer=()=>clearInterval(a),app.vault.on("rename",i),this.removeOnRename=()=>app.vault.off("rename",i),app.vault.on("modify",i),this.removeOnModify=()=>app.vault.off("modify",i),app.vault.on("create",i),this.removeOnCreate=()=>app.vault.off("create",i),app.vault.on("delete",i),this.removeOnDelete=()=>app.vault.off("delete",i);let n=[];app.workspace.iterateAllLeaves(r=>{r.view instanceof O.FileView&&r.view.file&&r.view.file.path!==this.ea.targetView.file.path&&n.push(r)}),await this.plugin.createIndex(),n.length>0&&t(n[0])}unloadScene(){var e,t;if(this.removeEH&&(this.removeEH(),this.removeEH=void 0),this.removeTimer&&(this.removeTimer(),this.removeTimer=void 0),this.removeOnRename&&(this.removeOnRename(),this.removeOnRename=void 0),this.removeOnModify&&(this.removeOnModify(),this.removeOnModify=void 0),this.removeOnCreate&&(this.removeOnCreate(),this.removeOnCreate=void 0),this.removeOnDelete&&(this.removeOnDelete(),this.removeOnDelete=void 0),this.ea.targetView&&isBoolean(this.ea.targetView.linksAlwaysOpenInANewPane)&&(this.ea.targetView.linksAlwaysOpenInANewPane=!1),this.ea.targetView&&this.ea.targetView.excalidrawAPI)try{this.ea.targetView.semaphores.saving=!1,this.ea.targetView.excalidrawAPI.setMobileModeAllowed(!0),this.ea.targetView.excalidrawAPI.updateScene({appState:{viewModeEnabled:!1}})}catch(i){}if(this.ea.targetView&&this.ea.targetView._loaded)try{this.ea.deregisterThisAsViewEA()}catch(i){}(async()=>{let i=this.plugin.settings.navigationHistory.slice();await this.plugin.loadSettings(),this.plugin.settings.navigationHistory=i,await this.plugin.saveSettings()})(),(e=this.toolsPanel)===null||e===void 0||e.terminate(),this.toolsPanel=void 0,(t=this.historyPanel)===null||t===void 0||t.terminate(),this.historyPanel=void 0,this.ea.targetView=void 0,this.leaf=void 0,this.centralLeaf=void 0,this.centralPagePath=void 0,this.terminated=!0,new O.Notice("Brain Graph Off")}},Kt=class extends O.Plugin{constructor(e,t){super(e,t),this.scene=null,this.pluginLoaded=!1,this.starred=[]}async onload(){await this.loadSettings(),this.addSettingTab(new Tt(this.app,this)),this.app.workspace.onLayoutReady(()=>{this.DVAPI=Qt(),this.DVAPI?(this.EA=vt(),this.EA?this.EA.verifyMinimumPluginVersion("1.6.28")?(this.registerCommands(),this.registerExcalidrawAutomateHooks(),this.pluginLoaded=!0):new me(app,"\u26A0 ExcaliBrain Disabled: Please upgrade Excalidraw and try again",u("EXCALIDRAW_MINAPP_VERSION")).show(async e=>{new O.Notice("Disabling ExcaliBrain Plugin",8e3),Ne({fn:this.onload,where:"main.ts/onload()",message:"ExcaliBrain requires a new version of Excalidraw"}),this.app.plugins.disablePlugin("excalibrain")}):new me(app,"\u26A0 ExcaliBrain Disabled: Excalidraw Plugin not found",u("EXCALIDRAW_NOT_FOUND")).show(async e=>{new O.Notice("Disabling ExcaliBrain Plugin",8e3),Ne({fn:this.onload,where:"main.ts/onload()",message:"Excalidraw not found"}),this.app.plugins.disablePlugin("excalibrain")})):new me(app,"\u26A0 ExcaliBrain Disabled: DataView Plugin not found",u("DATAVIEW_NOT_FOUND")).show(async e=>{new O.Notice("Disabling ExcaliBrain Plugin",8e3),Ne({fn:this.onload,where:"main.ts/onload()",message:"Dataview not found"}),this.app.plugins.disablePlugin("excalibrain")})})}async createIndex(){this.pages=new Ot(this);let e=0;for(;this.app.metadataCache.inProgressTaskCount>0||this.DVAPI.index.importer.reloadQueue.length>0;)e++%100==10&&new O.Notice("ExcaliBrain is waiting for Dataview to update its index",1e3),await sleep(100);let t=(l,d)=>{l.children.forEach(o=>{if(o instanceof O.TFolder){let h=new $("folder:"+o.path,null,this,!0,!1,o.name);return this.pages.add("folder:"+o.path,h),h.addParent(d,S.DEFINED,C.TO,"file-tree"),d.addChild(h,S.DEFINED,C.FROM,"file-tree"),void t(o,h)}{let h=new $(o.path,o,this);this.pages.add(o.path,h),h.addParent(d,S.DEFINED,C.TO,"file-tree"),d.addChild(h,S.DEFINED,C.FROM,"file-tree")}})},i=app.vault.getRoot(),a=new $("folder:/",null,this,!0,!1,"/");this.pages.add("folder:/",a),t(i,a),Object.keys(app.metadataCache.getTags()).map(l=>l.substring(1).split("/")).forEach(l=>{let d=[];l.forEach((o,h,p)=>{let m="tag:"+p.slice(0,h+1).join("/"),y=this.pages.get(m);if(y)d.push(y);else if(y=new $(m,null,this,!1,!0,o),this.pages.add(m,y),d.push(y),h>0){let b=d[h-1];y.addParent(b,S.DEFINED,C.TO,"tag-tree"),b.addChild(y,S.DEFINED,C.FROM,"tag-tree")}})}),this.pages.addUnresolvedLinks(),this.pages.addResolvedLinks(),this.pages.forEach((l,d)=>{(l==null?void 0:l.file)&&this.pages.addDVFieldLinksToPage(l)});let r=this;setTimeout(async()=>{r.starred=(await app.internalPlugins.getPluginById("starred").loadData()).items.filter(l=>l.type==="file").map(l=>l.path).filter(l=>l!==r.settings.excalibrainFilepath&&r.pages.has(l)).map(l=>r.pages.get(l))})}registerCommands(){this.addCommand({id:"excalibrain-start",name:u("COMMAND_START"),callback:()=>{if(this.scene&&!this.scene.terminated)this.scene.unloadScene(),this.scene=null;else{let e=this.getBrainLeaf();if(e&&e.view&&e.view.file&&e.view.file.path==this.settings.excalibrainFilepath)return this.scene=new he(this,!0,e),void this.scene.initialize();he.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,e)}}})}getBrainLeaf(){let e;return app.workspace.iterateAllLeaves(t=>{t.view&&this.EA.isExcalidrawView(t.view)&&t.view.file.path===this.settings.excalibrainFilepath&&(e=t)}),e}registerExcalidrawAutomateHooks(){this.EA.onViewModeChangeHook=e=>{var t;this.EA.targetView&&((t=this.EA.targetView.file)===null||t===void 0?void 0:t.path)===this.settings.excalibrainFilepath&&(e||this.stop())},this.EA.onLinkHoverHook=(e,t)=>{var i;return!(this.scene&&this.EA.targetView&&((i=this.EA.targetView.file)===null||i===void 0?void 0:i.path)===this.settings.excalibrainFilepath&&this.EA.targetView.excalidrawAPI&&this.EA.targetView.excalidrawAPI.getAppState().viewModeEnabled&&(this.scene.disregardLeafChange=!0,this.disregardLeafChangeTimer&&clearTimeout(this.disregardLeafChangeTimer),this.disregardLeafChangeTimer=setTimeout(()=>{this.disregardLeafChangeTimer=null,this.scene&&(this.scene.disregardLeafChange=!1)},1e3),0))},this.EA.onLinkClickHook=(e,t)=>{var i,a,n,r,l,d,o,h;let p=t.match(/\[\[([^\]]*)/)[1];if(!t.startsWith("[[folder:")&&!t.startsWith("[[tag:")){if(((r=(n=(a=(i=this.scene)===null||i===void 0?void 0:i.centralLeaf)===null||a===void 0?void 0:a.view)===null||n===void 0?void 0:n.file)===null||r===void 0?void 0:r.path)===p)return(l=this.scene)===null||l===void 0||l.renderGraphForPath(p),!1;if(((d=this.scene)===null||d===void 0?void 0:d.pinLeaf)&&((o=this.scene)===null||o===void 0?void 0:o.isCentralLeafStillThere())){let m=app.vault.getAbstractFileByPath(p.split("#")[0]);if(m&&m instanceof O.TFile)return this.scene.centralLeaf.openFile(m),this.scene.renderGraphForPath(p),!1}return!0}return(h=this.scene)===null||h===void 0||h.renderGraphForPath(p),!1},this.EA.onViewUnloadHook=e=>{this.scene&&this.scene.leaf===e.leaf&&this.stop()}}onunload(){this.scene&&(this.scene.unloadScene(),this.scene=null)}setHierarchyLinkStylesExtended(){this.hierarchyLinkStylesExtended={},Object.entries(this.settings.hierarchyLinkStyles).forEach(e=>{let t=e[0].toLowerCase().replaceAll(" ","-");this.hierarchyLinkStylesExtended[e[0]]=e[1],e[0]!==t&&(this.hierarchyLinkStylesExtended[t]=e[1])})}async loadSettings(){this.settings=Object.assign({},Zt,await this.loadData()),this.setHierarchyLinkStylesExtended(),this.linkStyles={},this.linkStyles.base={style:this.settings.baseLinkStyle,allowOverride:!1,userStyle:!1,display:u("LINKSTYLE_BASE"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles.inferred={style:this.settings.inferredLinkStyle,allowOverride:!0,userStyle:!1,display:u("LINKSTYLE_INFERRED"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles["file-tree"]={style:this.settings.folderLinkStyle,allowOverride:!0,userStyle:!1,display:u("LINKSTYLE_FOLDER"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles["tag-tree"]={style:this.settings.tagLinkStyle,allowOverride:!0,userStyle:!1,display:u("LINKSTYLE_TAG"),getInheritedStyle:()=>this.settings.baseLinkStyle},Object.entries(this.settings.hierarchyLinkStyles).forEach(e=>{Re.contains(e[0])||(this.linkStyles[e[0]]={style:e[1],allowOverride:!0,userStyle:!0,display:e[0],getInheritedStyle:()=>this.settings.baseLinkStyle})}),this.nodeStyles={},this.nodeStyles.base={style:this.settings.baseNodeStyle,allowOverride:!1,userStyle:!1,display:u("NODESTYLE_BASE"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.inferred={style:this.settings.inferredNodeStyle,allowOverride:!0,userStyle:!1,display:u("NODESTYLE_INFERRED"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.virtual={style:this.settings.virtualNodeStyle,allowOverride:!0,userStyle:!1,display:u("NODESTYLE_VIRTUAL"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.central={style:this.settings.centralNodeStyle,allowOverride:!0,userStyle:!1,display:u("NODESTYLE_CENTRAL"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.sibling={style:this.settings.siblingNodeStyle,allowOverride:!0,userStyle:!1,display:u("NODESTYLE_SIBLING"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.attachment={style:this.settings.attachmentNodeStyle,allowOverride:!0,userStyle:!1,display:u("NODESTYLE_ATTACHMENT"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.folder={style:this.settings.folderNodeStyle,allowOverride:!0,userStyle:!1,display:u("NODESTYLE_FOLDER"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.tag={style:this.settings.tagNodeStyle,allowOverride:!0,userStyle:!1,display:u("NODESTYLE_TAG"),getInheritedStyle:()=>this.settings.baseNodeStyle},Object.entries(this.settings.tagNodeStyles).forEach(e=>{this.nodeStyles[e[0]]={style:e[1],allowOverride:!0,userStyle:!0,display:e[0],getInheritedStyle:()=>this.settings.baseNodeStyle}})}async saveSettings(){await this.saveData(this.settings)}stop(){this.scene&&!this.scene.terminated&&(this.scene.unloadScene(),this.scene=null)}async start(e){if(!e.view)return;let t=0;for(;!this.pluginLoaded&&t++<100;)await sleep(50);if(!this.pluginLoaded)return new O.Notice("ExcaliBrain plugin did not load - aborting start()"),void Ne({where:"ExcaliBrain.start()",fn:this.start,message:"ExcaliBrain did not load. Aborting after 5000ms of trying"});this.stop(),e?(this.scene=new he(this,!0,e),this.scene.initialize()):await he.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,this.getBrainLeaf())}};module.exports=Kt;
