# 网络环境
校园网内网有一台服务器（被控端），校园网封锁了绝大部分端口（22和3389不能用了），外网的一台主机（主控端）要想访问校园网内的这台服务器（如RDP，SSH等等），就需要一台**有公网IP的云服务器**进行内网穿透，一般有两种方式实现内网穿透：
- 端口映射：如FRP
- 异地组网：如Zerotier+Moon
---

# 基于Docker的FRP内网穿透部署

>整个配置笔记参考：
>视频教程：https://www.bilibili.com/video/BV1dr4y147aq?spm_id_from=333.337.search-card.all.click
>相应的文字教程：https://gitee.com/spoto/natserver
## 代理逻辑和优缺点
FRP（fast reverse proxy）是一款非常好用的反向代理工具，通常用来实现内网穿透，它的代理逻辑就是：通过公网服务器的端口去代理被代理的内网主机的端口。
好处就是方便访问，只需要访问“公网IP:预设的端口”即可访问到内网服务器。另外，如果监听服务可以有IP限制的设置，需要允许的访问IP为中转内网设备的内网IP。
缺点就是：-   FRP由于端口会暴露在互联网上，虽然说使用方便但安全性较差；
## 创建轻量应用服务器
1. 租用腾讯云服务器，正好赶上618才45一年，很赚（注意腾讯云的CVM都是：有带宽字样的都是有公网ip的）：
![](https://zjpimage.oss-cn-qingdao.aliyuncs.com/%E6%88%91%E7%9A%84%E8%85%BE%E8%AE%AF%E4%BA%91.png)
2. 然后在控制台点击重装系统（参考上面的up主司波图的B站视频），选择Docker基础镜像Ubuntu20.04-Docker20，等待安装完毕。在控制台点击一键登录即可在浏览器进入服务器的shell
3. 在控制台的防火墙一栏可以实现开关端口

## 服务器端搭建（FRPS）
### 1. 创建配置文件frps.ini
```shell
# 创建存放目录
sudo mkdir /etc/frp
# 创建frps.ini文件
vim /etc/frp/frps.ini
```
配置文件如下：
```ini
# 文件frps.ini：在服务器端配置
[common]
# 监听端口
bind_port = 7000
# 面板端口
dashboard_port = 7500
# 登录面板账号设置
dashboard_user = admin
dashboard_pwd = b216B216
# 身份验证，我用的是b216的md5码，好处是不用记忆
token=f6324dab910e494abe939c31ba9305f9
```
### 2. 创建FRP docker容器
运行下列命令，该容器是HOST模式，所以其所有的端口都映射到了这台公网服务器的端口上面。
```shell
#服务器镜像：snowdreamtech/frps
#重启：always
#网络模式：host
#文件映射：/etc/frp/frps.ini:/etc/frp/frps.ini
docker run --restart=always --network host -d -v /etc/frp/frps.ini:/etc/frp/frps.ini --name frps snowdreamtech/frps
```
### 3. 打开FRP服务端口
在防火墙打开7000，7500的TCP协议端口（添加规则的时候可以通过逗号把多个端口用这一条规则打开，如：7000,7500）然后就可以通过frps.ini中设置好的账号和密码登录FRP控制台面板（我这就是http://101.42.156.117:7500/，101.42.156.117就是我这台服务器的公网ip）

## 中转客户端配置（FRPC）
### Windows
#### 1. 修改配置文件frpc.ini
我的window被控机上下载FRP：https://github.com/fatedier/frp，解压然后只需要更改frpc.ini文件
```ini
# 文件frpc.ini：在客户端（被控端）配置
[common]
server_addr = 101.42.156.117
server_port = 7000
token=f6324dab910e494abe939c31ba9305f9

# RDP 的配置信息
[RDP_TCP]
type = tcp
local_ip = 127.0.0.1
local_port = 3389
remote_port = 19980

# 启动 UDP 获得更好的远程桌面体验
[RDP_UDP]
type = udp
local_ip = 127.0.0.1
local_port = 3389
remote_port = 19980
```

#### 2. windows frpc服务自启动
在本地frp的目录下新建一个文件startfrp.bat
```powershell
@echo off
:startfrp
frpc -c frpc.ini
goto startfrp
```
然后配置windows10自带的“任务计划程序”，参考下列网站，注意创建任务时配置一栏选择“windows10”，最终的配置如下：
![](https://zjpimage.oss-cn-qingdao.aliyuncs.com/%E5%88%A9%E7%94%A8%E4%BB%BB%E5%8A%A1%E8%AE%A1%E5%88%92%E7%A8%8B%E5%BA%8F%E5%AE%9E%E7%8E%B0startfrp%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8.png)

>参考:https://tufei.site/archives/45/

#### 3. 打开FRPC的映射端口
19980是我选择的公网服务器的映射端口，也就是说我访问“公网IP:19980”就相当于访问到了我被控机的3389端口，就可以实现RDP远程桌面连接了。所以需要分别开启服务器的19980的TCP**和UDP**协议端口。
>参考：
>https://yunchaozheng.github.io/2022/02/20/rdp-with-frp/
>https://zhuanlan.zhihu.com/p/265171894

这是因为参考了上述文章得知，frp要同时转发远程桌面的 TCP 和 UDP 端口（启动 UDP 以获得更好的远程桌面体验）。~~但是很奇怪就算这样RDP连接的时候好像也还只是TCP，以后有机会再说吧先不管了。~~之前UDP没好使的原因是我糊涂了，忘记了开启云服务器的19980的UDP端口，只开了19980的TCP，怪不得UDP穿不过去。
配置RDP成功远程控制，最终实现了RDP的TCP和UDP同时转发，yeah!

![](https://zjpimage.oss-cn-qingdao.aliyuncs.com/RDP%E9%85%8D%E7%BD%AE.png)

判断远程桌面是否使用了 UDP 的方法如下：将远程桌面全屏，鼠标移动到最上方，会自动显示出远程桌面的连接栏，单击箭头所指向的位置即可。

![](https://zjpimage.oss-cn-qingdao.aliyuncs.com/%E5%88%A4%E6%96%ADRDP%E6%98%AF%E5%90%A6%E4%BD%BF%E7%94%A8%E4%BA%86UDP.png)

下面是启用了UDP的样子

![](https://zjpimage.oss-cn-qingdao.aliyuncs.com/RDP%E7%9A%84TCP%E5%92%8CUDP%E5%90%8C%E6%97%B6%E9%80%9A%E8%BF%87FRP%E8%BD%AC%E5%8F%91.png)

而这是没有启用的样子：

![](https://zjpimage.oss-cn-qingdao.aliyuncs.com/RDP%E4%BB%85%E5%90%AF%E7%94%A8TCP.png)

#### 4. 更改RDP端口（可选）
微软RDP的默认端口是3389，极易被攻击，可以将TCP端口3389改成19980等其他端口。然而下面教程里只介绍了RDP的TCP协议端口怎么改，导致我在配置RDP时给UDP也写成了19980（其实是3389并没有改成19980），所以RDP连接的时候就只采用了TCP所以就很卡，综上所述，**要么TCP和UDP一起都改成同一个别的端口，要么就不改**，我比较懒就没改。

>参考教程：https://blog.csdn.net/zifengzwz/article/details/107132318

教程里提到的注册表路径如下（为了方便复制）：
```
计算机\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\Wds\rdpwd\Tds\tcp
计算机\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp
计算机\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SharedAccess\Defaults\FirewallPolicy\FirewallRules
计算机\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\FirewallRules
```

### Linux
在Ubuntu上就非常简单了，我用这个服务器也代理了我实验室的3090
#### 1. 创建配置文件目录和配置文件
在frp的项目文件夹下创建文件夹zjpfrp（方便管理），然后在zjpfrp下新建文件zjp.ini，如下：
```ini
# zjp.ini
[common]
server_addr = 公网IP
server_port = 7000
token=f6324dab910e494abe939c31ba9305f9

[zjpssh]
type = tcp
local_ip = 127.0.0.1
local_port = 22
remote_port = 随便设置一个端口

# 多端口批量绑定，必须加range:关键词
[range:NsightCompute]
type = tcp
local_ip = 127.0.0.1
local_port = 49152-49215
remote_port = 49152-49215
```
#### 2. 给配置文件目录赋权
```shell
# 在zjpfrp目录下：
sudo touch out.txt
sudo chmod 777 .
sudo chmod 777 out.txt
sudo chmod 777 zjp.ini
```
#### 3. 后台执行frpc
然后运行nohup实现后台执行frpc
```shell
# 在zjpfrp目录下
sudo nohup ../frpc -c zjp.ini > out.txt 2>&1 &
```
这里**2>&1** 解释：
将标准错误 2 重定向到标准输出 &1 ，标准输出 &1 再被重定向输入到 out.txt 文件中。
-   0 – stdin (standard input，标准输入)
-   1 – stdout (standard output，标准输出)
-   2 – stderr (standard error，标准错误输出)

#### 4. Kill frpc进程（可选）
如果想停止的话，就kill这个后台执行的frpc进程：
```shell
# 搜索当前运行frpc服务的进程号
sudo ps aux | grep frpc
# 得到运行frpc进程的pid后
sudo kill -9 frpc进程的pid
```

说点其他的，在配置Nsight Compute Remote的时候，连接session一直报

---

# 基于Zerotier根服务器的内网穿透部署
>整个配置笔记参考的教程同样还是：
视频教程：https://www.bilibili.com/video/BV1dr4y147aq?spm_id_from=333.337.search-card.all.click
相应的文字教程：https://gitee.com/spoto/natserver
## 组网逻辑和优缺点
![](https://zjpimage.oss-cn-qingdao.aliyuncs.com/zerotier%E5%8A%A0moon%E7%9A%84%E7%BB%84%E7%BD%91%E9%80%BB%E8%BE%91%E5%92%8C%E4%BC%98%E7%BC%BA%E7%82%B9.png)

## 1. 创建伪根服务器的容器
项目地址：[https://github.com/Jonnyan404/zerotier-planet](https://gitee.com/link?target=https%3A%2F%2Fgithub.com%2FJonnyan404%2Fzerotier-planet)
执行下列命令：
```shell
docker run --restart=on-failure:3 -d --name ztncui -e HTTP_PORT=4000 -e HTTP_ALL_INTERFACES=yes -e ZTNCUI_PASSWD=mrdoc.fun -p 4000:4000 keynetworks/ztncui
```

## 2. 配置Zerotier控制台
在步骤1中的4000端口（TCP协议）用作Zerotier的控制台，需要在服务器防火墙打开。然后“公网IP:4000”即可访问控制台，用默认用户名admin和密码mrdoc.fun登录，第一次登录成功后会让你改密码。
然后点击Create network，起个名，记录生成的局域网id，设置内网网段地址（为了好记我选择了10.11.12.0/24），然后submit

## 3. 创建 moon 服务器的容器
项目地址：[https://github.com/jonnyan404/docker-zerotier-moon](https://gitee.com/link?target=https%3A%2F%2Fgithub.com%2Fjonnyan404%2Fdocker-zerotier-moon)
执行下列命令：
```shell
# 创建容器
docker run --name zerotier-moon -d -p 9993:9993 -p 9993:9993/udp -v /etc/ztconf/:/var/lib/zerotier-one jonnyan404/zerotier-moon -4 [公网ip]
# 查看moon服务器ID
docker logs zerotier-moon
```
需要开启服务器的9993（TCP和UDP协议）端口

## 4. Windows客户端加入虚拟局域网
由于我两端的电脑都是windows，所以它俩都按照步骤4和5这样配置。
下载安装zerotier（注意1.8.10版本是带有panel的，往后更新的就不带界面了，我以为是我安装得不完全所以在这还卡了挺久hhh）
打开zerotier，填写局域网id然后添加网络，这时候会给你的电脑添加一块虚拟网卡，用来加入这个虚拟局域网。
在Zerotier控制台刷新一下，然后授权刚才的这个客户端（点击Authorized）并起个名字，然后为了方便记忆，更改给这台客户端分配的局域网ip（比如10.11.12.13等）。

另外也可以通过复制云服务器生成的moon.d文件夹到`C:\Program Files (x86)\ZeroTier\One`来实现，这里就不介绍了。
>可以参考：https://post.smzdm.com/p/a5d2z6v7/
## 5. Windows客户端加入moon服务器
进入windows命令行，输入：
```powershell
cd C:\ProgramData\ZeroTier\One
# 加入moon服务器
# moon_id就替换成我们在第3步得到的moon服务器ID。
zerotier-cli orbit [moon_id] [moon_id]
# 查看是否加入moon成功
zerotier-cli listpeers
```
如果`zerotier-cli listpeers`回显中带有moon的一行前面不带杠而是我的公网服务器IP时，就成功了。这也就意味着如果zerotier无法建立p2p直连的时候（也就是说打洞失败了）就通过moon服务器中转。
主控和被控机都这样配置，然后在Zerotier控制台的Peer Status会看到两个绿色的ONLINE，这时候就可以进行RDP连接了，感兴趣也可以考虑在Parsec（另外一个远程软件）无法直连的情况下通过中转服务器建立远程连接（这里就不介绍了），整个配置到此结束。
![](https://zjpimage.oss-cn-qingdao.aliyuncs.com/zerotier%20moon%20peer%20status.png)

## 注意第一次加入moon服务器时不能是在手机热点网络下！
挺有意思的一点是，最初将该zerotier客户端加入moon主机的时候，只能在连接有/无线网络的情况下，用手机热点会导致控制端Peer Status报红OFFLINE，但是不是初次的往后用手机热点也没问题（报绿ONLINE），因为第一次已经建立了链路。
所以需要注意的是：电脑端第一次配置加入moon的时候，电脑连接手机热点的情况会导致加入不了moon服务器（在zerotier的控制台的Peer Status会显示红色的OFFLINE）
